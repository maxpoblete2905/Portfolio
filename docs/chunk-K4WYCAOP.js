import{j as Nl,k as kl,l as Vt,m as Fl,n as Ml,o as Ol,q as Ll,r as ql,s as Bl,t as Ul,u as Gl,v as jl,w as zl,x as Kl,y as Pi}from"./chunk-G336QBJN.js";import{c as Pl,d as dr,e as Co,f as Cl,g as bl,i as bo,j as Y,k as Ri,l as zt,m as xl,n as Vl,o as Dl,q as xo,r as Vo}from"./chunk-EE22SPCH.js";import{A as pe,F as El,K as Ti,L as Ai,Ma as Sl,N as Si,O as Po,R as Tl,V as _n,Y as hr,Zb as Rl,_ as H,c as wl,g as vl,h as Il,m as xt,n as pn,r as _t,z as Ro,za as Al}from"./chunk-OV4SEJUD.js";import{a as gn,b as lr,e as So,f as p}from"./chunk-CQCHLVVT.js";var ew=(()=>{let t=class t{constructor(r){this.afAuth=r,this.userDataSubject=new vl(null)}signIn(r,i){return xt(this.afAuth.signInWithEmailAndPassword(r,i)).pipe(_t(s=>{let o=s.user;if(o){let a={email:o.email,displayName:o.displayName,uid:o.uid};return this.userDataSubject.next(a),!0}return!1}),pe(s=>(console.error("Error in signIn:",s),this.userDataSubject.next(null),[!1])))}signOut(){return xt(this.afAuth.signOut()).pipe(Tl(()=>{this.userDataSubject.next(null)}),_t(()=>!0),pe(r=>{throw console.error("Error in signOut:",r),r}))}getUserData(){return this.userDataSubject}};t.\u0275fac=function(i){return new(i||t)(H(Pi))},t.\u0275prov=_n({token:t,factory:t.\u0275fac,providedIn:"root"});let n=t;return n})();var Wg=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Lt={},T,Zo=Zo||{},x=Wg||self;function Ui(n){var t=typeof n;return t=t!="object"?t:n?Array.isArray(n)?"array":t:"null",t=="array"||t=="object"&&typeof n.length=="number"}function Rr(n){var t=typeof n;return t=="object"&&n!=null||t=="function"}function Hg(n){return Object.prototype.hasOwnProperty.call(n,Do)&&n[Do]||(n[Do]=++Yg)}var Do="closure_uid_"+(1e9*Math.random()>>>0),Yg=0;function Jg(n,t,e){return n.call.apply(n.bind,arguments)}function Xg(n,t,e){if(!n)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var i=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(i,r),n.apply(t,i)}}return function(){return n.apply(t,arguments)}}function yt(n,t,e){return Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?yt=Jg:yt=Xg,yt.apply(null,arguments)}function Ci(n,t){var e=Array.prototype.slice.call(arguments,1);return function(){var r=e.slice();return r.push.apply(r,arguments),n.apply(this,r)}}function ht(n,t){function e(){}e.prototype=t.prototype,n.$=t.prototype,n.prototype=new e,n.prototype.constructor=n,n.ac=function(r,i,s){for(var o=Array(arguments.length-2),a=2;a<arguments.length;a++)o[a-2]=arguments[a];return t.prototype[i].apply(r,o)}}function _e(){this.s=this.s,this.o=this.o}var Zg=0;_e.prototype.s=!1;_e.prototype.sa=function(){!this.s&&(this.s=!0,this.N(),Zg!=0)&&Hg(this)};_e.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};var sh=Array.prototype.indexOf?function(n,t){return Array.prototype.indexOf.call(n,t,void 0)}:function(n,t){if(typeof n=="string")return typeof t!="string"||t.length!=1?-1:n.indexOf(t,0);for(let e=0;e<n.length;e++)if(e in n&&n[e]===t)return e;return-1};function ta(n){let t=n.length;if(0<t){let e=Array(t);for(let r=0;r<t;r++)e[r]=n[r];return e}return[]}function Ql(n,t){for(let e=1;e<arguments.length;e++){let r=arguments[e];if(Ui(r)){let i=n.length||0,s=r.length||0;n.length=i+s;for(let o=0;o<s;o++)n[i+o]=r[o]}else n.push(r)}}function wt(n,t){this.type=n,this.g=this.target=t,this.defaultPrevented=!1}wt.prototype.h=function(){this.defaultPrevented=!0};var tp=function(){if(!x.addEventListener||!Object.defineProperty)return!1;var n=!1,t=Object.defineProperty({},"passive",{get:function(){n=!0}});try{let e=()=>{};x.addEventListener("test",e,t),x.removeEventListener("test",e,t)}catch{}return n}();function yr(n){return/^[\s\xa0]*$/.test(n)}function Gi(){var n=x.navigator;return n&&(n=n.userAgent)?n:""}function Kt(n){return Gi().indexOf(n)!=-1}function ea(n){return ea[" "](n),n}ea[" "]=function(){};function ep(n,t){var e=jp;return Object.prototype.hasOwnProperty.call(e,n)?e[n]:e[n]=t(n)}var np=Kt("Opera"),In=Kt("Trident")||Kt("MSIE"),oh=Kt("Edge"),Oo=oh||In,ah=Kt("Gecko")&&!(Gi().toLowerCase().indexOf("webkit")!=-1&&!Kt("Edge"))&&!(Kt("Trident")||Kt("MSIE"))&&!Kt("Edge"),rp=Gi().toLowerCase().indexOf("webkit")!=-1&&!Kt("Edge");function uh(){var n=x.document;return n?n.documentMode:void 0}var Lo;t:{if(bi="",xi=function(){var n=Gi();if(ah)return/rv:([^\);]+)(\)|;)/.exec(n);if(oh)return/Edge\/([\d\.]+)/.exec(n);if(In)return/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(n);if(rp)return/WebKit\/(\S+)/.exec(n);if(np)return/(?:Version)[ \/]?(\S+)/.exec(n)}(),xi&&(bi=xi?xi[1]:""),In&&(Vi=uh(),Vi!=null&&Vi>parseFloat(bi))){Lo=String(Vi);break t}Lo=bi}var bi,xi,Vi,qo;x.document&&In?(No=uh(),qo=No||parseInt(Lo,10)||void 0):qo=void 0;var No,ip=qo;function wr(n,t){if(wt.call(this,n?n.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,n){var e=this.type=n.type,r=n.changedTouches&&n.changedTouches.length?n.changedTouches[0]:null;if(this.target=n.target||n.srcElement,this.g=t,t=n.relatedTarget){if(ah){t:{try{ea(t.nodeName);var i=!0;break t}catch{}i=!1}i||(t=null)}}else e=="mouseover"?t=n.fromElement:e=="mouseout"&&(t=n.toElement);this.relatedTarget=t,r?(this.clientX=r.clientX!==void 0?r.clientX:r.pageX,this.clientY=r.clientY!==void 0?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=n.clientX!==void 0?n.clientX:n.pageX,this.clientY=n.clientY!==void 0?n.clientY:n.pageY,this.screenX=n.screenX||0,this.screenY=n.screenY||0),this.button=n.button,this.key=n.key||"",this.ctrlKey=n.ctrlKey,this.altKey=n.altKey,this.shiftKey=n.shiftKey,this.metaKey=n.metaKey,this.pointerId=n.pointerId||0,this.pointerType=typeof n.pointerType=="string"?n.pointerType:sp[n.pointerType]||"",this.state=n.state,this.i=n,n.defaultPrevented&&wr.$.h.call(this)}}ht(wr,wt);var sp={2:"touch",3:"pen",4:"mouse"};wr.prototype.h=function(){wr.$.h.call(this);var n=this.i;n.preventDefault?n.preventDefault():n.returnValue=!1};var Pr="closure_listenable_"+(1e6*Math.random()|0),op=0;function ap(n,t,e,r,i){this.listener=n,this.proxy=null,this.src=t,this.type=e,this.capture=!!r,this.la=i,this.key=++op,this.fa=this.ia=!1}function ji(n){n.fa=!0,n.listener=null,n.proxy=null,n.src=null,n.la=null}function na(n,t,e){for(let r in n)t.call(e,n[r],r,n)}function up(n,t){for(let e in n)t.call(void 0,n[e],e,n)}function ch(n){let t={};for(let e in n)t[e]=n[e];return t}var Wl="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function lh(n,t){let e,r;for(let i=1;i<arguments.length;i++){r=arguments[i];for(e in r)n[e]=r[e];for(let s=0;s<Wl.length;s++)e=Wl[s],Object.prototype.hasOwnProperty.call(r,e)&&(n[e]=r[e])}}function zi(n){this.src=n,this.g={},this.h=0}zi.prototype.add=function(n,t,e,r,i){var s=n.toString();n=this.g[s],n||(n=this.g[s]=[],this.h++);var o=Uo(n,t,r,i);return-1<o?(t=n[o],e||(t.ia=!1)):(t=new ap(t,this.src,s,!!r,i),t.ia=e,n.push(t)),t};function Bo(n,t){var e=t.type;if(e in n.g){var r=n.g[e],i=sh(r,t),s;(s=0<=i)&&Array.prototype.splice.call(r,i,1),s&&(ji(t),n.g[e].length==0&&(delete n.g[e],n.h--))}}function Uo(n,t,e,r){for(var i=0;i<n.length;++i){var s=n[i];if(!s.fa&&s.listener==t&&s.capture==!!e&&s.la==r)return i}return-1}var ra="closure_lm_"+(1e6*Math.random()|0),ko={};function hh(n,t,e,r,i){if(r&&r.once)return fh(n,t,e,r,i);if(Array.isArray(t)){for(var s=0;s<t.length;s++)hh(n,t[s],e,r,i);return null}return e=oa(e),n&&n[Pr]?n.O(t,e,Rr(r)?!!r.capture:!!r,i):dh(n,t,e,!1,r,i)}function dh(n,t,e,r,i,s){if(!t)throw Error("Invalid event type");var o=Rr(i)?!!i.capture:!!i,a=sa(n);if(a||(n[ra]=a=new zi(n)),e=a.add(t,e,r,o,s),e.proxy)return e;if(r=cp(),e.proxy=r,r.src=n,r.listener=e,n.addEventListener)tp||(i=o),i===void 0&&(i=!1),n.addEventListener(t.toString(),r,i);else if(n.attachEvent)n.attachEvent(gh(t.toString()),r);else if(n.addListener&&n.removeListener)n.addListener(r);else throw Error("addEventListener and attachEvent are unavailable.");return e}function cp(){function n(e){return t.call(n.src,n.listener,e)}let t=lp;return n}function fh(n,t,e,r,i){if(Array.isArray(t)){for(var s=0;s<t.length;s++)fh(n,t[s],e,r,i);return null}return e=oa(e),n&&n[Pr]?n.P(t,e,Rr(r)?!!r.capture:!!r,i):dh(n,t,e,!0,r,i)}function mh(n,t,e,r,i){if(Array.isArray(t))for(var s=0;s<t.length;s++)mh(n,t[s],e,r,i);else r=Rr(r)?!!r.capture:!!r,e=oa(e),n&&n[Pr]?(n=n.i,t=String(t).toString(),t in n.g&&(s=n.g[t],e=Uo(s,e,r,i),-1<e&&(ji(s[e]),Array.prototype.splice.call(s,e,1),s.length==0&&(delete n.g[t],n.h--)))):n&&(n=sa(n))&&(t=n.g[t.toString()],n=-1,t&&(n=Uo(t,e,r,i)),(e=-1<n?t[n]:null)&&ia(e))}function ia(n){if(typeof n!="number"&&n&&!n.fa){var t=n.src;if(t&&t[Pr])Bo(t.i,n);else{var e=n.type,r=n.proxy;t.removeEventListener?t.removeEventListener(e,r,n.capture):t.detachEvent?t.detachEvent(gh(e),r):t.addListener&&t.removeListener&&t.removeListener(r),(e=sa(t))?(Bo(e,n),e.h==0&&(e.src=null,t[ra]=null)):ji(n)}}}function gh(n){return n in ko?ko[n]:ko[n]="on"+n}function lp(n,t){if(n.fa)n=!0;else{t=new wr(t,this);var e=n.listener,r=n.la||n.src;n.ia&&ia(n),n=e.call(r,t)}return n}function sa(n){return n=n[ra],n instanceof zi?n:null}var Fo="__closure_events_fn_"+(1e9*Math.random()>>>0);function oa(n){return typeof n=="function"?n:(n[Fo]||(n[Fo]=function(t){return n.handleEvent(t)}),n[Fo])}function lt(){_e.call(this),this.i=new zi(this),this.S=this,this.J=null}ht(lt,_e);lt.prototype[Pr]=!0;lt.prototype.removeEventListener=function(n,t,e,r){mh(this,n,t,e,r)};function gt(n,t){var e,r=n.J;if(r)for(e=[];r;r=r.J)e.push(r);if(n=n.S,r=t.type||t,typeof t=="string")t=new wt(t,n);else if(t instanceof wt)t.target=t.target||n;else{var i=t;t=new wt(r,n),lh(t,i)}if(i=!0,e)for(var s=e.length-1;0<=s;s--){var o=t.g=e[s];i=Di(o,r,!0,t)&&i}if(o=t.g=n,i=Di(o,r,!0,t)&&i,i=Di(o,r,!1,t)&&i,e)for(s=0;s<e.length;s++)o=t.g=e[s],i=Di(o,r,!1,t)&&i}lt.prototype.N=function(){if(lt.$.N.call(this),this.i){var n=this.i,t;for(t in n.g){for(var e=n.g[t],r=0;r<e.length;r++)ji(e[r]);delete n.g[t],n.h--}}this.J=null};lt.prototype.O=function(n,t,e,r){return this.i.add(String(n),t,!1,e,r)};lt.prototype.P=function(n,t,e,r){return this.i.add(String(n),t,!0,e,r)};function Di(n,t,e,r){if(t=n.i.g[String(t)],!t)return!0;t=t.concat();for(var i=!0,s=0;s<t.length;++s){var o=t[s];if(o&&!o.fa&&o.capture==e){var a=o.listener,u=o.la||o.src;o.ia&&Bo(n.i,o),i=a.call(u,r)!==!1&&i}}return i&&!r.defaultPrevented}var aa=x.JSON.stringify,Go=class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}};function hp(){var n=ua;let t=null;return n.g&&(t=n.g,n.g=n.g.next,n.g||(n.h=null),t.next=null),t}var jo=class{constructor(){this.h=this.g=null}add(t,e){let r=ph.get();r.set(t,e),this.h?this.h.next=r:this.g=r,this.h=r}},ph=new Go(()=>new zo,n=>n.reset()),zo=class{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}};function dp(n){var t=1;n=n.split(":");let e=[];for(;0<t&&n.length;)e.push(n.shift()),t--;return n.length&&e.push(n.join(":")),e}function fp(n){x.setTimeout(()=>{throw n},0)}var vr,Ir=!1,ua=new jo,_h=()=>{let n=x.Promise.resolve(void 0);vr=()=>{n.then(mp)}},mp=()=>{for(var n;n=hp();){try{n.h.call(n.g)}catch(e){fp(e)}var t=ph;t.j(n),100>t.h&&(t.h++,n.next=t.g,t.g=n)}Ir=!1};function Ki(n,t){lt.call(this),this.h=n||1,this.g=t||x,this.j=yt(this.qb,this),this.l=Date.now()}ht(Ki,lt);T=Ki.prototype;T.ga=!1;T.T=null;T.qb=function(){if(this.ga){var n=Date.now()-this.l;0<n&&n<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-n):(this.T&&(this.g.clearTimeout(this.T),this.T=null),gt(this,"tick"),this.ga&&(ca(this),this.start()))}};T.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())};function ca(n){n.ga=!1,n.T&&(n.g.clearTimeout(n.T),n.T=null)}T.N=function(){Ki.$.N.call(this),ca(this),delete this.g};function la(n,t,e){if(typeof n=="function")e&&(n=yt(n,e));else if(n&&typeof n.handleEvent=="function")n=yt(n.handleEvent,n);else throw Error("Invalid listener argument");return 2147483647<Number(t)?-1:x.setTimeout(n,t||0)}function yh(n){n.g=la(()=>{n.g=null,n.i&&(n.i=!1,yh(n))},n.j);let t=n.h;n.h=null,n.m.apply(null,t)}var Ko=class extends _e{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:yh(this)}N(){super.N(),this.g&&(x.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}};function Er(n){_e.call(this),this.h=n,this.g={}}ht(Er,_e);var Hl=[];function wh(n,t,e,r){Array.isArray(e)||(e&&(Hl[0]=e.toString()),e=Hl);for(var i=0;i<e.length;i++){var s=hh(t,e[i],r||n.handleEvent,!1,n.h||n);if(!s)break;n.g[s.key]=s}}function vh(n){na(n.g,function(t,e){this.g.hasOwnProperty(e)&&ia(t)},n),n.g={}}Er.prototype.N=function(){Er.$.N.call(this),vh(this)};Er.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};function $i(){this.g=!0}$i.prototype.Ea=function(){this.g=!1};function gp(n,t,e,r,i,s){n.info(function(){if(n.g)if(s)for(var o="",a=s.split("&"),u=0;u<a.length;u++){var c=a[u].split("=");if(1<c.length){var l=c[0];c=c[1];var h=l.split("_");o=2<=h.length&&h[1]=="type"?o+(l+"="+c+"&"):o+(l+"=redacted&")}}else o=null;else o=s;return"XMLHTTP REQ ("+r+") [attempt "+i+"]: "+t+`
`+e+`
`+o})}function pp(n,t,e,r,i,s,o){n.info(function(){return"XMLHTTP RESP ("+r+") [ attempt "+i+"]: "+t+`
`+e+`
`+s+" "+o})}function wn(n,t,e,r){n.info(function(){return"XMLHTTP TEXT ("+t+"): "+yp(n,e)+(r?" "+r:"")})}function _p(n,t){n.info(function(){return"TIMEOUT: "+t})}$i.prototype.info=function(){};function yp(n,t){if(!n.g)return t;if(!t)return null;try{var e=JSON.parse(t);if(e){for(n=0;n<e.length;n++)if(Array.isArray(e[n])){var r=e[n];if(!(2>r.length)){var i=r[1];if(Array.isArray(i)&&!(1>i.length)){var s=i[0];if(s!="noop"&&s!="stop"&&s!="close")for(var o=1;o<i.length;o++)i[o]=""}}}}return aa(e)}catch{return t}}var Be={},Yl=null;function Qi(){return Yl=Yl||new lt}Be.Ta="serverreachability";function Ih(n){wt.call(this,Be.Ta,n)}ht(Ih,wt);function Tr(n){let t=Qi();gt(t,new Ih(t))}Be.STAT_EVENT="statevent";function Eh(n,t){wt.call(this,Be.STAT_EVENT,n),this.stat=t}ht(Eh,wt);function Et(n){let t=Qi();gt(t,new Eh(t,n))}Be.Ua="timingevent";function Th(n,t){wt.call(this,Be.Ua,n),this.size=t}ht(Th,wt);function Cr(n,t){if(typeof n!="function")throw Error("Fn must not be null and must be a function");return x.setTimeout(function(){n()},t)}var Wi={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},Ah={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function ha(){}ha.prototype.h=null;function Jl(n){return n.h||(n.h=n.i())}function Sh(){}var br={OPEN:"a",vb:"b",Ra:"c",Hb:"d"};function da(){wt.call(this,"d")}ht(da,wt);function fa(){wt.call(this,"c")}ht(fa,wt);var $o;function Hi(){}ht(Hi,ha);Hi.prototype.g=function(){return new XMLHttpRequest};Hi.prototype.i=function(){return{}};$o=new Hi;function xr(n,t,e,r){this.l=n,this.j=t,this.m=e,this.W=r||1,this.U=new Er(this),this.P=wp,n=Oo?125:void 0,this.V=new Ki(n),this.I=null,this.i=!1,this.u=this.B=this.A=this.L=this.G=this.Y=this.C=null,this.F=[],this.g=null,this.o=0,this.s=this.v=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new Rh}function Rh(){this.i=null,this.g="",this.h=!1}var wp=45e3,Ph={},Qo={};T=xr.prototype;T.setTimeout=function(n){this.P=n};function Wo(n,t,e){n.L=1,n.A=Ji(se(t)),n.u=e,n.S=!0,Ch(n,null)}function Ch(n,t){n.G=Date.now(),Vr(n),n.B=se(n.A);var e=n.B,r=n.W;Array.isArray(r)||(r=[String(r)]),Mh(e.i,"t",r),n.o=0,e=n.l.J,n.h=new Rh,n.g=rd(n.l,e?t:null,!n.u),0<n.O&&(n.M=new Ko(yt(n.Pa,n,n.g),n.O)),wh(n.U,n.g,"readystatechange",n.nb),t=n.I?ch(n.I):{},n.u?(n.v||(n.v="POST"),t["Content-Type"]="application/x-www-form-urlencoded",n.g.ha(n.B,n.v,n.u,t)):(n.v="GET",n.g.ha(n.B,n.v,null,t)),Tr(),gp(n.j,n.v,n.B,n.m,n.W,n.u)}T.nb=function(n){n=n.target;let t=this.M;t&&$t(n)==3?t.l():this.Pa(n)};T.Pa=function(n){try{if(n==this.g)t:{let l=$t(this.g);var t=this.g.Ia();let h=this.g.da();if(!(3>l)&&(l!=3||Oo||this.g&&(this.h.h||this.g.ja()||eh(this.g)))){this.J||l!=4||t==7||(t==8||0>=h?Tr(3):Tr(2)),Yi(this);var e=this.g.da();this.ca=e;e:if(bh(this)){var r=eh(this.g);n="";var i=r.length,s=$t(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){Oe(this),_r(this);var o="";break e}this.h.i=new x.TextDecoder}for(t=0;t<i;t++)this.h.h=!0,n+=this.h.i.decode(r[t],{stream:s&&t==i-1});r.length=0,this.h.g+=n,this.o=0,o=this.h.g}else o=this.g.ja();if(this.i=e==200,pp(this.j,this.v,this.B,this.m,this.W,l,e),this.i){if(this.aa&&!this.K){e:{if(this.g){var a,u=this.g;if((a=u.g?u.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!yr(a)){var c=a;break e}}c=null}if(e=c)wn(this.j,this.m,e,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Ho(this,e);else{this.i=!1,this.s=3,Et(12),Oe(this),_r(this);break t}}this.S?(xh(this,l,o),Oo&&this.i&&l==3&&(wh(this.U,this.V,"tick",this.mb),this.V.start())):(wn(this.j,this.m,o,null),Ho(this,o)),l==4&&Oe(this),this.i&&!this.J&&(l==4?Zh(this.l,this):(this.i=!1,Vr(this)))}else Bp(this.g),e==400&&0<o.indexOf("Unknown SID")?(this.s=3,Et(12)):(this.s=0,Et(13)),Oe(this),_r(this)}}}catch{}finally{}};function bh(n){return n.g?n.v=="GET"&&n.L!=2&&n.l.Ha:!1}function xh(n,t,e){let r=!0,i;for(;!n.J&&n.o<e.length;)if(i=vp(n,e),i==Qo){t==4&&(n.s=4,Et(14),r=!1),wn(n.j,n.m,null,"[Incomplete Response]");break}else if(i==Ph){n.s=4,Et(15),wn(n.j,n.m,e,"[Invalid Chunk]"),r=!1;break}else wn(n.j,n.m,i,null),Ho(n,i);bh(n)&&n.o!=0&&(n.h.g=n.h.g.slice(n.o),n.o=0),t!=4||e.length!=0||n.h.h||(n.s=1,Et(16),r=!1),n.i=n.i&&r,r?0<e.length&&!n.ba&&(n.ba=!0,t=n.l,t.g==n&&t.ca&&!t.M&&(t.l.info("Great, no buffering proxy detected. Bytes received: "+e.length),wa(t),t.M=!0,Et(11))):(wn(n.j,n.m,e,"[Invalid Chunked Response]"),Oe(n),_r(n))}T.mb=function(){if(this.g){var n=$t(this.g),t=this.g.ja();this.o<t.length&&(Yi(this),xh(this,n,t),this.i&&n!=4&&Vr(this))}};function vp(n,t){var e=n.o,r=t.indexOf(`
`,e);return r==-1?Qo:(e=Number(t.substring(e,r)),isNaN(e)?Ph:(r+=1,r+e>t.length?Qo:(t=t.slice(r,r+e),n.o=r+e,t)))}T.cancel=function(){this.J=!0,Oe(this)};function Vr(n){n.Y=Date.now()+n.P,Vh(n,n.P)}function Vh(n,t){if(n.C!=null)throw Error("WatchDog timer not null");n.C=Cr(yt(n.lb,n),t)}function Yi(n){n.C&&(x.clearTimeout(n.C),n.C=null)}T.lb=function(){this.C=null;let n=Date.now();0<=n-this.Y?(_p(this.j,this.B),this.L!=2&&(Tr(),Et(17)),Oe(this),this.s=2,_r(this)):Vh(this,this.Y-n)};function _r(n){n.l.H==0||n.J||Zh(n.l,n)}function Oe(n){Yi(n);var t=n.M;t&&typeof t.sa=="function"&&t.sa(),n.M=null,ca(n.V),vh(n.U),n.g&&(t=n.g,n.g=null,t.abort(),t.sa())}function Ho(n,t){try{var e=n.l;if(e.H!=0&&(e.g==n||Yo(e.i,n))){if(!n.K&&Yo(e.i,n)&&e.H==3){try{var r=e.Ja.g.parse(t)}catch{r=null}if(Array.isArray(r)&&r.length==3){var i=r;if(i[0]==0){t:if(!e.u){if(e.g)if(e.g.G+3e3<n.G)Oi(e),ts(e);else break t;ya(e),Et(18)}}else e.Fa=i[1],0<e.Fa-e.V&&37500>i[2]&&e.G&&e.A==0&&!e.v&&(e.v=Cr(yt(e.ib,e),6e3));if(1>=qh(e.i)&&e.oa){try{e.oa()}catch{}e.oa=void 0}}else Le(e,11)}else if((n.K||e.g==n)&&Oi(e),!yr(t))for(i=e.Ja.g.parse(t),t=0;t<i.length;t++){let c=i[t];if(e.V=c[0],c=c[1],e.H==2)if(c[0]=="c"){e.K=c[1],e.pa=c[2];let l=c[3];l!=null&&(e.ra=l,e.l.info("VER="+e.ra));let h=c[4];h!=null&&(e.Ga=h,e.l.info("SVER="+e.Ga));let d=c[5];d!=null&&typeof d=="number"&&0<d&&(r=1.5*d,e.L=r,e.l.info("backChannelRequestTimeoutMs_="+r)),r=e;let m=n.g;if(m){let A=m.g?m.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(A){var s=r.i;s.g||A.indexOf("spdy")==-1&&A.indexOf("quic")==-1&&A.indexOf("h2")==-1||(s.j=s.l,s.g=new Set,s.h&&(ma(s,s.h),s.h=null))}if(r.F){let w=m.g?m.g.getResponseHeader("X-HTTP-Session-Id"):null;w&&(r.Da=w,K(r.I,r.F,w))}}e.H=3,e.h&&e.h.Ba(),e.ca&&(e.S=Date.now()-n.G,e.l.info("Handshake RTT: "+e.S+"ms")),r=e;var o=n;if(r.wa=nd(r,r.J?r.pa:null,r.Y),o.K){Bh(r.i,o);var a=o,u=r.L;u&&a.setTimeout(u),a.C&&(Yi(a),Vr(a)),r.g=o}else Jh(r);0<e.j.length&&es(e)}else c[0]!="stop"&&c[0]!="close"||Le(e,7);else e.H==3&&(c[0]=="stop"||c[0]=="close"?c[0]=="stop"?Le(e,7):_a(e):c[0]!="noop"&&e.h&&e.h.Aa(c),e.A=0)}}Tr(4)}catch{}}function Ip(n){if(n.Z&&typeof n.Z=="function")return n.Z();if(typeof Map<"u"&&n instanceof Map||typeof Set<"u"&&n instanceof Set)return Array.from(n.values());if(typeof n=="string")return n.split("");if(Ui(n)){for(var t=[],e=n.length,r=0;r<e;r++)t.push(n[r]);return t}t=[],e=0;for(r in n)t[e++]=n[r];return t}function Ep(n){if(n.ta&&typeof n.ta=="function")return n.ta();if(!n.Z||typeof n.Z!="function"){if(typeof Map<"u"&&n instanceof Map)return Array.from(n.keys());if(!(typeof Set<"u"&&n instanceof Set)){if(Ui(n)||typeof n=="string"){var t=[];n=n.length;for(var e=0;e<n;e++)t.push(e);return t}t=[],e=0;for(let r in n)t[e++]=r;return t}}}function Dh(n,t){if(n.forEach&&typeof n.forEach=="function")n.forEach(t,void 0);else if(Ui(n)||typeof n=="string")Array.prototype.forEach.call(n,t,void 0);else for(var e=Ep(n),r=Ip(n),i=r.length,s=0;s<i;s++)t.call(void 0,r[s],e&&e[s],n)}var Nh=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Tp(n,t){if(n){n=n.split("&");for(var e=0;e<n.length;e++){var r=n[e].indexOf("="),i=null;if(0<=r){var s=n[e].substring(0,r);i=n[e].substring(r+1)}else s=n[e];t(s,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}function qe(n){if(this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,n instanceof qe){this.h=n.h,Fi(this,n.j),this.s=n.s,this.g=n.g,Mi(this,n.m),this.l=n.l;var t=n.i,e=new Ar;e.i=t.i,t.g&&(e.g=new Map(t.g),e.h=t.h),Xl(this,e),this.o=n.o}else n&&(t=String(n).match(Nh))?(this.h=!1,Fi(this,t[1]||"",!0),this.s=gr(t[2]||""),this.g=gr(t[3]||"",!0),Mi(this,t[4]),this.l=gr(t[5]||"",!0),Xl(this,t[6]||"",!0),this.o=gr(t[7]||"")):(this.h=!1,this.i=new Ar(null,this.h))}qe.prototype.toString=function(){var n=[],t=this.j;t&&n.push(pr(t,Zl,!0),":");var e=this.g;return(e||t=="file")&&(n.push("//"),(t=this.s)&&n.push(pr(t,Zl,!0),"@"),n.push(encodeURIComponent(String(e)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),e=this.m,e!=null&&n.push(":",String(e))),(e=this.l)&&(this.g&&e.charAt(0)!="/"&&n.push("/"),n.push(pr(e,e.charAt(0)=="/"?Rp:Sp,!0))),(e=this.i.toString())&&n.push("?",e),(e=this.o)&&n.push("#",pr(e,Cp)),n.join("")};function se(n){return new qe(n)}function Fi(n,t,e){n.j=e?gr(t,!0):t,n.j&&(n.j=n.j.replace(/:$/,""))}function Mi(n,t){if(t){if(t=Number(t),isNaN(t)||0>t)throw Error("Bad port number "+t);n.m=t}else n.m=null}function Xl(n,t,e){t instanceof Ar?(n.i=t,bp(n.i,n.h)):(e||(t=pr(t,Pp)),n.i=new Ar(t,n.h))}function K(n,t,e){n.i.set(t,e)}function Ji(n){return K(n,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),n}function gr(n,t){return n?t?decodeURI(n.replace(/%25/g,"%2525")):decodeURIComponent(n):""}function pr(n,t,e){return typeof n=="string"?(n=encodeURI(n).replace(t,Ap),e&&(n=n.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),n):null}function Ap(n){return n=n.charCodeAt(0),"%"+(n>>4&15).toString(16)+(n&15).toString(16)}var Zl=/[#\/\?@]/g,Sp=/[#\?:]/g,Rp=/[#\?]/g,Pp=/[#\?@]/g,Cp=/#/g;function Ar(n,t){this.h=this.g=null,this.i=n||null,this.j=!!t}function ye(n){n.g||(n.g=new Map,n.h=0,n.i&&Tp(n.i,function(t,e){n.add(decodeURIComponent(t.replace(/\+/g," ")),e)}))}T=Ar.prototype;T.add=function(n,t){ye(this),this.i=null,n=En(this,n);var e=this.g.get(n);return e||this.g.set(n,e=[]),e.push(t),this.h+=1,this};function kh(n,t){ye(n),t=En(n,t),n.g.has(t)&&(n.i=null,n.h-=n.g.get(t).length,n.g.delete(t))}function Fh(n,t){return ye(n),t=En(n,t),n.g.has(t)}T.forEach=function(n,t){ye(this),this.g.forEach(function(e,r){e.forEach(function(i){n.call(t,i,r,this)},this)},this)};T.ta=function(){ye(this);let n=Array.from(this.g.values()),t=Array.from(this.g.keys()),e=[];for(let r=0;r<t.length;r++){let i=n[r];for(let s=0;s<i.length;s++)e.push(t[r])}return e};T.Z=function(n){ye(this);let t=[];if(typeof n=="string")Fh(this,n)&&(t=t.concat(this.g.get(En(this,n))));else{n=Array.from(this.g.values());for(let e=0;e<n.length;e++)t=t.concat(n[e])}return t};T.set=function(n,t){return ye(this),this.i=null,n=En(this,n),Fh(this,n)&&(this.h-=this.g.get(n).length),this.g.set(n,[t]),this.h+=1,this};T.get=function(n,t){return n?(n=this.Z(n),0<n.length?String(n[0]):t):t};function Mh(n,t,e){kh(n,t),0<e.length&&(n.i=null,n.g.set(En(n,t),ta(e)),n.h+=e.length)}T.toString=function(){if(this.i)return this.i;if(!this.g)return"";let n=[],t=Array.from(this.g.keys());for(var e=0;e<t.length;e++){var r=t[e];let s=encodeURIComponent(String(r)),o=this.Z(r);for(r=0;r<o.length;r++){var i=s;o[r]!==""&&(i+="="+encodeURIComponent(String(o[r]))),n.push(i)}}return this.i=n.join("&")};function En(n,t){return t=String(t),n.j&&(t=t.toLowerCase()),t}function bp(n,t){t&&!n.j&&(ye(n),n.i=null,n.g.forEach(function(e,r){var i=r.toLowerCase();r!=i&&(kh(this,r),Mh(this,i,e))},n)),n.j=t}var xp=class{constructor(n,t){this.g=n,this.map=t}};function Oh(n){this.l=n||Vp,x.PerformanceNavigationTiming?(n=x.performance.getEntriesByType("navigation"),n=0<n.length&&(n[0].nextHopProtocol=="hq"||n[0].nextHopProtocol=="h2")):n=!!(x.g&&x.g.Ka&&x.g.Ka()&&x.g.Ka().dc),this.j=n?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var Vp=10;function Lh(n){return n.h?!0:n.g?n.g.size>=n.j:!1}function qh(n){return n.h?1:n.g?n.g.size:0}function Yo(n,t){return n.h?n.h==t:n.g?n.g.has(t):!1}function ma(n,t){n.g?n.g.add(t):n.h=t}function Bh(n,t){n.h&&n.h==t?n.h=null:n.g&&n.g.has(t)&&n.g.delete(t)}Oh.prototype.cancel=function(){if(this.i=Uh(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(let n of this.g.values())n.cancel();this.g.clear()}};function Uh(n){if(n.h!=null)return n.i.concat(n.h.F);if(n.g!=null&&n.g.size!==0){let t=n.i;for(let e of n.g.values())t=t.concat(e.F);return t}return ta(n.i)}var Dp=class{stringify(n){return x.JSON.stringify(n,void 0)}parse(n){return x.JSON.parse(n,void 0)}};function Np(){this.g=new Dp}function kp(n,t,e){let r=e||"";try{Dh(n,function(i,s){let o=i;Rr(i)&&(o=aa(i)),t.push(r+s+"="+encodeURIComponent(o))})}catch(i){throw t.push(r+"type="+encodeURIComponent("_badmap")),i}}function Fp(n,t){let e=new $i;if(x.Image){let r=new Image;r.onload=Ci(Ni,e,r,"TestLoadImage: loaded",!0,t),r.onerror=Ci(Ni,e,r,"TestLoadImage: error",!1,t),r.onabort=Ci(Ni,e,r,"TestLoadImage: abort",!1,t),r.ontimeout=Ci(Ni,e,r,"TestLoadImage: timeout",!1,t),x.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=n}else t(!1)}function Ni(n,t,e,r,i){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,i(r)}catch{}}function Dr(n){this.l=n.ec||null,this.j=n.ob||!1}ht(Dr,ha);Dr.prototype.g=function(){return new Xi(this.l,this.j)};Dr.prototype.i=function(n){return function(){return n}}({});function Xi(n,t){lt.call(this),this.F=n,this.u=t,this.m=void 0,this.readyState=ga,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}ht(Xi,lt);var ga=0;T=Xi.prototype;T.open=function(n,t){if(this.readyState!=ga)throw this.abort(),Error("Error reopening a connection");this.C=n,this.B=t,this.readyState=1,Sr(this)};T.send=function(n){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;let t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};n&&(t.body=n),(this.F||x).fetch(new Request(this.B,t)).then(this.$a.bind(this),this.ka.bind(this))};T.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,Nr(this)),this.readyState=ga};T.$a=function(n){if(this.g&&(this.l=n,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=n.headers,this.readyState=2,Sr(this)),this.g&&(this.readyState=3,Sr(this),this.g)))if(this.responseType==="arraybuffer")n.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(typeof x.ReadableStream<"u"&&"body"in n){if(this.j=n.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;Gh(this)}else n.text().then(this.Za.bind(this),this.ka.bind(this))};function Gh(n){n.j.read().then(n.Xa.bind(n)).catch(n.ka.bind(n))}T.Xa=function(n){if(this.g){if(this.u&&n.value)this.response.push(n.value);else if(!this.u){var t=n.value?n.value:new Uint8Array(0);(t=this.A.decode(t,{stream:!n.done}))&&(this.response=this.responseText+=t)}n.done?Nr(this):Sr(this),this.readyState==3&&Gh(this)}};T.Za=function(n){this.g&&(this.response=this.responseText=n,Nr(this))};T.Ya=function(n){this.g&&(this.response=n,Nr(this))};T.ka=function(){this.g&&Nr(this)};function Nr(n){n.readyState=4,n.l=null,n.j=null,n.A=null,Sr(n)}T.setRequestHeader=function(n,t){this.v.append(n,t)};T.getResponseHeader=function(n){return this.h&&this.h.get(n.toLowerCase())||""};T.getAllResponseHeaders=function(){if(!this.h)return"";let n=[],t=this.h.entries();for(var e=t.next();!e.done;)e=e.value,n.push(e[0]+": "+e[1]),e=t.next();return n.join(`\r
`)};function Sr(n){n.onreadystatechange&&n.onreadystatechange.call(n)}Object.defineProperty(Xi.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(n){this.m=n?"include":"same-origin"}});var Mp=x.JSON.parse;function J(n){lt.call(this),this.headers=new Map,this.u=n||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=jh,this.L=this.M=!1}ht(J,lt);var jh="",Op=/^https?$/i,Lp=["POST","PUT"];T=J.prototype;T.Oa=function(n){this.M=n};T.ha=function(n,t,e,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+n);t=t?t.toUpperCase():"GET",this.I=n,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=this.u?this.u.g():$o.g(),this.C=this.u?Jl(this.u):Jl($o),this.g.onreadystatechange=yt(this.La,this);try{this.G=!0,this.g.open(t,String(n),!0),this.G=!1}catch(s){th(this,s);return}if(n=e||"",e=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var i in r)e.set(i,r[i]);else if(typeof r.keys=="function"&&typeof r.get=="function")for(let s of r.keys())e.set(s,r.get(s));else throw Error("Unknown input type for opt_headers: "+String(r));r=Array.from(e.keys()).find(s=>s.toLowerCase()=="content-type"),i=x.FormData&&n instanceof x.FormData,!(0<=sh(Lp,t))||r||i||e.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(let[s,o]of e)this.g.setRequestHeader(s,o);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{$h(this),0<this.B&&((this.L=qp(this.g))?(this.g.timeout=this.B,this.g.ontimeout=yt(this.ua,this)):this.A=la(this.ua,this.B,this)),this.v=!0,this.g.send(n),this.v=!1}catch(s){th(this,s)}};function qp(n){return In&&typeof n.timeout=="number"&&n.ontimeout!==void 0}T.ua=function(){typeof Zo<"u"&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,gt(this,"timeout"),this.abort(8))};function th(n,t){n.h=!1,n.g&&(n.l=!0,n.g.abort(),n.l=!1),n.j=t,n.m=5,zh(n),Zi(n)}function zh(n){n.F||(n.F=!0,gt(n,"complete"),gt(n,"error"))}T.abort=function(n){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=n||7,gt(this,"complete"),gt(this,"abort"),Zi(this))};T.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Zi(this,!0)),J.$.N.call(this)};T.La=function(){this.s||(this.G||this.v||this.l?Kh(this):this.kb())};T.kb=function(){Kh(this)};function Kh(n){if(n.h&&typeof Zo<"u"&&(!n.C[1]||$t(n)!=4||n.da()!=2)){if(n.v&&$t(n)==4)la(n.La,0,n);else if(gt(n,"readystatechange"),$t(n)==4){n.h=!1;try{let o=n.da();t:switch(o){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var t=!0;break t;default:t=!1}var e;if(!(e=t)){var r;if(r=o===0){var i=String(n.I).match(Nh)[1]||null;!i&&x.self&&x.self.location&&(i=x.self.location.protocol.slice(0,-1)),r=!Op.test(i?i.toLowerCase():"")}e=r}if(e)gt(n,"complete"),gt(n,"success");else{n.m=6;try{var s=2<$t(n)?n.g.statusText:""}catch{s=""}n.j=s+" ["+n.da()+"]",zh(n)}}finally{Zi(n)}}}}function Zi(n,t){if(n.g){$h(n);let e=n.g,r=n.C[0]?()=>{}:null;n.g=null,n.C=null,t||gt(n,"ready");try{e.onreadystatechange=r}catch{}}}function $h(n){n.g&&n.L&&(n.g.ontimeout=null),n.A&&(x.clearTimeout(n.A),n.A=null)}T.isActive=function(){return!!this.g};function $t(n){return n.g?n.g.readyState:0}T.da=function(){try{return 2<$t(this)?this.g.status:-1}catch{return-1}};T.ja=function(){try{return this.g?this.g.responseText:""}catch{return""}};T.Wa=function(n){if(this.g){var t=this.g.responseText;return n&&t.indexOf(n)==0&&(t=t.substring(n.length)),Mp(t)}};function eh(n){try{if(!n.g)return null;if("response"in n.g)return n.g.response;switch(n.K){case jh:case"text":return n.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in n.g)return n.g.mozResponseArrayBuffer}return null}catch{return null}}function Bp(n){let t={};n=(n.g&&2<=$t(n)&&n.g.getAllResponseHeaders()||"").split(`\r
`);for(let r=0;r<n.length;r++){if(yr(n[r]))continue;var e=dp(n[r]);let i=e[0];if(e=e[1],typeof e!="string")continue;e=e.trim();let s=t[i]||[];t[i]=s,s.push(e)}up(t,function(r){return r.join(", ")})}T.Ia=function(){return this.m};T.Sa=function(){return typeof this.j=="string"?this.j:String(this.j)};function Qh(n){let t="";return na(n,function(e,r){t+=r,t+=":",t+=e,t+=`\r
`}),t}function pa(n,t,e){t:{for(r in e){var r=!1;break t}r=!0}r||(e=Qh(e),typeof n=="string"?e!=null&&encodeURIComponent(String(e)):K(n,t,e))}function fr(n,t,e){return e&&e.internalChannelParams&&e.internalChannelParams[n]||t}function Wh(n){this.Ga=0,this.j=[],this.l=new $i,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=fr("failFast",!1,n),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=fr("baseRetryDelayMs",5e3,n),this.hb=fr("retryDelaySeedMs",1e4,n),this.eb=fr("forwardChannelMaxRetries",2,n),this.xa=fr("forwardChannelRequestTimeoutMs",2e4,n),this.va=n&&n.xmlHttpFactory||void 0,this.Ha=n&&n.useFetchStreams||!1,this.L=void 0,this.J=n&&n.supportsCrossDomainXhr||!1,this.K="",this.i=new Oh(n&&n.concurrentRequestLimit),this.Ja=new Np,this.P=n&&n.fastHandshake||!1,this.O=n&&n.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=n&&n.bc||!1,n&&n.Ea&&this.l.Ea(),n&&n.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&n&&n.detectBufferingProxy||!1,this.qa=void 0,n&&n.longPollingTimeout&&0<n.longPollingTimeout&&(this.qa=n.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}T=Wh.prototype;T.ra=8;T.H=1;function _a(n){if(Hh(n),n.H==3){var t=n.W++,e=se(n.I);if(K(e,"SID",n.K),K(e,"RID",t),K(e,"TYPE","terminate"),kr(n,e),t=new xr(n,n.l,t),t.L=2,t.A=Ji(se(e)),e=!1,x.navigator&&x.navigator.sendBeacon)try{e=x.navigator.sendBeacon(t.A.toString(),"")}catch{}!e&&x.Image&&(new Image().src=t.A,e=!0),e||(t.g=rd(t.l,null),t.g.ha(t.A)),t.G=Date.now(),Vr(t)}ed(n)}function ts(n){n.g&&(wa(n),n.g.cancel(),n.g=null)}function Hh(n){ts(n),n.u&&(x.clearTimeout(n.u),n.u=null),Oi(n),n.i.cancel(),n.m&&(typeof n.m=="number"&&x.clearTimeout(n.m),n.m=null)}function es(n){if(!Lh(n.i)&&!n.m){n.m=!0;var t=n.Na;vr||_h(),Ir||(vr(),Ir=!0),ua.add(t,n),n.C=0}}function Up(n,t){return qh(n.i)>=n.i.j-(n.m?1:0)?!1:n.m?(n.j=t.F.concat(n.j),!0):n.H==1||n.H==2||n.C>=(n.cb?0:n.eb)?!1:(n.m=Cr(yt(n.Na,n,t),td(n,n.C)),n.C++,!0)}T.Na=function(n){if(this.m)if(this.m=null,this.H==1){if(!n){this.W=Math.floor(1e5*Math.random()),n=this.W++;let i=new xr(this,this.l,n),s=this.s;if(this.U&&(s?(s=ch(s),lh(s,this.U)):s=this.U),this.o!==null||this.O||(i.I=s,s=null),this.P)t:{for(var t=0,e=0;e<this.j.length;e++){e:{var r=this.j[e];if("__data__"in r.map&&(r=r.map.__data__,typeof r=="string")){r=r.length;break e}r=void 0}if(r===void 0)break;if(t+=r,4096<t){t=e;break t}if(t===4096||e===this.j.length-1){t=e+1;break t}}t=1e3}else t=1e3;t=Yh(this,i,t),e=se(this.I),K(e,"RID",n),K(e,"CVER",22),this.F&&K(e,"X-HTTP-Session-Id",this.F),kr(this,e),s&&(this.O?t="headers="+encodeURIComponent(String(Qh(s)))+"&"+t:this.o&&pa(e,this.o,s)),ma(this.i,i),this.bb&&K(e,"TYPE","init"),this.P?(K(e,"$req",t),K(e,"SID","null"),i.aa=!0,Wo(i,e,null)):Wo(i,e,t),this.H=2}}else this.H==3&&(n?nh(this,n):this.j.length==0||Lh(this.i)||nh(this))};function nh(n,t){var e;t?e=t.m:e=n.W++;let r=se(n.I);K(r,"SID",n.K),K(r,"RID",e),K(r,"AID",n.V),kr(n,r),n.o&&n.s&&pa(r,n.o,n.s),e=new xr(n,n.l,e,n.C+1),n.o===null&&(e.I=n.s),t&&(n.j=t.F.concat(n.j)),t=Yh(n,e,1e3),e.setTimeout(Math.round(.5*n.xa)+Math.round(.5*n.xa*Math.random())),ma(n.i,e),Wo(e,r,t)}function kr(n,t){n.na&&na(n.na,function(e,r){K(t,r,e)}),n.h&&Dh({},function(e,r){K(t,r,e)})}function Yh(n,t,e){e=Math.min(n.j.length,e);var r=n.h?yt(n.h.Va,n.h,n):null;t:{var i=n.j;let s=-1;for(;;){let o=["count="+e];s==-1?0<e?(s=i[0].g,o.push("ofs="+s)):s=0:o.push("ofs="+s);let a=!0;for(let u=0;u<e;u++){let c=i[u].g,l=i[u].map;if(c-=s,0>c)s=Math.max(0,i[u].g-100),a=!1;else try{kp(l,o,"req"+c+"_")}catch{r&&r(l)}}if(a){r=o.join("&");break t}}}return n=n.j.splice(0,e),t.F=n,r}function Jh(n){if(!n.g&&!n.u){n.ba=1;var t=n.Ma;vr||_h(),Ir||(vr(),Ir=!0),ua.add(t,n),n.A=0}}function ya(n){return n.g||n.u||3<=n.A?!1:(n.ba++,n.u=Cr(yt(n.Ma,n),td(n,n.A)),n.A++,!0)}T.Ma=function(){if(this.u=null,Xh(this),this.ca&&!(this.M||this.g==null||0>=this.S)){var n=2*this.S;this.l.info("BP detection timer enabled: "+n),this.B=Cr(yt(this.jb,this),n)}};T.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,Et(10),ts(this),Xh(this))};function wa(n){n.B!=null&&(x.clearTimeout(n.B),n.B=null)}function Xh(n){n.g=new xr(n,n.l,"rpc",n.ba),n.o===null&&(n.g.I=n.s),n.g.O=0;var t=se(n.wa);K(t,"RID","rpc"),K(t,"SID",n.K),K(t,"AID",n.V),K(t,"CI",n.G?"0":"1"),!n.G&&n.qa&&K(t,"TO",n.qa),K(t,"TYPE","xmlhttp"),kr(n,t),n.o&&n.s&&pa(t,n.o,n.s),n.L&&n.g.setTimeout(n.L);var e=n.g;n=n.pa,e.L=1,e.A=Ji(se(t)),e.u=null,e.S=!0,Ch(e,n)}T.ib=function(){this.v!=null&&(this.v=null,ts(this),ya(this),Et(19))};function Oi(n){n.v!=null&&(x.clearTimeout(n.v),n.v=null)}function Zh(n,t){var e=null;if(n.g==t){Oi(n),wa(n),n.g=null;var r=2}else if(Yo(n.i,t))e=t.F,Bh(n.i,t),r=1;else return;if(n.H!=0){if(t.i)if(r==1){e=t.u?t.u.length:0,t=Date.now()-t.G;var i=n.C;r=Qi(),gt(r,new Th(r,e)),es(n)}else Jh(n);else if(i=t.s,i==3||i==0&&0<t.ca||!(r==1&&Up(n,t)||r==2&&ya(n)))switch(e&&0<e.length&&(t=n.i,t.i=t.i.concat(e)),i){case 1:Le(n,5);break;case 4:Le(n,10);break;case 3:Le(n,6);break;default:Le(n,2)}}}function td(n,t){let e=n.ab+Math.floor(Math.random()*n.hb);return n.isActive()||(e*=2),e*t}function Le(n,t){if(n.l.info("Error code "+t),t==2){var e=null;n.h&&(e=null);var r=yt(n.pb,n);e||(e=new qe("//www.google.com/images/cleardot.gif"),x.location&&x.location.protocol=="http"||Fi(e,"https"),Ji(e)),Fp(e.toString(),r)}else Et(2);n.H=0,n.h&&n.h.za(t),ed(n),Hh(n)}T.pb=function(n){n?(this.l.info("Successfully pinged google.com"),Et(2)):(this.l.info("Failed to ping google.com"),Et(1))};function ed(n){if(n.H=0,n.ma=[],n.h){let t=Uh(n.i);(t.length!=0||n.j.length!=0)&&(Ql(n.ma,t),Ql(n.ma,n.j),n.i.i.length=0,ta(n.j),n.j.length=0),n.h.ya()}}function nd(n,t,e){var r=e instanceof qe?se(e):new qe(e);if(r.g!="")t&&(r.g=t+"."+r.g),Mi(r,r.m);else{var i=x.location;r=i.protocol,t=t?t+"."+i.hostname:i.hostname,i=+i.port;var s=new qe(null);r&&Fi(s,r),t&&(s.g=t),i&&Mi(s,i),e&&(s.l=e),r=s}return e=n.F,t=n.Da,e&&t&&K(r,e,t),K(r,"VER",n.ra),kr(n,r),r}function rd(n,t,e){if(t&&!n.J)throw Error("Can't create secondary domain capable XhrIo object.");return t=n.Ha&&!n.va?new J(new Dr({ob:e})):new J(n.va),t.Oa(n.J),t}T.isActive=function(){return!!this.h&&this.h.isActive(this)};function id(){}T=id.prototype;T.Ba=function(){};T.Aa=function(){};T.za=function(){};T.ya=function(){};T.isActive=function(){return!0};T.Va=function(){};function Li(){if(In&&!(10<=Number(ip)))throw Error("Environmental error: no available transport.")}Li.prototype.g=function(n,t){return new Pt(n,t)};function Pt(n,t){lt.call(this),this.g=new Wh(t),this.l=n,this.h=t&&t.messageUrlParams||null,n=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(n?n["X-Client-Protocol"]="webchannel":n={"X-Client-Protocol":"webchannel"}),this.g.s=n,n=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(n?n["X-WebChannel-Content-Type"]=t.messageContentType:n={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.Ca&&(n?n["X-WebChannel-Client-Profile"]=t.Ca:n={"X-WebChannel-Client-Profile":t.Ca}),this.g.U=n,(n=t&&t.cc)&&!yr(n)&&(this.g.o=n),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!yr(t)&&(this.g.F=t,n=this.h,n!==null&&t in n&&(n=this.h,t in n&&delete n[t])),this.j=new Tn(this)}ht(Pt,lt);Pt.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var n=this.g,t=this.l,e=this.h||void 0;Et(0),n.Y=t,n.na=e||{},n.G=n.aa,n.I=nd(n,null,n.Y),es(n)};Pt.prototype.close=function(){_a(this.g)};Pt.prototype.u=function(n){var t=this.g;if(typeof n=="string"){var e={};e.__data__=n,n=e}else this.v&&(e={},e.__data__=aa(n),n=e);t.j.push(new xp(t.fb++,n)),t.H==3&&es(t)};Pt.prototype.N=function(){this.g.h=null,delete this.j,_a(this.g),delete this.g,Pt.$.N.call(this)};function sd(n){da.call(this),n.__headers__&&(this.headers=n.__headers__,this.statusCode=n.__status__,delete n.__headers__,delete n.__status__);var t=n.__sm__;if(t){t:{for(let e in t){n=e;break t}n=void 0}(this.i=n)&&(n=this.i,t=t!==null&&n in t?t[n]:void 0),this.data=t}else this.data=n}ht(sd,da);function od(){fa.call(this),this.status=1}ht(od,fa);function Tn(n){this.g=n}ht(Tn,id);Tn.prototype.Ba=function(){gt(this.g,"a")};Tn.prototype.Aa=function(n){gt(this.g,new sd(n))};Tn.prototype.za=function(n){gt(this.g,new od)};Tn.prototype.ya=function(){gt(this.g,"b")};function Gp(){this.blockSize=-1}function Ot(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}ht(Ot,Gp);Ot.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0};function Mo(n,t,e){e||(e=0);var r=Array(16);if(typeof t=="string")for(var i=0;16>i;++i)r[i]=t.charCodeAt(e++)|t.charCodeAt(e++)<<8|t.charCodeAt(e++)<<16|t.charCodeAt(e++)<<24;else for(i=0;16>i;++i)r[i]=t[e++]|t[e++]<<8|t[e++]<<16|t[e++]<<24;t=n.g[0],e=n.g[1],i=n.g[2];var s=n.g[3],o=t+(s^e&(i^s))+r[0]+3614090360&4294967295;t=e+(o<<7&4294967295|o>>>25),o=s+(i^t&(e^i))+r[1]+3905402710&4294967295,s=t+(o<<12&4294967295|o>>>20),o=i+(e^s&(t^e))+r[2]+606105819&4294967295,i=s+(o<<17&4294967295|o>>>15),o=e+(t^i&(s^t))+r[3]+3250441966&4294967295,e=i+(o<<22&4294967295|o>>>10),o=t+(s^e&(i^s))+r[4]+4118548399&4294967295,t=e+(o<<7&4294967295|o>>>25),o=s+(i^t&(e^i))+r[5]+1200080426&4294967295,s=t+(o<<12&4294967295|o>>>20),o=i+(e^s&(t^e))+r[6]+2821735955&4294967295,i=s+(o<<17&4294967295|o>>>15),o=e+(t^i&(s^t))+r[7]+4249261313&4294967295,e=i+(o<<22&4294967295|o>>>10),o=t+(s^e&(i^s))+r[8]+1770035416&4294967295,t=e+(o<<7&4294967295|o>>>25),o=s+(i^t&(e^i))+r[9]+2336552879&4294967295,s=t+(o<<12&4294967295|o>>>20),o=i+(e^s&(t^e))+r[10]+4294925233&4294967295,i=s+(o<<17&4294967295|o>>>15),o=e+(t^i&(s^t))+r[11]+2304563134&4294967295,e=i+(o<<22&4294967295|o>>>10),o=t+(s^e&(i^s))+r[12]+1804603682&4294967295,t=e+(o<<7&4294967295|o>>>25),o=s+(i^t&(e^i))+r[13]+4254626195&4294967295,s=t+(o<<12&4294967295|o>>>20),o=i+(e^s&(t^e))+r[14]+2792965006&4294967295,i=s+(o<<17&4294967295|o>>>15),o=e+(t^i&(s^t))+r[15]+1236535329&4294967295,e=i+(o<<22&4294967295|o>>>10),o=t+(i^s&(e^i))+r[1]+4129170786&4294967295,t=e+(o<<5&4294967295|o>>>27),o=s+(e^i&(t^e))+r[6]+3225465664&4294967295,s=t+(o<<9&4294967295|o>>>23),o=i+(t^e&(s^t))+r[11]+643717713&4294967295,i=s+(o<<14&4294967295|o>>>18),o=e+(s^t&(i^s))+r[0]+3921069994&4294967295,e=i+(o<<20&4294967295|o>>>12),o=t+(i^s&(e^i))+r[5]+3593408605&4294967295,t=e+(o<<5&4294967295|o>>>27),o=s+(e^i&(t^e))+r[10]+38016083&4294967295,s=t+(o<<9&4294967295|o>>>23),o=i+(t^e&(s^t))+r[15]+3634488961&4294967295,i=s+(o<<14&4294967295|o>>>18),o=e+(s^t&(i^s))+r[4]+3889429448&4294967295,e=i+(o<<20&4294967295|o>>>12),o=t+(i^s&(e^i))+r[9]+568446438&4294967295,t=e+(o<<5&4294967295|o>>>27),o=s+(e^i&(t^e))+r[14]+3275163606&4294967295,s=t+(o<<9&4294967295|o>>>23),o=i+(t^e&(s^t))+r[3]+4107603335&4294967295,i=s+(o<<14&4294967295|o>>>18),o=e+(s^t&(i^s))+r[8]+1163531501&4294967295,e=i+(o<<20&4294967295|o>>>12),o=t+(i^s&(e^i))+r[13]+2850285829&4294967295,t=e+(o<<5&4294967295|o>>>27),o=s+(e^i&(t^e))+r[2]+4243563512&4294967295,s=t+(o<<9&4294967295|o>>>23),o=i+(t^e&(s^t))+r[7]+1735328473&4294967295,i=s+(o<<14&4294967295|o>>>18),o=e+(s^t&(i^s))+r[12]+2368359562&4294967295,e=i+(o<<20&4294967295|o>>>12),o=t+(e^i^s)+r[5]+4294588738&4294967295,t=e+(o<<4&4294967295|o>>>28),o=s+(t^e^i)+r[8]+2272392833&4294967295,s=t+(o<<11&4294967295|o>>>21),o=i+(s^t^e)+r[11]+1839030562&4294967295,i=s+(o<<16&4294967295|o>>>16),o=e+(i^s^t)+r[14]+4259657740&4294967295,e=i+(o<<23&4294967295|o>>>9),o=t+(e^i^s)+r[1]+2763975236&4294967295,t=e+(o<<4&4294967295|o>>>28),o=s+(t^e^i)+r[4]+1272893353&4294967295,s=t+(o<<11&4294967295|o>>>21),o=i+(s^t^e)+r[7]+4139469664&4294967295,i=s+(o<<16&4294967295|o>>>16),o=e+(i^s^t)+r[10]+3200236656&4294967295,e=i+(o<<23&4294967295|o>>>9),o=t+(e^i^s)+r[13]+681279174&4294967295,t=e+(o<<4&4294967295|o>>>28),o=s+(t^e^i)+r[0]+3936430074&4294967295,s=t+(o<<11&4294967295|o>>>21),o=i+(s^t^e)+r[3]+3572445317&4294967295,i=s+(o<<16&4294967295|o>>>16),o=e+(i^s^t)+r[6]+76029189&4294967295,e=i+(o<<23&4294967295|o>>>9),o=t+(e^i^s)+r[9]+3654602809&4294967295,t=e+(o<<4&4294967295|o>>>28),o=s+(t^e^i)+r[12]+3873151461&4294967295,s=t+(o<<11&4294967295|o>>>21),o=i+(s^t^e)+r[15]+530742520&4294967295,i=s+(o<<16&4294967295|o>>>16),o=e+(i^s^t)+r[2]+3299628645&4294967295,e=i+(o<<23&4294967295|o>>>9),o=t+(i^(e|~s))+r[0]+4096336452&4294967295,t=e+(o<<6&4294967295|o>>>26),o=s+(e^(t|~i))+r[7]+1126891415&4294967295,s=t+(o<<10&4294967295|o>>>22),o=i+(t^(s|~e))+r[14]+2878612391&4294967295,i=s+(o<<15&4294967295|o>>>17),o=e+(s^(i|~t))+r[5]+4237533241&4294967295,e=i+(o<<21&4294967295|o>>>11),o=t+(i^(e|~s))+r[12]+1700485571&4294967295,t=e+(o<<6&4294967295|o>>>26),o=s+(e^(t|~i))+r[3]+2399980690&4294967295,s=t+(o<<10&4294967295|o>>>22),o=i+(t^(s|~e))+r[10]+4293915773&4294967295,i=s+(o<<15&4294967295|o>>>17),o=e+(s^(i|~t))+r[1]+2240044497&4294967295,e=i+(o<<21&4294967295|o>>>11),o=t+(i^(e|~s))+r[8]+1873313359&4294967295,t=e+(o<<6&4294967295|o>>>26),o=s+(e^(t|~i))+r[15]+4264355552&4294967295,s=t+(o<<10&4294967295|o>>>22),o=i+(t^(s|~e))+r[6]+2734768916&4294967295,i=s+(o<<15&4294967295|o>>>17),o=e+(s^(i|~t))+r[13]+1309151649&4294967295,e=i+(o<<21&4294967295|o>>>11),o=t+(i^(e|~s))+r[4]+4149444226&4294967295,t=e+(o<<6&4294967295|o>>>26),o=s+(e^(t|~i))+r[11]+3174756917&4294967295,s=t+(o<<10&4294967295|o>>>22),o=i+(t^(s|~e))+r[2]+718787259&4294967295,i=s+(o<<15&4294967295|o>>>17),o=e+(s^(i|~t))+r[9]+3951481745&4294967295,n.g[0]=n.g[0]+t&4294967295,n.g[1]=n.g[1]+(i+(o<<21&4294967295|o>>>11))&4294967295,n.g[2]=n.g[2]+i&4294967295,n.g[3]=n.g[3]+s&4294967295}Ot.prototype.j=function(n,t){t===void 0&&(t=n.length);for(var e=t-this.blockSize,r=this.m,i=this.h,s=0;s<t;){if(i==0)for(;s<=e;)Mo(this,n,s),s+=this.blockSize;if(typeof n=="string"){for(;s<t;)if(r[i++]=n.charCodeAt(s++),i==this.blockSize){Mo(this,r),i=0;break}}else for(;s<t;)if(r[i++]=n[s++],i==this.blockSize){Mo(this,r),i=0;break}}this.h=i,this.i+=t};Ot.prototype.l=function(){var n=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);n[0]=128;for(var t=1;t<n.length-8;++t)n[t]=0;var e=8*this.i;for(t=n.length-8;t<n.length;++t)n[t]=e&255,e/=256;for(this.j(n),n=Array(16),t=e=0;4>t;++t)for(var r=0;32>r;r+=8)n[e++]=this.g[t]>>>r&255;return n};function U(n,t){this.h=t;for(var e=[],r=!0,i=n.length-1;0<=i;i--){var s=n[i]|0;r&&s==t||(e[i]=s,r=!1)}this.g=e}var jp={};function va(n){return-128<=n&&128>n?ep(n,function(t){return new U([t|0],0>t?-1:0)}):new U([n|0],0>n?-1:0)}function Qt(n){if(isNaN(n)||!isFinite(n))return vn;if(0>n)return mt(Qt(-n));for(var t=[],e=1,r=0;n>=e;r++)t[r]=n/e|0,e*=Jo;return new U(t,0)}function ad(n,t){if(n.length==0)throw Error("number format error: empty string");if(t=t||10,2>t||36<t)throw Error("radix out of range: "+t);if(n.charAt(0)=="-")return mt(ad(n.substring(1),t));if(0<=n.indexOf("-"))throw Error('number format error: interior "-" character');for(var e=Qt(Math.pow(t,8)),r=vn,i=0;i<n.length;i+=8){var s=Math.min(8,n.length-i),o=parseInt(n.substring(i,i+s),t);8>s?(s=Qt(Math.pow(t,s)),r=r.R(s).add(Qt(o))):(r=r.R(e),r=r.add(Qt(o)))}return r}var Jo=4294967296,vn=va(0),Xo=va(1),rh=va(16777216);T=U.prototype;T.ea=function(){if(Dt(this))return-mt(this).ea();for(var n=0,t=1,e=0;e<this.g.length;e++){var r=this.D(e);n+=(0<=r?r:Jo+r)*t,t*=Jo}return n};T.toString=function(n){if(n=n||10,2>n||36<n)throw Error("radix out of range: "+n);if(ie(this))return"0";if(Dt(this))return"-"+mt(this).toString(n);for(var t=Qt(Math.pow(n,6)),e=this,r="";;){var i=Bi(e,t).g;e=qi(e,i.R(t));var s=((0<e.g.length?e.g[0]:e.h)>>>0).toString(n);if(e=i,ie(e))return s+r;for(;6>s.length;)s="0"+s;r=s+r}};T.D=function(n){return 0>n?0:n<this.g.length?this.g[n]:this.h};function ie(n){if(n.h!=0)return!1;for(var t=0;t<n.g.length;t++)if(n.g[t]!=0)return!1;return!0}function Dt(n){return n.h==-1}T.X=function(n){return n=qi(this,n),Dt(n)?-1:ie(n)?0:1};function mt(n){for(var t=n.g.length,e=[],r=0;r<t;r++)e[r]=~n.g[r];return new U(e,~n.h).add(Xo)}T.abs=function(){return Dt(this)?mt(this):this};T.add=function(n){for(var t=Math.max(this.g.length,n.g.length),e=[],r=0,i=0;i<=t;i++){var s=r+(this.D(i)&65535)+(n.D(i)&65535),o=(s>>>16)+(this.D(i)>>>16)+(n.D(i)>>>16);r=o>>>16,s&=65535,o&=65535,e[i]=o<<16|s}return new U(e,e[e.length-1]&-2147483648?-1:0)};function qi(n,t){return n.add(mt(t))}T.R=function(n){if(ie(this)||ie(n))return vn;if(Dt(this))return Dt(n)?mt(this).R(mt(n)):mt(mt(this).R(n));if(Dt(n))return mt(this.R(mt(n)));if(0>this.X(rh)&&0>n.X(rh))return Qt(this.ea()*n.ea());for(var t=this.g.length+n.g.length,e=[],r=0;r<2*t;r++)e[r]=0;for(r=0;r<this.g.length;r++)for(var i=0;i<n.g.length;i++){var s=this.D(r)>>>16,o=this.D(r)&65535,a=n.D(i)>>>16,u=n.D(i)&65535;e[2*r+2*i]+=o*u,ki(e,2*r+2*i),e[2*r+2*i+1]+=s*u,ki(e,2*r+2*i+1),e[2*r+2*i+1]+=o*a,ki(e,2*r+2*i+1),e[2*r+2*i+2]+=s*a,ki(e,2*r+2*i+2)}for(r=0;r<t;r++)e[r]=e[2*r+1]<<16|e[2*r];for(r=t;r<2*t;r++)e[r]=0;return new U(e,0)};function ki(n,t){for(;(n[t]&65535)!=n[t];)n[t+1]+=n[t]>>>16,n[t]&=65535,t++}function mr(n,t){this.g=n,this.h=t}function Bi(n,t){if(ie(t))throw Error("division by zero");if(ie(n))return new mr(vn,vn);if(Dt(n))return t=Bi(mt(n),t),new mr(mt(t.g),mt(t.h));if(Dt(t))return t=Bi(n,mt(t)),new mr(mt(t.g),t.h);if(30<n.g.length){if(Dt(n)||Dt(t))throw Error("slowDivide_ only works with positive integers.");for(var e=Xo,r=t;0>=r.X(n);)e=ih(e),r=ih(r);var i=yn(e,1),s=yn(r,1);for(r=yn(r,2),e=yn(e,2);!ie(r);){var o=s.add(r);0>=o.X(n)&&(i=i.add(e),s=o),r=yn(r,1),e=yn(e,1)}return t=qi(n,i.R(t)),new mr(i,t)}for(i=vn;0<=n.X(t);){for(e=Math.max(1,Math.floor(n.ea()/t.ea())),r=Math.ceil(Math.log(e)/Math.LN2),r=48>=r?1:Math.pow(2,r-48),s=Qt(e),o=s.R(t);Dt(o)||0<o.X(n);)e-=r,s=Qt(e),o=s.R(t);ie(s)&&(s=Xo),i=i.add(s),n=qi(n,o)}return new mr(i,n)}T.gb=function(n){return Bi(this,n).h};T.and=function(n){for(var t=Math.max(this.g.length,n.g.length),e=[],r=0;r<t;r++)e[r]=this.D(r)&n.D(r);return new U(e,this.h&n.h)};T.or=function(n){for(var t=Math.max(this.g.length,n.g.length),e=[],r=0;r<t;r++)e[r]=this.D(r)|n.D(r);return new U(e,this.h|n.h)};T.xor=function(n){for(var t=Math.max(this.g.length,n.g.length),e=[],r=0;r<t;r++)e[r]=this.D(r)^n.D(r);return new U(e,this.h^n.h)};function ih(n){for(var t=n.g.length+1,e=[],r=0;r<t;r++)e[r]=n.D(r)<<1|n.D(r-1)>>>31;return new U(e,n.h)}function yn(n,t){var e=t>>5;t%=32;for(var r=n.g.length-e,i=[],s=0;s<r;s++)i[s]=0<t?n.D(s+e)>>>t|n.D(s+e+1)<<32-t:n.D(s+e);return new U(i,n.h)}Li.prototype.createWebChannel=Li.prototype.g;Pt.prototype.send=Pt.prototype.u;Pt.prototype.open=Pt.prototype.m;Pt.prototype.close=Pt.prototype.close;Wi.NO_ERROR=0;Wi.TIMEOUT=8;Wi.HTTP_ERROR=6;Ah.COMPLETE="complete";Sh.EventType=br;br.OPEN="a";br.CLOSE="b";br.ERROR="c";br.MESSAGE="d";lt.prototype.listen=lt.prototype.O;J.prototype.listenOnce=J.prototype.P;J.prototype.getLastError=J.prototype.Sa;J.prototype.getLastErrorCode=J.prototype.Ia;J.prototype.getStatus=J.prototype.da;J.prototype.getResponseJson=J.prototype.Wa;J.prototype.getResponseText=J.prototype.ja;J.prototype.send=J.prototype.ha;J.prototype.setWithCredentials=J.prototype.Oa;Ot.prototype.digest=Ot.prototype.l;Ot.prototype.reset=Ot.prototype.reset;Ot.prototype.update=Ot.prototype.j;U.prototype.add=U.prototype.add;U.prototype.multiply=U.prototype.R;U.prototype.modulo=U.prototype.gb;U.prototype.compare=U.prototype.X;U.prototype.toNumber=U.prototype.ea;U.prototype.toString=U.prototype.toString;U.prototype.getBits=U.prototype.D;U.fromNumber=Qt;U.fromString=ad;var ud=Lt.createWebChannelTransport=function(){return new Li},cd=Lt.getStatEventTarget=function(){return Qi()},ns=Lt.ErrorCode=Wi,ld=Lt.EventType=Ah,hd=Lt.Event=Be,Ia=Lt.Stat={xb:0,Ab:1,Bb:2,Ub:3,Zb:4,Wb:5,Xb:6,Vb:7,Tb:8,Yb:9,PROXY:10,NOPROXY:11,Rb:12,Nb:13,Ob:14,Mb:15,Pb:16,Qb:17,tb:18,sb:19,ub:20},rw=Lt.FetchXmlHttpFactory=Dr,Fr=Lt.WebChannel=Sh,dd=Lt.XhrIo=J,fd=Lt.Md5=Ot,Ue=Lt.Integer=U;var md="@firebase/firestore";var ot=class{constructor(t){this.uid=t}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}};ot.UNAUTHENTICATED=new ot(null),ot.GOOGLE_CREDENTIALS=new ot("google-credentials-uid"),ot.FIRST_PARTY=new ot("first-party-uid"),ot.MOCK_USER=new ot("mock-user");var tr="10.11.0";var Se=new xl("@firebase/firestore");function Cn(){return Se.logLevel}function gf(n){Se.setLogLevel(n)}function y(n,...t){if(Se.logLevel<=zt.DEBUG){let e=t.map(Ac);Se.debug(`Firestore (${tr}): ${n}`,...e)}}function tt(n,...t){if(Se.logLevel<=zt.ERROR){let e=t.map(Ac);Se.error(`Firestore (${tr}): ${n}`,...e)}}function kt(n,...t){if(Se.logLevel<=zt.WARN){let e=t.map(Ac);Se.warn(`Firestore (${tr}): ${n}`,...e)}}function Ac(n){if(typeof n=="string")return n;try{return function(e){return JSON.stringify(e)}(n)}catch{return n}}function S(n="Unexpected state"){let t=`FIRESTORE (${tr}) INTERNAL ASSERTION FAILED: `+n;throw tt(t),new Error(t)}function R(n,t){n||S()}function pf(n,t){n||S()}function E(n,t){return n}var g={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},_=class extends bl{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}};var at=class{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}};var fs=class{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}},Ra=class{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(ot.UNAUTHENTICATED))}shutdown(){}},Pa=class{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable(()=>e(this.token.user))}shutdown(){this.changeListener=null}},Ca=class{constructor(t){this.t=t,this.currentUser=ot.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let r=this.i,i=u=>this.i!==r?(r=this.i,e(u)):Promise.resolve(),s=new at;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new at,t.enqueueRetryable(()=>i(this.currentUser))};let o=()=>{let u=s;t.enqueueRetryable(()=>p(this,null,function*(){yield u.promise,yield i(this.currentUser)}))},a=u=>{y("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=u,this.auth.addAuthTokenListener(this.o),o()};this.t.onInit(u=>a(u)),setTimeout(()=>{if(!this.auth){let u=this.t.getImmediate({optional:!0});u?a(u):(y("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new at)}},0),o()}getToken(){let t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(r=>this.i!==t?(y("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):r?(R(typeof r.accessToken=="string"),new fs(r.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){let t=this.auth&&this.auth.getUid();return R(t===null||typeof t=="string"),new ot(t)}},ba=class{constructor(t,e,r){this.l=t,this.h=e,this.P=r,this.type="FirstParty",this.user=ot.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);let t=this.T();return t&&this.I.set("Authorization",t),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}},xa=class{constructor(t,e,r){this.l=t,this.h=e,this.P=r}getToken(){return Promise.resolve(new ba(this.l,this.h,this.P))}start(t,e){t.enqueueRetryable(()=>e(ot.FIRST_PARTY))}shutdown(){}invalidateToken(){}},Va=class{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}},Da=class{constructor(t){this.A=t,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,e){let r=s=>{s.error!=null&&y("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${s.error.message}`);let o=s.token!==this.R;return this.R=s.token,y("FirebaseAppCheckTokenProvider",`Received ${o?"new":"existing"} token.`),o?e(s.token):Promise.resolve()};this.o=s=>{t.enqueueRetryable(()=>r(s))};let i=s=>{y("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=s,this.appCheck.addTokenListener(this.o)};this.A.onInit(s=>i(s)),setTimeout(()=>{if(!this.appCheck){let s=this.A.getImmediate({optional:!0});s?i(s):y("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){let t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then(e=>e?(R(typeof e.token=="string"),this.R=e.token,new Va(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}};function zp(n){let t=typeof self<"u"&&(self.crypto||self.msCrypto),e=new Uint8Array(n);if(t&&typeof t.getRandomValues=="function")t.getRandomValues(e);else for(let r=0;r<n;r++)e[r]=Math.floor(256*Math.random());return e}var ms=class{static newId(){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length,r="";for(;r.length<20;){let i=zp(40);for(let s=0;s<i.length;++s)r.length<20&&i[s]<e&&(r+=t.charAt(i[s]%t.length))}return r}};function V(n,t){return n<t?-1:n>t?1:0}function On(n,t,e){return n.length===t.length&&n.every((r,i)=>e(r,t[i]))}function _f(n){return n+"\0"}var W=class n{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new _(g.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new _(g.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new _(g.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new _(g.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return n.fromMillis(Date.now())}static fromDate(t){return n.fromMillis(t.getTime())}static fromMillis(t){let e=Math.floor(t/1e3),r=Math.floor(1e6*(t-1e3*e));return new n(e,r)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?V(this.nanoseconds,t.nanoseconds):V(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){let t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}};var P=class n{constructor(t){this.timestamp=t}static fromTimestamp(t){return new n(t)}static min(){return new n(new W(0,0))}static max(){return new n(new W(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}};var gs=class n{constructor(t,e,r){e===void 0?e=0:e>t.length&&S(),r===void 0?r=t.length-e:r>t.length-e&&S(),this.segments=t,this.offset=e,this.len=r}get length(){return this.len}isEqual(t){return n.comparator(this,t)===0}child(t){let e=this.segments.slice(this.offset,this.limit());return t instanceof n?t.forEach(r=>{e.push(r)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=t===void 0?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return this.length===0}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,r=this.limit();e<r;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){let r=Math.min(t.length,e.length);for(let i=0;i<r;i++){let s=t.get(i),o=e.get(i);if(s<o)return-1;if(s>o)return 1}return t.length<e.length?-1:t.length>e.length?1:0}},M=class n extends gs{construct(t,e,r){return new n(t,e,r)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...t){let e=[];for(let r of t){if(r.indexOf("//")>=0)throw new _(g.INVALID_ARGUMENT,`Invalid segment (${r}). Paths must not contain // in them.`);e.push(...r.split("/").filter(i=>i.length>0))}return new n(e)}static emptyPath(){return new n([])}},Kp=/^[_a-zA-Z][_a-zA-Z0-9]*$/,et=class n extends gs{construct(t,e,r){return new n(t,e,r)}static isValidIdentifier(t){return Kp.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),n.isValidIdentifier(t)||(t="`"+t+"`"),t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)==="__name__"}static keyField(){return new n(["__name__"])}static fromServerFormat(t){let e=[],r="",i=0,s=()=>{if(r.length===0)throw new _(g.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(r),r=""},o=!1;for(;i<t.length;){let a=t[i];if(a==="\\"){if(i+1===t.length)throw new _(g.INVALID_ARGUMENT,"Path has trailing escape character: "+t);let u=t[i+1];if(u!=="\\"&&u!=="."&&u!=="`")throw new _(g.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);r+=u,i+=2}else a==="`"?(o=!o,i++):a!=="."||o?(r+=a,i++):(s(),i++)}if(s(),o)throw new _(g.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new n(e)}static emptyPath(){return new n([])}};var I=class n{constructor(t){this.path=t}static fromPath(t){return new n(M.fromString(t))}static fromName(t){return new n(M.fromString(t).popFirst(5))}static empty(){return new n(M.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return t!==null&&M.comparator(this.path,t.path)===0}toString(){return this.path.toString()}static comparator(t,e){return M.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new n(new M(t.slice()))}};var Ln=class{constructor(t,e,r,i){this.indexId=t,this.collectionGroup=e,this.fields=r,this.indexState=i}};function Na(n){return n.fields.find(t=>t.kind===2)}function je(n){return n.fields.filter(t=>t.kind!==2)}Ln.UNKNOWN_ID=-1;var kn=class{constructor(t,e){this.fieldPath=t,this.kind=e}};var Qr=class n{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new n(0,Ft.min())}};function yf(n,t){let e=n.toTimestamp().seconds,r=n.toTimestamp().nanoseconds+1,i=P.fromTimestamp(r===1e9?new W(e+1,0):new W(e,r));return new Ft(i,I.empty(),t)}function wf(n){return new Ft(n.readTime,n.key,-1)}var Ft=class n{constructor(t,e,r){this.readTime=t,this.documentKey=e,this.largestBatchId=r}static min(){return new n(P.min(),I.empty(),-1)}static max(){return new n(P.max(),I.empty(),-1)}};function Sc(n,t){let e=n.readTime.compareTo(t.readTime);return e!==0?e:(e=I.comparator(n.documentKey,t.documentKey),e!==0?e:V(n.largestBatchId,t.largestBatchId))}var vf="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",ps=class{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}};function ke(n){return p(this,null,function*(){if(n.code!==g.FAILED_PRECONDITION||n.message!==vf)throw n;y("LocalStore","Unexpectedly lost primary lease")})}var f=class n{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&S(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new n((r,i)=>{this.nextCallback=s=>{this.wrapSuccess(t,s).next(r,i)},this.catchCallback=s=>{this.wrapFailure(e,s).next(r,i)}})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{let e=t();return e instanceof n?e:n.resolve(e)}catch(e){return n.reject(e)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):n.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):n.reject(e)}static resolve(t){return new n((e,r)=>{e(t)})}static reject(t){return new n((e,r)=>{r(t)})}static waitFor(t){return new n((e,r)=>{let i=0,s=0,o=!1;t.forEach(a=>{++i,a.next(()=>{++s,o&&s===i&&e()},u=>r(u))}),o=!0,s===i&&e()})}static or(t){let e=n.resolve(!1);for(let r of t)e=e.next(i=>i?n.resolve(i):r());return e}static forEach(t,e){let r=[];return t.forEach((i,s)=>{r.push(e.call(this,i,s))}),this.waitFor(r)}static mapArray(t,e){return new n((r,i)=>{let s=t.length,o=new Array(s),a=0;for(let u=0;u<s;u++){let c=u;e(t[c]).next(l=>{o[c]=l,++a,a===s&&r(o)},l=>i(l))}})}static doWhile(t,e){return new n((r,i)=>{let s=()=>{t()===!0?e().next(()=>{s()},i):r()};s()})}};var _s=class n{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.V=new at,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{e.error?this.V.reject(new He(t,e.error)):this.V.resolve()},this.transaction.onerror=r=>{let i=Rc(r.target.error);this.V.reject(new He(t,i))}}static open(t,e,r,i){try{return new n(e,t.transaction(i,r))}catch(s){throw new He(e,s)}}get m(){return this.V.promise}abort(t){t&&this.V.reject(t),this.aborted||(y("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){let t=this.transaction;this.aborted||typeof t.commit!="function"||t.commit()}store(t){let e=this.transaction.objectStore(t);return new Fa(e)}},ue=class n{constructor(t,e,r){this.name=t,this.version=e,this.p=r,n.S(dr())===12.2&&tt("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return y("SimpleDb","Removing database:",t),ze(window.indexedDB.deleteDatabase(t)).toPromise()}static D(){if(!Cl())return!1;if(n.C())return!0;let t=dr(),e=n.S(t),r=0<e&&e<10,i=n.v(t),s=0<i&&i<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||r||s)}static C(){var t;return typeof process<"u"&&((t=process.__PRIVATE_env)===null||t===void 0?void 0:t.F)==="YES"}static M(t,e){return t.store(e)}static S(t){let e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),r=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(r)}static v(t){let e=t.match(/Android ([\d.]+)/i),r=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(r)}O(t){return p(this,null,function*(){return this.db||(y("SimpleDb","Opening database:",this.name),this.db=yield new Promise((e,r)=>{let i=indexedDB.open(this.name,this.version);i.onsuccess=s=>{let o=s.target.result;e(o)},i.onblocked=()=>{r(new He(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=s=>{let o=s.target.error;o.name==="VersionError"?r(new _(g.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):o.name==="InvalidStateError"?r(new _(g.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+o)):r(new He(t,o))},i.onupgradeneeded=s=>{y("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',s.oldVersion);let o=s.target.result;this.p.N(o,i.transaction,s.oldVersion,this.version).next(()=>{y("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.L&&(this.db.onversionchange=e=>this.L(e)),this.db})}B(t){this.L=t,this.db&&(this.db.onversionchange=e=>t(e))}runTransaction(t,e,r,i){return p(this,null,function*(){let s=e==="readonly",o=0;for(;;){++o;try{this.db=yield this.O(t);let a=_s.open(this.db,t,s?"readonly":"readwrite",r),u=i(a).next(c=>(a.g(),c)).catch(c=>(a.abort(c),f.reject(c))).toPromise();return u.catch(()=>{}),yield a.m,u}catch(a){let u=a,c=u.name!=="FirebaseError"&&o<3;if(y("SimpleDb","Transaction failed with error:",u.message,"Retrying:",c),this.close(),!c)return Promise.reject(u)}}})}close(){this.db&&this.db.close(),this.db=void 0}},ka=class{constructor(t){this.k=t,this.q=!1,this.K=null}get isDone(){return this.q}get $(){return this.K}set cursor(t){this.k=t}done(){this.q=!0}U(t){this.K=t}delete(){return ze(this.k.delete())}},He=class extends _{constructor(t,e){super(g.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}};function Fe(n){return n.name==="IndexedDbTransactionError"}var Fa=class{constructor(t){this.store=t}put(t,e){let r;return e!==void 0?(y("SimpleDb","PUT",this.store.name,t,e),r=this.store.put(e,t)):(y("SimpleDb","PUT",this.store.name,"<auto-key>",t),r=this.store.put(t)),ze(r)}add(t){return y("SimpleDb","ADD",this.store.name,t,t),ze(this.store.add(t))}get(t){return ze(this.store.get(t)).next(e=>(e===void 0&&(e=null),y("SimpleDb","GET",this.store.name,t,e),e))}delete(t){return y("SimpleDb","DELETE",this.store.name,t),ze(this.store.delete(t))}count(){return y("SimpleDb","COUNT",this.store.name),ze(this.store.count())}W(t,e){let r=this.options(t,e),i=r.index?this.store.index(r.index):this.store;if(typeof i.getAll=="function"){let s=i.getAll(r.range);return new f((o,a)=>{s.onerror=u=>{a(u.target.error)},s.onsuccess=u=>{o(u.target.result)}})}{let s=this.cursor(r),o=[];return this.G(s,(a,u)=>{o.push(u)}).next(()=>o)}}j(t,e){let r=this.store.getAll(t,e===null?void 0:e);return new f((i,s)=>{r.onerror=o=>{s(o.target.error)},r.onsuccess=o=>{i(o.target.result)}})}H(t,e){y("SimpleDb","DELETE ALL",this.store.name);let r=this.options(t,e);r.J=!1;let i=this.cursor(r);return this.G(i,(s,o,a)=>a.delete())}Y(t,e){let r;e?r=t:(r={},e=t);let i=this.cursor(r);return this.G(i,e)}Z(t){let e=this.cursor({});return new f((r,i)=>{e.onerror=s=>{let o=Rc(s.target.error);i(o)},e.onsuccess=s=>{let o=s.target.result;o?t(o.primaryKey,o.value).next(a=>{a?o.continue():r()}):r()}})}G(t,e){let r=[];return new f((i,s)=>{t.onerror=o=>{s(o.target.error)},t.onsuccess=o=>{let a=o.target.result;if(!a)return void i();let u=new ka(a),c=e(a.primaryKey,a.value,u);if(c instanceof f){let l=c.catch(h=>(u.done(),f.reject(h)));r.push(l)}u.isDone?i():u.$===null?a.continue():a.continue(u.$)}}).next(()=>f.waitFor(r))}options(t,e){let r;return t!==void 0&&(typeof t=="string"?r=t:e=t),{index:r,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){let r=this.store.index(t.index);return t.J?r.openKeyCursor(t.range,e):r.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}};function ze(n){return new f((t,e)=>{n.onsuccess=r=>{let i=r.target.result;t(i)},n.onerror=r=>{let i=Rc(r.target.error);e(i)}})}var gd=!1;function Rc(n){let t=ue.S(dr());if(t>=12.2&&t<13){let e="An internal error was encountered in the Indexed Database server";if(n.message.indexOf(e)>=0){let r=new _("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return gd||(gd=!0,setTimeout(()=>{throw r},0)),r}}return n}var Ma=class{constructor(t,e){this.asyncQueue=t,this.X=e,this.task=null}start(){this.ee(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return this.task!==null}ee(t){y("IndexBackfiller",`Scheduled in ${t}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",t,()=>p(this,null,function*(){this.task=null;try{y("IndexBackfiller",`Documents written: ${yield this.X.te()}`)}catch(e){Fe(e)?y("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",e):yield ke(e)}yield this.ee(6e4)}))}},Oa=class{constructor(t,e){this.localStore=t,this.persistence=e}te(t=50){return p(this,null,function*(){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.ne(e,t))})}ne(t,e){let r=new Set,i=e,s=!0;return f.doWhile(()=>s===!0&&i>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(t).next(o=>{if(o!==null&&!r.has(o))return y("IndexBackfiller",`Processing collection: ${o}`),this.re(t,o,i).next(a=>{i-=a,r.add(o)});s=!1})).next(()=>e-i)}re(t,e,r){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(t,e).next(i=>this.localStore.localDocuments.getNextDocuments(t,e,i,r).next(s=>{let o=s.changes;return this.localStore.indexManager.updateIndexEntries(t,o).next(()=>this.ie(i,s)).next(a=>(y("IndexBackfiller",`Updating offset: ${a}`),this.localStore.indexManager.updateCollectionGroup(t,e,a))).next(()=>o.size)}))}ie(t,e){let r=t;return e.changes.forEach((i,s)=>{let o=wf(s);Sc(o,r)>0&&(r=o)}),new Ft(r.readTime,r.documentKey,Math.max(e.batchId,t.largestBatchId))}};var Ct=(()=>{class n{constructor(e,r){this.previousValue=e,r&&(r.sequenceNumberHandler=i=>this.se(i),this.oe=i=>r.writeSequenceNumber(i))}se(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this.oe&&this.oe(e),e}}return n._e=-1,n})();function gi(n){return n==null}function Wr(n){return n===0&&1/n==-1/0}function If(n){return typeof n=="number"&&Number.isInteger(n)&&!Wr(n)&&n<=Number.MAX_SAFE_INTEGER&&n>=Number.MIN_SAFE_INTEGER}function Tt(n){let t="";for(let e=0;e<n.length;e++)t.length>0&&(t=pd(t)),t=$p(n.get(e),t);return pd(t)}function $p(n,t){let e=t,r=n.length;for(let i=0;i<r;i++){let s=n.charAt(i);switch(s){case"\0":e+="";break;case"":e+="";break;default:e+=s}}return e}function pd(n){return n+""}function Wt(n){let t=n.length;if(R(t>=2),t===2)return R(n.charAt(0)===""&&n.charAt(1)===""),M.emptyPath();let e=t-2,r=[],i="";for(let s=0;s<t;){let o=n.indexOf("",s);switch((o<0||o>e)&&S(),n.charAt(o+1)){case"":let a=n.substring(s,o),u;i.length===0?u=a:(i+=a,u=i,i=""),r.push(u);break;case"":i+=n.substring(s,o),i+="\0";break;case"":i+=n.substring(s,o+1);break;default:S()}s=o+2}return new M(r)}var _d=["userId","batchId"];function as(n,t){return[n,Tt(t)]}function Ef(n,t,e){return[n,Tt(t),e]}var Qp={},Wp=["prefixPath","collectionGroup","readTime","documentId"],Hp=["prefixPath","collectionGroup","documentId"],Yp=["collectionGroup","readTime","prefixPath","documentId"],Jp=["canonicalId","targetId"],Xp=["targetId","path"],Zp=["path","targetId"],t_=["collectionId","parent"],e_=["indexId","uid"],n_=["uid","sequenceNumber"],r_=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],i_=["indexId","uid","orderedDocumentKey"],s_=["userId","collectionPath","documentId"],o_=["userId","collectionPath","largestBatchId"],a_=["userId","collectionGroup","largestBatchId"],Tf=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],u_=[...Tf,"documentOverlays"],Af=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Sf=Af,Rf=[...Sf,"indexConfiguration","indexState","indexEntries"],c_=Rf;var Hr=class extends ps{constructor(t,e){super(),this.ae=t,this.currentSequenceNumber=e}};function ft(n,t){let e=E(n);return ue.M(e.ae,t)}function yd(n){let t=0;for(let e in n)Object.prototype.hasOwnProperty.call(n,e)&&t++;return t}function un(n,t){for(let e in n)Object.prototype.hasOwnProperty.call(n,e)&&t(e,n[e])}function Pf(n){for(let t in n)if(Object.prototype.hasOwnProperty.call(n,t))return!1;return!0}var $=class n{constructor(t,e){this.comparator=t,this.root=e||Yt.EMPTY}insert(t,e){return new n(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Yt.BLACK,null,null))}remove(t){return new n(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Yt.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){let r=this.comparator(t,e.key);if(r===0)return e.value;r<0?e=e.left:r>0&&(e=e.right)}return null}indexOf(t){let e=0,r=this.root;for(;!r.isEmpty();){let i=this.comparator(t,r.key);if(i===0)return e+r.left.size;i<0?r=r.left:(e+=r.left.size+1,r=r.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal((e,r)=>(t(e,r),!1))}toString(){let t=[];return this.inorderTraversal((e,r)=>(t.push(`${e}:${r}`),!1)),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new Nn(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new Nn(this.root,t,this.comparator,!1)}getReverseIterator(){return new Nn(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new Nn(this.root,t,this.comparator,!0)}},Nn=class{constructor(t,e,r,i){this.isReverse=i,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?r(t.key,e):1,e&&i&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(s===0){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop(),e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;let t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}},Yt=class n{constructor(t,e,r,i,s){this.key=t,this.value=e,this.color=r??n.RED,this.left=i??n.EMPTY,this.right=s??n.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,r,i,s){return new n(t??this.key,e??this.value,r??this.color,i??this.left,s??this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,r){let i=this,s=r(t,i.key);return i=s<0?i.copy(null,null,null,i.left.insert(t,e,r),null):s===0?i.copy(null,e,null,null,null):i.copy(null,null,null,null,i.right.insert(t,e,r)),i.fixUp()}removeMin(){if(this.left.isEmpty())return n.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let r,i=this;if(e(t,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(t,e),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),e(t,i.key)===0){if(i.right.isEmpty())return n.EMPTY;r=i.right.min(),i=i.copy(r.key,r.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(t,e))}return i.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){let t=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){let t=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){let t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){let t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw S();let t=this.left.check();if(t!==this.right.check())throw S();return t+(this.isRed()?0:1)}};Yt.EMPTY=null,Yt.RED=!0,Yt.BLACK=!1;Yt.EMPTY=new class{constructor(){this.size=0}get key(){throw S()}get value(){throw S()}get color(){throw S()}get left(){throw S()}get right(){throw S()}copy(t,e,r,i,s){return this}insert(t,e,r){return new Yt(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};var j=class n{constructor(t){this.comparator=t,this.data=new $(this.comparator)}has(t){return this.data.get(t)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal((e,r)=>(t(e),!1))}forEachInRange(t,e){let r=this.data.getIteratorFrom(t[0]);for(;r.hasNext();){let i=r.getNext();if(this.comparator(i.key,t[1])>=0)return;e(i.key)}}forEachWhile(t,e){let r;for(r=e!==void 0?this.data.getIteratorFrom(e):this.data.getIterator();r.hasNext();)if(!t(r.getNext().key))return}firstAfterOrEqual(t){let e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new ys(this.data.getIterator())}getIteratorFrom(t){return new ys(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(r=>{e=e.add(r)}),e}isEqual(t){if(!(t instanceof n)||this.size!==t.size)return!1;let e=this.data.getIterator(),r=t.data.getIterator();for(;e.hasNext();){let i=e.getNext().key,s=r.getNext().key;if(this.comparator(i,s)!==0)return!1}return!0}toArray(){let t=[];return this.forEach(e=>{t.push(e)}),t}toString(){let t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(t){let e=new n(this.comparator);return e.data=t,e}},ys=class{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}};function An(n){return n.hasNext()?n.getNext():void 0}var bt=class n{constructor(t){this.fields=t,t.sort(et.comparator)}static empty(){return new n([])}unionWith(t){let e=new j(et.comparator);for(let r of this.fields)e=e.add(r);for(let r of t)e=e.add(r);return new n(e.toArray())}covers(t){for(let e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return On(this.fields,t.fields,(e,r)=>e.isEqual(r))}};var ws=class extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}};function Cf(){return typeof atob<"u"}var dt=class n{constructor(t){this.binaryString=t}static fromBase64String(t){let e=function(i){try{return atob(i)}catch(s){throw typeof DOMException<"u"&&s instanceof DOMException?new ws("Invalid base64 string: "+s):s}}(t);return new n(e)}static fromUint8Array(t){let e=function(i){let s="";for(let o=0;o<i.length;++o)s+=String.fromCharCode(i[o]);return s}(t);return new n(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(e){return btoa(e)}(this.binaryString)}toUint8Array(){return function(e){let r=new Uint8Array(e.length);for(let i=0;i<e.length;i++)r[i]=e.charCodeAt(i);return r}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return V(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}};dt.EMPTY_BYTE_STRING=new dt("");var l_=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ce(n){if(R(!!n),typeof n=="string"){let t=0,e=l_.exec(n);if(R(!!e),e[1]){let i=e[1];i=(i+"000000000").substr(0,9),t=Number(i)}let r=new Date(n);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:X(n.seconds),nanos:X(n.nanos)}}function X(n){return typeof n=="number"?n:typeof n=="string"?Number(n):0}function Re(n){return typeof n=="string"?dt.fromBase64String(n):dt.fromUint8Array(n)}function co(n){var t,e;return((e=(((t=n?.mapValue)===null||t===void 0?void 0:t.fields)||{}).__type__)===null||e===void 0?void 0:e.stringValue)==="server_timestamp"}function Pc(n){let t=n.mapValue.fields.__previous_value__;return co(t)?Pc(t):t}function Yr(n){let t=ce(n.mapValue.fields.__local_write_time__.timestampValue);return new W(t.seconds,t.nanos)}var La=class{constructor(t,e,r,i,s,o,a,u,c){this.databaseId=t,this.appId=e,this.persistenceKey=r,this.host=i,this.ssl=s,this.forceLongPolling=o,this.autoDetectLongPolling=a,this.longPollingOptions=u,this.useFetchStreams=c}},Pe=class n{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new n("","")}get isDefaultDatabase(){return this.database==="(default)"}isEqual(t){return t instanceof n&&t.projectId===this.projectId&&t.database===this.database}};var Te={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},us={nullValue:"NULL_VALUE"};function Ye(n){return"nullValue"in n?0:"booleanValue"in n?1:"integerValue"in n||"doubleValue"in n?2:"timestampValue"in n?3:"stringValue"in n?5:"bytesValue"in n?6:"referenceValue"in n?7:"geoPointValue"in n?8:"arrayValue"in n?9:"mapValue"in n?co(n)?4:bf(n)?9007199254740991:10:S()}function Zt(n,t){if(n===t)return!0;let e=Ye(n);if(e!==Ye(t))return!1;switch(e){case 0:case 9007199254740991:return!0;case 1:return n.booleanValue===t.booleanValue;case 4:return Yr(n).isEqual(Yr(t));case 3:return function(i,s){if(typeof i.timestampValue=="string"&&typeof s.timestampValue=="string"&&i.timestampValue.length===s.timestampValue.length)return i.timestampValue===s.timestampValue;let o=ce(i.timestampValue),a=ce(s.timestampValue);return o.seconds===a.seconds&&o.nanos===a.nanos}(n,t);case 5:return n.stringValue===t.stringValue;case 6:return function(i,s){return Re(i.bytesValue).isEqual(Re(s.bytesValue))}(n,t);case 7:return n.referenceValue===t.referenceValue;case 8:return function(i,s){return X(i.geoPointValue.latitude)===X(s.geoPointValue.latitude)&&X(i.geoPointValue.longitude)===X(s.geoPointValue.longitude)}(n,t);case 2:return function(i,s){if("integerValue"in i&&"integerValue"in s)return X(i.integerValue)===X(s.integerValue);if("doubleValue"in i&&"doubleValue"in s){let o=X(i.doubleValue),a=X(s.doubleValue);return o===a?Wr(o)===Wr(a):isNaN(o)&&isNaN(a)}return!1}(n,t);case 9:return On(n.arrayValue.values||[],t.arrayValue.values||[],Zt);case 10:return function(i,s){let o=i.mapValue.fields||{},a=s.mapValue.fields||{};if(yd(o)!==yd(a))return!1;for(let u in o)if(o.hasOwnProperty(u)&&(a[u]===void 0||!Zt(o[u],a[u])))return!1;return!0}(n,t);default:return S()}}function Jr(n,t){return(n.values||[]).find(e=>Zt(e,t))!==void 0}function Ce(n,t){if(n===t)return 0;let e=Ye(n),r=Ye(t);if(e!==r)return V(e,r);switch(e){case 0:case 9007199254740991:return 0;case 1:return V(n.booleanValue,t.booleanValue);case 2:return function(s,o){let a=X(s.integerValue||s.doubleValue),u=X(o.integerValue||o.doubleValue);return a<u?-1:a>u?1:a===u?0:isNaN(a)?isNaN(u)?0:-1:1}(n,t);case 3:return wd(n.timestampValue,t.timestampValue);case 4:return wd(Yr(n),Yr(t));case 5:return V(n.stringValue,t.stringValue);case 6:return function(s,o){let a=Re(s),u=Re(o);return a.compareTo(u)}(n.bytesValue,t.bytesValue);case 7:return function(s,o){let a=s.split("/"),u=o.split("/");for(let c=0;c<a.length&&c<u.length;c++){let l=V(a[c],u[c]);if(l!==0)return l}return V(a.length,u.length)}(n.referenceValue,t.referenceValue);case 8:return function(s,o){let a=V(X(s.latitude),X(o.latitude));return a!==0?a:V(X(s.longitude),X(o.longitude))}(n.geoPointValue,t.geoPointValue);case 9:return function(s,o){let a=s.values||[],u=o.values||[];for(let c=0;c<a.length&&c<u.length;++c){let l=Ce(a[c],u[c]);if(l)return l}return V(a.length,u.length)}(n.arrayValue,t.arrayValue);case 10:return function(s,o){if(s===Te.mapValue&&o===Te.mapValue)return 0;if(s===Te.mapValue)return 1;if(o===Te.mapValue)return-1;let a=s.fields||{},u=Object.keys(a),c=o.fields||{},l=Object.keys(c);u.sort(),l.sort();for(let h=0;h<u.length&&h<l.length;++h){let d=V(u[h],l[h]);if(d!==0)return d;let m=Ce(a[u[h]],c[l[h]]);if(m!==0)return m}return V(u.length,l.length)}(n.mapValue,t.mapValue);default:throw S()}}function wd(n,t){if(typeof n=="string"&&typeof t=="string"&&n.length===t.length)return V(n,t);let e=ce(n),r=ce(t),i=V(e.seconds,r.seconds);return i!==0?i:V(e.nanos,r.nanos)}function qn(n){return qa(n)}function qa(n){return"nullValue"in n?"null":"booleanValue"in n?""+n.booleanValue:"integerValue"in n?""+n.integerValue:"doubleValue"in n?""+n.doubleValue:"timestampValue"in n?function(e){let r=ce(e);return`time(${r.seconds},${r.nanos})`}(n.timestampValue):"stringValue"in n?n.stringValue:"bytesValue"in n?function(e){return Re(e).toBase64()}(n.bytesValue):"referenceValue"in n?function(e){return I.fromName(e).toString()}(n.referenceValue):"geoPointValue"in n?function(e){return`geo(${e.latitude},${e.longitude})`}(n.geoPointValue):"arrayValue"in n?function(e){let r="[",i=!0;for(let s of e.values||[])i?i=!1:r+=",",r+=qa(s);return r+"]"}(n.arrayValue):"mapValue"in n?function(e){let r=Object.keys(e.fields||{}).sort(),i="{",s=!0;for(let o of r)s?s=!1:i+=",",i+=`${o}:${qa(e.fields[o])}`;return i+"}"}(n.mapValue):S()}function Je(n,t){return{referenceValue:`projects/${n.projectId}/databases/${n.database}/documents/${t.path.canonicalString()}`}}function Ba(n){return!!n&&"integerValue"in n}function Xr(n){return!!n&&"arrayValue"in n}function vd(n){return!!n&&"nullValue"in n}function Id(n){return!!n&&"doubleValue"in n&&isNaN(Number(n.doubleValue))}function cs(n){return!!n&&"mapValue"in n}function Gr(n){if(n.geoPointValue)return{geoPointValue:Object.assign({},n.geoPointValue)};if(n.timestampValue&&typeof n.timestampValue=="object")return{timestampValue:Object.assign({},n.timestampValue)};if(n.mapValue){let t={mapValue:{fields:{}}};return un(n.mapValue.fields,(e,r)=>t.mapValue.fields[e]=Gr(r)),t}if(n.arrayValue){let t={arrayValue:{values:[]}};for(let e=0;e<(n.arrayValue.values||[]).length;++e)t.arrayValue.values[e]=Gr(n.arrayValue.values[e]);return t}return Object.assign({},n)}function bf(n){return(((n.mapValue||{}).fields||{}).__type__||{}).stringValue==="__max__"}function h_(n){return"nullValue"in n?us:"booleanValue"in n?{booleanValue:!1}:"integerValue"in n||"doubleValue"in n?{doubleValue:NaN}:"timestampValue"in n?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in n?{stringValue:""}:"bytesValue"in n?{bytesValue:""}:"referenceValue"in n?Je(Pe.empty(),I.empty()):"geoPointValue"in n?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in n?{arrayValue:{}}:"mapValue"in n?{mapValue:{}}:S()}function d_(n){return"nullValue"in n?{booleanValue:!1}:"booleanValue"in n?{doubleValue:NaN}:"integerValue"in n||"doubleValue"in n?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in n?{stringValue:""}:"stringValue"in n?{bytesValue:""}:"bytesValue"in n?Je(Pe.empty(),I.empty()):"referenceValue"in n?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in n?{arrayValue:{}}:"arrayValue"in n?{mapValue:{}}:"mapValue"in n?Te:S()}function Ed(n,t){let e=Ce(n.value,t.value);return e!==0?e:n.inclusive&&!t.inclusive?-1:!n.inclusive&&t.inclusive?1:0}function Td(n,t){let e=Ce(n.value,t.value);return e!==0?e:n.inclusive&&!t.inclusive?1:!n.inclusive&&t.inclusive?-1:0}var It=class n{constructor(t){this.value=t}static empty(){return new n({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let r=0;r<t.length-1;++r)if(e=(e.mapValue.fields||{})[t.get(r)],!cs(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=Gr(e)}setAll(t){let e=et.emptyPath(),r={},i=[];t.forEach((o,a)=>{if(!e.isImmediateParentOf(a)){let u=this.getFieldsMap(e);this.applyChanges(u,r,i),r={},i=[],e=a.popLast()}o?r[a.lastSegment()]=Gr(o):i.push(a.lastSegment())});let s=this.getFieldsMap(e);this.applyChanges(s,r,i)}delete(t){let e=this.field(t.popLast());cs(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return Zt(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let r=0;r<t.length;++r){let i=e.mapValue.fields[t.get(r)];cs(i)&&i.mapValue.fields||(i={mapValue:{fields:{}}},e.mapValue.fields[t.get(r)]=i),e=i}return e.mapValue.fields}applyChanges(t,e,r){un(e,(i,s)=>t[i]=s);for(let i of r)delete t[i]}clone(){return new n(Gr(this.value))}};function xf(n){let t=[];return un(n.fields,(e,r)=>{let i=new et([e]);if(cs(r)){let s=xf(r.mapValue).fields;if(s.length===0)t.push(i);else for(let o of s)t.push(i.child(o))}else t.push(i)}),new bt(t)}var ut=class n{constructor(t,e,r,i,s,o,a){this.key=t,this.documentType=e,this.version=r,this.readTime=i,this.createTime=s,this.data=o,this.documentState=a}static newInvalidDocument(t){return new n(t,0,P.min(),P.min(),P.min(),It.empty(),0)}static newFoundDocument(t,e,r,i){return new n(t,1,e,P.min(),r,i,0)}static newNoDocument(t,e){return new n(t,2,e,P.min(),P.min(),It.empty(),0)}static newUnknownDocument(t,e){return new n(t,3,e,P.min(),P.min(),It.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(P.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=It.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=It.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=P.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(t){return t instanceof n&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new n(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}};var te=class{constructor(t,e){this.position=t,this.inclusive=e}};function Ad(n,t,e){let r=0;for(let i=0;i<n.position.length;i++){let s=t[i],o=n.position[i];if(s.field.isKeyField()?r=I.comparator(I.fromName(o.referenceValue),e.key):r=Ce(o,e.data.field(s.field)),s.dir==="desc"&&(r*=-1),r!==0)break}return r}function Sd(n,t){if(n===null)return t===null;if(t===null||n.inclusive!==t.inclusive||n.position.length!==t.position.length)return!1;for(let e=0;e<n.position.length;e++)if(!Zt(n.position[e],t.position[e]))return!1;return!0}var Xe=class{constructor(t,e="asc"){this.field=t,this.dir=e}};function f_(n,t){return n.dir===t.dir&&n.field.isEqual(t.field)}var vs=class{},k=class n extends vs{constructor(t,e,r){super(),this.field=t,this.op=e,this.value=r}static create(t,e,r){return t.isKeyField()?e==="in"||e==="not-in"?this.createKeyFieldInFilter(t,e,r):new ja(t,e,r):e==="array-contains"?new $a(t,r):e==="in"?new Is(t,r):e==="not-in"?new Qa(t,r):e==="array-contains-any"?new Wa(t,r):new n(t,e,r)}static createKeyFieldInFilter(t,e,r){return e==="in"?new za(t,r):new Ka(t,r)}matches(t){let e=t.data.field(this.field);return this.op==="!="?e!==null&&this.matchesComparison(Ce(e,this.value)):e!==null&&Ye(this.value)===Ye(e)&&this.matchesComparison(Ce(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return t===0;case"!=":return t!==0;case">":return t>0;case">=":return t>=0;default:return S()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}},G=class n extends vs{constructor(t,e){super(),this.filters=t,this.op=e,this.ue=null}static create(t,e){return new n(t,e)}matches(t){return Bn(this)?this.filters.find(e=>!e.matches(t))===void 0:this.filters.find(e=>e.matches(t))!==void 0}getFlattenedFilters(){return this.ue!==null||(this.ue=this.filters.reduce((t,e)=>t.concat(e.getFlattenedFilters()),[])),this.ue}getFilters(){return Object.assign([],this.filters)}};function Bn(n){return n.op==="and"}function Ua(n){return n.op==="or"}function Cc(n){return Vf(n)&&Bn(n)}function Vf(n){for(let t of n.filters)if(t instanceof G)return!1;return!0}function Ga(n){if(n instanceof k)return n.field.canonicalString()+n.op.toString()+qn(n.value);if(Cc(n))return n.filters.map(t=>Ga(t)).join(",");{let t=n.filters.map(e=>Ga(e)).join(",");return`${n.op}(${t})`}}function Df(n,t){return n instanceof k?function(r,i){return i instanceof k&&r.op===i.op&&r.field.isEqual(i.field)&&Zt(r.value,i.value)}(n,t):n instanceof G?function(r,i){return i instanceof G&&r.op===i.op&&r.filters.length===i.filters.length?r.filters.reduce((s,o,a)=>s&&Df(o,i.filters[a]),!0):!1}(n,t):void S()}function Nf(n,t){let e=n.filters.concat(t);return G.create(e,n.op)}function kf(n){return n instanceof k?function(e){return`${e.field.canonicalString()} ${e.op} ${qn(e.value)}`}(n):n instanceof G?function(e){return e.op.toString()+" {"+e.getFilters().map(kf).join(" ,")+"}"}(n):"Filter"}var ja=class extends k{constructor(t,e,r){super(t,e,r),this.key=I.fromName(r.referenceValue)}matches(t){let e=I.comparator(t.key,this.key);return this.matchesComparison(e)}},za=class extends k{constructor(t,e){super(t,"in",e),this.keys=Ff("in",e)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}},Ka=class extends k{constructor(t,e){super(t,"not-in",e),this.keys=Ff("not-in",e)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}};function Ff(n,t){var e;return(((e=t.arrayValue)===null||e===void 0?void 0:e.values)||[]).map(r=>I.fromName(r.referenceValue))}var $a=class extends k{constructor(t,e){super(t,"array-contains",e)}matches(t){let e=t.data.field(this.field);return Xr(e)&&Jr(e.arrayValue,this.value)}},Is=class extends k{constructor(t,e){super(t,"in",e)}matches(t){let e=t.data.field(this.field);return e!==null&&Jr(this.value.arrayValue,e)}},Qa=class extends k{constructor(t,e){super(t,"not-in",e)}matches(t){if(Jr(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let e=t.data.field(this.field);return e!==null&&!Jr(this.value.arrayValue,e)}},Wa=class extends k{constructor(t,e){super(t,"array-contains-any",e)}matches(t){let e=t.data.field(this.field);return!(!Xr(e)||!e.arrayValue.values)&&e.arrayValue.values.some(r=>Jr(this.value.arrayValue,r))}};var Ha=class{constructor(t,e=null,r=[],i=[],s=null,o=null,a=null){this.path=t,this.collectionGroup=e,this.orderBy=r,this.filters=i,this.limit=s,this.startAt=o,this.endAt=a,this.ce=null}};function Ya(n,t=null,e=[],r=[],i=null,s=null,o=null){return new Ha(n,t,e,r,i,s,o)}function Ze(n){let t=E(n);if(t.ce===null){let e=t.path.canonicalString();t.collectionGroup!==null&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(r=>Ga(r)).join(","),e+="|ob:",e+=t.orderBy.map(r=>function(s){return s.field.canonicalString()+s.dir}(r)).join(","),gi(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(r=>qn(r)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(r=>qn(r)).join(",")),t.ce=e}return t.ce}function pi(n,t){if(n.limit!==t.limit||n.orderBy.length!==t.orderBy.length)return!1;for(let e=0;e<n.orderBy.length;e++)if(!f_(n.orderBy[e],t.orderBy[e]))return!1;if(n.filters.length!==t.filters.length)return!1;for(let e=0;e<n.filters.length;e++)if(!Df(n.filters[e],t.filters[e]))return!1;return n.collectionGroup===t.collectionGroup&&!!n.path.isEqual(t.path)&&!!Sd(n.startAt,t.startAt)&&Sd(n.endAt,t.endAt)}function Es(n){return I.isDocumentKey(n.path)&&n.collectionGroup===null&&n.filters.length===0}function Ts(n,t){return n.filters.filter(e=>e instanceof k&&e.field.isEqual(t))}function Rd(n,t,e){let r=us,i=!0;for(let s of Ts(n,t)){let o=us,a=!0;switch(s.op){case"<":case"<=":o=h_(s.value);break;case"==":case"in":case">=":o=s.value;break;case">":o=s.value,a=!1;break;case"!=":case"not-in":o=us}Ed({value:r,inclusive:i},{value:o,inclusive:a})<0&&(r=o,i=a)}if(e!==null){for(let s=0;s<n.orderBy.length;++s)if(n.orderBy[s].field.isEqual(t)){let o=e.position[s];Ed({value:r,inclusive:i},{value:o,inclusive:e.inclusive})<0&&(r=o,i=e.inclusive);break}}return{value:r,inclusive:i}}function Pd(n,t,e){let r=Te,i=!0;for(let s of Ts(n,t)){let o=Te,a=!0;switch(s.op){case">=":case">":o=d_(s.value),a=!1;break;case"==":case"in":case"<=":o=s.value;break;case"<":o=s.value,a=!1;break;case"!=":case"not-in":o=Te}Td({value:r,inclusive:i},{value:o,inclusive:a})>0&&(r=o,i=a)}if(e!==null){for(let s=0;s<n.orderBy.length;++s)if(n.orderBy[s].field.isEqual(t)){let o=e.position[s];Td({value:r,inclusive:i},{value:o,inclusive:e.inclusive})>0&&(r=o,i=e.inclusive);break}}return{value:r,inclusive:i}}var qt=class{constructor(t,e=null,r=[],i=[],s=null,o="F",a=null,u=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=r,this.filters=i,this.limit=s,this.limitType=o,this.startAt=a,this.endAt=u,this.le=null,this.he=null,this.Pe=null,this.startAt,this.endAt}};function Mf(n,t,e,r,i,s,o,a){return new qt(n,t,e,r,i,s,o,a)}function er(n){return new qt(n)}function Cd(n){return n.filters.length===0&&n.limit===null&&n.startAt==null&&n.endAt==null&&(n.explicitOrderBy.length===0||n.explicitOrderBy.length===1&&n.explicitOrderBy[0].field.isKeyField())}function bc(n){return n.collectionGroup!==null}function Fn(n){let t=E(n);if(t.le===null){t.le=[];let e=new Set;for(let s of t.explicitOrderBy)t.le.push(s),e.add(s.field.canonicalString());let r=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";(function(o){let a=new j(et.comparator);return o.filters.forEach(u=>{u.getFlattenedFilters().forEach(c=>{c.isInequality()&&(a=a.add(c.field))})}),a})(t).forEach(s=>{e.has(s.canonicalString())||s.isKeyField()||t.le.push(new Xe(s,r))}),e.has(et.keyField().canonicalString())||t.le.push(new Xe(et.keyField(),r))}return t.le}function At(n){let t=E(n);return t.he||(t.he=m_(t,Fn(n))),t.he}function m_(n,t){if(n.limitType==="F")return Ya(n.path,n.collectionGroup,t,n.filters,n.limit,n.startAt,n.endAt);{t=t.map(i=>{let s=i.dir==="desc"?"asc":"desc";return new Xe(i.field,s)});let e=n.endAt?new te(n.endAt.position,n.endAt.inclusive):null,r=n.startAt?new te(n.startAt.position,n.startAt.inclusive):null;return Ya(n.path,n.collectionGroup,t,n.filters,n.limit,e,r)}}function Ja(n,t){let e=n.filters.concat([t]);return new qt(n.path,n.collectionGroup,n.explicitOrderBy.slice(),e,n.limit,n.limitType,n.startAt,n.endAt)}function As(n,t,e){return new qt(n.path,n.collectionGroup,n.explicitOrderBy.slice(),n.filters.slice(),t,e,n.startAt,n.endAt)}function _i(n,t){return pi(At(n),At(t))&&n.limitType===t.limitType}function Of(n){return`${Ze(At(n))}|lt:${n.limitType}`}function bn(n){return`Query(target=${function(e){let r=e.path.canonicalString();return e.collectionGroup!==null&&(r+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(r+=`, filters: [${e.filters.map(i=>kf(i)).join(", ")}]`),gi(e.limit)||(r+=", limit: "+e.limit),e.orderBy.length>0&&(r+=`, orderBy: [${e.orderBy.map(i=>function(o){return`${o.field.canonicalString()} (${o.dir})`}(i)).join(", ")}]`),e.startAt&&(r+=", startAt: ",r+=e.startAt.inclusive?"b:":"a:",r+=e.startAt.position.map(i=>qn(i)).join(",")),e.endAt&&(r+=", endAt: ",r+=e.endAt.inclusive?"a:":"b:",r+=e.endAt.position.map(i=>qn(i)).join(",")),`Target(${r})`}(At(n))}; limitType=${n.limitType})`}function yi(n,t){return t.isFoundDocument()&&function(r,i){let s=i.key.path;return r.collectionGroup!==null?i.key.hasCollectionId(r.collectionGroup)&&r.path.isPrefixOf(s):I.isDocumentKey(r.path)?r.path.isEqual(s):r.path.isImmediateParentOf(s)}(n,t)&&function(r,i){for(let s of Fn(r))if(!s.field.isKeyField()&&i.data.field(s.field)===null)return!1;return!0}(n,t)&&function(r,i){for(let s of r.filters)if(!s.matches(i))return!1;return!0}(n,t)&&function(r,i){return!(r.startAt&&!function(o,a,u){let c=Ad(o,a,u);return o.inclusive?c<=0:c<0}(r.startAt,Fn(r),i)||r.endAt&&!function(o,a,u){let c=Ad(o,a,u);return o.inclusive?c>=0:c>0}(r.endAt,Fn(r),i))}(n,t)}function Lf(n){return n.collectionGroup||(n.path.length%2==1?n.path.lastSegment():n.path.get(n.path.length-2))}function qf(n){return(t,e)=>{let r=!1;for(let i of Fn(n)){let s=g_(i,t,e);if(s!==0)return s;r=r||i.field.isKeyField()}return 0}}function g_(n,t,e){let r=n.field.isKeyField()?I.comparator(t.key,e.key):function(s,o,a){let u=o.data.field(s),c=a.data.field(s);return u!==null&&c!==null?Ce(u,c):S()}(n.field,t,e);switch(n.dir){case"asc":return r;case"desc":return-1*r;default:return S()}}var ee=class{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){let e=this.mapKeyFn(t),r=this.inner[e];if(r!==void 0){for(let[i,s]of r)if(this.equalsFn(i,t))return s}}has(t){return this.get(t)!==void 0}set(t,e){let r=this.mapKeyFn(t),i=this.inner[r];if(i===void 0)return this.inner[r]=[[t,e]],void this.innerSize++;for(let s=0;s<i.length;s++)if(this.equalsFn(i[s][0],t))return void(i[s]=[t,e]);i.push([t,e]),this.innerSize++}delete(t){let e=this.mapKeyFn(t),r=this.inner[e];if(r===void 0)return!1;for(let i=0;i<r.length;i++)if(this.equalsFn(r[i][0],t))return r.length===1?delete this.inner[e]:r.splice(i,1),this.innerSize--,!0;return!1}forEach(t){un(this.inner,(e,r)=>{for(let[i,s]of r)t(i,s)})}isEmpty(){return Pf(this.inner)}size(){return this.innerSize}};var p_=new $(I.comparator);function Rt(){return p_}var Bf=new $(I.comparator);function Br(...n){let t=Bf;for(let e of n)t=t.insert(e.key,e);return t}function Uf(n){let t=Bf;return n.forEach((e,r)=>t=t.insert(e,r.overlayedDocument)),t}function Ht(){return jr()}function Gf(){return jr()}function jr(){return new ee(n=>n.toString(),(n,t)=>n.isEqual(t))}var __=new $(I.comparator),y_=new j(I.comparator);function D(...n){let t=y_;for(let e of n)t=t.add(e);return t}var w_=new j(V);function xc(){return w_}function jf(n,t){if(n.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Wr(t)?"-0":t}}function zf(n){return{integerValue:""+n}}function Kf(n,t){return If(t)?zf(t):jf(n,t)}var Un=class{constructor(){this._=void 0}};function v_(n,t,e){return n instanceof be?function(i,s){let o={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:i.seconds,nanos:i.nanoseconds}}}};return s&&co(s)&&(s=Pc(s)),s&&(o.fields.__previous_value__=s),{mapValue:o}}(e,t):n instanceof le?Qf(n,t):n instanceof he?Wf(n,t):function(i,s){let o=$f(i,s),a=bd(o)+bd(i.Ie);return Ba(o)&&Ba(i.Ie)?zf(a):jf(i.serializer,a)}(n,t)}function I_(n,t,e){return n instanceof le?Qf(n,t):n instanceof he?Wf(n,t):e}function $f(n,t){return n instanceof xe?function(r){return Ba(r)||function(s){return!!s&&"doubleValue"in s}(r)}(t)?t:{integerValue:0}:null}var be=class extends Un{},le=class extends Un{constructor(t){super(),this.elements=t}};function Qf(n,t){let e=Hf(t);for(let r of n.elements)e.some(i=>Zt(i,r))||e.push(r);return{arrayValue:{values:e}}}var he=class extends Un{constructor(t){super(),this.elements=t}};function Wf(n,t){let e=Hf(t);for(let r of n.elements)e=e.filter(i=>!Zt(i,r));return{arrayValue:{values:e}}}var xe=class extends Un{constructor(t,e){super(),this.serializer=t,this.Ie=e}};function bd(n){return X(n.integerValue||n.doubleValue)}function Hf(n){return Xr(n)&&n.arrayValue.values?n.arrayValue.values.slice():[]}var tn=class{constructor(t,e){this.field=t,this.transform=e}};function E_(n,t){return n.field.isEqual(t.field)&&function(r,i){return r instanceof le&&i instanceof le||r instanceof he&&i instanceof he?On(r.elements,i.elements,Zt):r instanceof xe&&i instanceof xe?Zt(r.Ie,i.Ie):r instanceof be&&i instanceof be}(n.transform,t.transform)}var Xa=class{constructor(t,e){this.version=t,this.transformResults=e}},Z=class n{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new n}static exists(t){return new n(void 0,t)}static updateTime(t){return new n(t)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}};function ls(n,t){return n.updateTime!==void 0?t.isFoundDocument()&&t.version.isEqual(n.updateTime):n.exists===void 0||n.exists===t.isFoundDocument()}var Gn=class{};function Yf(n,t){if(!n.hasLocalMutations||t&&t.fields.length===0)return null;if(t===null)return n.isNoDocument()?new De(n.key,Z.none()):new Ve(n.key,n.data,Z.none());{let e=n.data,r=It.empty(),i=new j(et.comparator);for(let s of t.fields)if(!i.has(s)){let o=e.field(s);o===null&&s.length>1&&(s=s.popLast(),o=e.field(s)),o===null?r.delete(s):r.set(s,o),i=i.add(s)}return new Bt(n.key,r,new bt(i.toArray()),Z.none())}}function T_(n,t,e){n instanceof Ve?function(i,s,o){let a=i.value.clone(),u=Vd(i.fieldTransforms,s,o.transformResults);a.setAll(u),s.convertToFoundDocument(o.version,a).setHasCommittedMutations()}(n,t,e):n instanceof Bt?function(i,s,o){if(!ls(i.precondition,s))return void s.convertToUnknownDocument(o.version);let a=Vd(i.fieldTransforms,s,o.transformResults),u=s.data;u.setAll(Jf(i)),u.setAll(a),s.convertToFoundDocument(o.version,u).setHasCommittedMutations()}(n,t,e):function(i,s,o){s.convertToNoDocument(o.version).setHasCommittedMutations()}(0,t,e)}function zr(n,t,e,r){return n instanceof Ve?function(s,o,a,u){if(!ls(s.precondition,o))return a;let c=s.value.clone(),l=Dd(s.fieldTransforms,u,o);return c.setAll(l),o.convertToFoundDocument(o.version,c).setHasLocalMutations(),null}(n,t,e,r):n instanceof Bt?function(s,o,a,u){if(!ls(s.precondition,o))return a;let c=Dd(s.fieldTransforms,u,o),l=o.data;return l.setAll(Jf(s)),l.setAll(c),o.convertToFoundDocument(o.version,l).setHasLocalMutations(),a===null?null:a.unionWith(s.fieldMask.fields).unionWith(s.fieldTransforms.map(h=>h.field))}(n,t,e,r):function(s,o,a){return ls(s.precondition,o)?(o.convertToNoDocument(o.version).setHasLocalMutations(),null):a}(n,t,e)}function A_(n,t){let e=null;for(let r of n.fieldTransforms){let i=t.data.field(r.field),s=$f(r.transform,i||null);s!=null&&(e===null&&(e=It.empty()),e.set(r.field,s))}return e||null}function xd(n,t){return n.type===t.type&&!!n.key.isEqual(t.key)&&!!n.precondition.isEqual(t.precondition)&&!!function(r,i){return r===void 0&&i===void 0||!(!r||!i)&&On(r,i,(s,o)=>E_(s,o))}(n.fieldTransforms,t.fieldTransforms)&&(n.type===0?n.value.isEqual(t.value):n.type!==1||n.data.isEqual(t.data)&&n.fieldMask.isEqual(t.fieldMask))}var Ve=class extends Gn{constructor(t,e,r,i=[]){super(),this.key=t,this.value=e,this.precondition=r,this.fieldTransforms=i,this.type=0}getFieldMask(){return null}},Bt=class extends Gn{constructor(t,e,r,i,s=[]){super(),this.key=t,this.data=e,this.fieldMask=r,this.precondition=i,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}};function Jf(n){let t=new Map;return n.fieldMask.fields.forEach(e=>{if(!e.isEmpty()){let r=n.data.field(e);t.set(e,r)}}),t}function Vd(n,t,e){let r=new Map;R(n.length===e.length);for(let i=0;i<e.length;i++){let s=n[i],o=s.transform,a=t.data.field(s.field);r.set(s.field,I_(o,a,e[i]))}return r}function Dd(n,t,e){let r=new Map;for(let i of n){let s=i.transform,o=e.data.field(i.field);r.set(i.field,v_(s,o,t))}return r}var De=class extends Gn{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}},Zr=class extends Gn{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}};var ti=class{constructor(t,e,r,i){this.batchId=t,this.localWriteTime=e,this.baseMutations=r,this.mutations=i}applyToRemoteDocument(t,e){let r=e.mutationResults;for(let i=0;i<this.mutations.length;i++){let s=this.mutations[i];s.key.isEqual(t.key)&&T_(s,t,r[i])}}applyToLocalView(t,e){for(let r of this.baseMutations)r.key.isEqual(t.key)&&(e=zr(r,t,e,this.localWriteTime));for(let r of this.mutations)r.key.isEqual(t.key)&&(e=zr(r,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){let r=Gf();return this.mutations.forEach(i=>{let s=t.get(i.key),o=s.overlayedDocument,a=this.applyToLocalView(o,s.mutatedFields);a=e.has(i.key)?null:a;let u=Yf(o,a);u!==null&&r.set(i.key,u),o.isValidDocument()||o.convertToNoDocument(P.min())}),r}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),D())}isEqual(t){return this.batchId===t.batchId&&On(this.mutations,t.mutations,(e,r)=>xd(e,r))&&On(this.baseMutations,t.baseMutations,(e,r)=>xd(e,r))}},Za=class n{constructor(t,e,r,i){this.batch=t,this.commitVersion=e,this.mutationResults=r,this.docVersions=i}static from(t,e,r){R(t.mutations.length===r.length);let i=function(){return __}(),s=t.mutations;for(let o=0;o<s.length;o++)i=i.insert(s[o].key,r[o].version);return new n(t,e,r,i)}};var ei=class{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return t!==null&&this.mutation===t.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}};var tu=class{constructor(t,e){this.count=t,this.unchangedNames=e}};var it,F;function Xf(n){switch(n){default:return S();case g.CANCELLED:case g.UNKNOWN:case g.DEADLINE_EXCEEDED:case g.RESOURCE_EXHAUSTED:case g.INTERNAL:case g.UNAVAILABLE:case g.UNAUTHENTICATED:return!1;case g.INVALID_ARGUMENT:case g.NOT_FOUND:case g.ALREADY_EXISTS:case g.PERMISSION_DENIED:case g.FAILED_PRECONDITION:case g.ABORTED:case g.OUT_OF_RANGE:case g.UNIMPLEMENTED:case g.DATA_LOSS:return!0}}function Zf(n){if(n===void 0)return tt("GRPC error has no .code"),g.UNKNOWN;switch(n){case it.OK:return g.OK;case it.CANCELLED:return g.CANCELLED;case it.UNKNOWN:return g.UNKNOWN;case it.DEADLINE_EXCEEDED:return g.DEADLINE_EXCEEDED;case it.RESOURCE_EXHAUSTED:return g.RESOURCE_EXHAUSTED;case it.INTERNAL:return g.INTERNAL;case it.UNAVAILABLE:return g.UNAVAILABLE;case it.UNAUTHENTICATED:return g.UNAUTHENTICATED;case it.INVALID_ARGUMENT:return g.INVALID_ARGUMENT;case it.NOT_FOUND:return g.NOT_FOUND;case it.ALREADY_EXISTS:return g.ALREADY_EXISTS;case it.PERMISSION_DENIED:return g.PERMISSION_DENIED;case it.FAILED_PRECONDITION:return g.FAILED_PRECONDITION;case it.ABORTED:return g.ABORTED;case it.OUT_OF_RANGE:return g.OUT_OF_RANGE;case it.UNIMPLEMENTED:return g.UNIMPLEMENTED;case it.DATA_LOSS:return g.DATA_LOSS;default:return S()}}(F=it||(it={}))[F.OK=0]="OK",F[F.CANCELLED=1]="CANCELLED",F[F.UNKNOWN=2]="UNKNOWN",F[F.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",F[F.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",F[F.NOT_FOUND=5]="NOT_FOUND",F[F.ALREADY_EXISTS=6]="ALREADY_EXISTS",F[F.PERMISSION_DENIED=7]="PERMISSION_DENIED",F[F.UNAUTHENTICATED=16]="UNAUTHENTICATED",F[F.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",F[F.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",F[F.ABORTED=10]="ABORTED",F[F.OUT_OF_RANGE=11]="OUT_OF_RANGE",F[F.UNIMPLEMENTED=12]="UNIMPLEMENTED",F[F.INTERNAL=13]="INTERNAL",F[F.UNAVAILABLE=14]="UNAVAILABLE",F[F.DATA_LOSS=15]="DATA_LOSS";var Nd=null;function tm(){return new TextEncoder}var S_=new Ue([4294967295,4294967295],0);function kd(n){let t=tm().encode(n),e=new fd;return e.update(t),new Uint8Array(e.digest())}function Fd(n){let t=new DataView(n.buffer),e=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new Ue([e,r],0),new Ue([i,s],0)]}var eu=class n{constructor(t,e,r){if(this.bitmap=t,this.padding=e,this.hashCount=r,e<0||e>=8)throw new We(`Invalid padding: ${e}`);if(r<0)throw new We(`Invalid hash count: ${r}`);if(t.length>0&&this.hashCount===0)throw new We(`Invalid hash count: ${r}`);if(t.length===0&&e!==0)throw new We(`Invalid padding when bitmap length is 0: ${e}`);this.Te=8*t.length-e,this.Ee=Ue.fromNumber(this.Te)}de(t,e,r){let i=t.add(e.multiply(Ue.fromNumber(r)));return i.compare(S_)===1&&(i=new Ue([i.getBits(0),i.getBits(1)],0)),i.modulo(this.Ee).toNumber()}Ae(t){return(this.bitmap[Math.floor(t/8)]&1<<t%8)!=0}mightContain(t){if(this.Te===0)return!1;let e=kd(t),[r,i]=Fd(e);for(let s=0;s<this.hashCount;s++){let o=this.de(r,i,s);if(!this.Ae(o))return!1}return!0}static create(t,e,r){let i=t%8==0?0:8-t%8,s=new Uint8Array(Math.ceil(t/8)),o=new n(s,i,e);return r.forEach(a=>o.insert(a)),o}insert(t){if(this.Te===0)return;let e=kd(t),[r,i]=Fd(e);for(let s=0;s<this.hashCount;s++){let o=this.de(r,i,s);this.Re(o)}}Re(t){let e=Math.floor(t/8),r=t%8;this.bitmap[e]|=1<<r}},We=class extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}};var ni=class n{constructor(t,e,r,i,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=r,this.documentUpdates=i,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e,r){let i=new Map;return i.set(t,ri.createSynthesizedTargetChangeForCurrentChange(t,e,r)),new n(P.min(),i,new $(V),Rt(),D())}},ri=class n{constructor(t,e,r,i,s){this.resumeToken=t,this.current=e,this.addedDocuments=r,this.modifiedDocuments=i,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e,r){return new n(r,e,D(),D(),D())}};var Mn=class{constructor(t,e,r,i){this.Ve=t,this.removedTargetIds=e,this.key=r,this.me=i}},Ss=class{constructor(t,e){this.targetId=t,this.fe=e}},Rs=class{constructor(t,e,r=dt.EMPTY_BYTE_STRING,i=null){this.state=t,this.targetIds=e,this.resumeToken=r,this.cause=i}},Ps=class{constructor(){this.ge=0,this.pe=Od(),this.ye=dt.EMPTY_BYTE_STRING,this.we=!1,this.Se=!0}get current(){return this.we}get resumeToken(){return this.ye}get be(){return this.ge!==0}get De(){return this.Se}Ce(t){t.approximateByteSize()>0&&(this.Se=!0,this.ye=t)}ve(){let t=D(),e=D(),r=D();return this.pe.forEach((i,s)=>{switch(s){case 0:t=t.add(i);break;case 2:e=e.add(i);break;case 1:r=r.add(i);break;default:S()}}),new ri(this.ye,this.we,t,e,r)}Fe(){this.Se=!1,this.pe=Od()}Me(t,e){this.Se=!0,this.pe=this.pe.insert(t,e)}xe(t){this.Se=!0,this.pe=this.pe.remove(t)}Oe(){this.ge+=1}Ne(){this.ge-=1,R(this.ge>=0)}Le(){this.Se=!0,this.we=!0}},nu=class{constructor(t){this.Be=t,this.ke=new Map,this.qe=Rt(),this.Qe=Md(),this.Ke=new $(V)}$e(t){for(let e of t.Ve)t.me&&t.me.isFoundDocument()?this.Ue(e,t.me):this.We(e,t.key,t.me);for(let e of t.removedTargetIds)this.We(e,t.key,t.me)}Ge(t){this.forEachTarget(t,e=>{let r=this.ze(e);switch(t.state){case 0:this.je(e)&&r.Ce(t.resumeToken);break;case 1:r.Ne(),r.be||r.Fe(),r.Ce(t.resumeToken);break;case 2:r.Ne(),r.be||this.removeTarget(e);break;case 3:this.je(e)&&(r.Le(),r.Ce(t.resumeToken));break;case 4:this.je(e)&&(this.He(e),r.Ce(t.resumeToken));break;default:S()}})}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.ke.forEach((r,i)=>{this.je(i)&&e(i)})}Je(t){let e=t.targetId,r=t.fe.count,i=this.Ye(e);if(i){let s=i.target;if(Es(s))if(r===0){let o=new I(s.path);this.We(e,o,ut.newNoDocument(o,P.min()))}else R(r===1);else{let o=this.Ze(e);if(o!==r){let a=this.Xe(t),u=a?this.et(a,t,o):1;if(u!==0){this.He(e);let c=u===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Ke=this.Ke.insert(e,c)}Nd?.tt(function(l,h,d,m,A){var w,v,C,N,b,q;let B={localCacheCount:l,existenceFilterCount:h.count,databaseId:d.database,projectId:d.projectId},L=h.unchangedNames;return L&&(B.bloomFilter={applied:A===0,hashCount:(w=L?.hashCount)!==null&&w!==void 0?w:0,bitmapLength:(N=(C=(v=L?.bits)===null||v===void 0?void 0:v.bitmap)===null||C===void 0?void 0:C.length)!==null&&N!==void 0?N:0,padding:(q=(b=L?.bits)===null||b===void 0?void 0:b.padding)!==null&&q!==void 0?q:0,mightContain:rt=>{var jt;return(jt=m?.mightContain(rt))!==null&&jt!==void 0&&jt}}),B}(o,t.fe,this.Be.nt(),a,u))}}}}Xe(t){let e=t.fe.unchangedNames;if(!e||!e.bits)return null;let{bits:{bitmap:r="",padding:i=0},hashCount:s=0}=e,o,a;try{o=Re(r).toUint8Array()}catch(u){if(u instanceof ws)return kt("Decoding the base64 bloom filter in existence filter failed ("+u.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw u}try{a=new eu(o,i,s)}catch(u){return kt(u instanceof We?"BloomFilter error: ":"Applying bloom filter failed: ",u),null}return a.Te===0?null:a}et(t,e,r){return e.fe.count===r-this.rt(t,e.targetId)?0:2}rt(t,e){let r=this.Be.getRemoteKeysForTarget(e),i=0;return r.forEach(s=>{let o=this.Be.nt(),a=`projects/${o.projectId}/databases/${o.database}/documents/${s.path.canonicalString()}`;t.mightContain(a)||(this.We(e,s,null),i++)}),i}it(t){let e=new Map;this.ke.forEach((s,o)=>{let a=this.Ye(o);if(a){if(s.current&&Es(a.target)){let u=new I(a.target.path);this.qe.get(u)!==null||this.st(o,u)||this.We(o,u,ut.newNoDocument(u,t))}s.De&&(e.set(o,s.ve()),s.Fe())}});let r=D();this.Qe.forEach((s,o)=>{let a=!0;o.forEachWhile(u=>{let c=this.Ye(u);return!c||c.purpose==="TargetPurposeLimboResolution"||(a=!1,!1)}),a&&(r=r.add(s))}),this.qe.forEach((s,o)=>o.setReadTime(t));let i=new ni(t,e,this.Ke,this.qe,r);return this.qe=Rt(),this.Qe=Md(),this.Ke=new $(V),i}Ue(t,e){if(!this.je(t))return;let r=this.st(t,e.key)?2:0;this.ze(t).Me(e.key,r),this.qe=this.qe.insert(e.key,e),this.Qe=this.Qe.insert(e.key,this.ot(e.key).add(t))}We(t,e,r){if(!this.je(t))return;let i=this.ze(t);this.st(t,e)?i.Me(e,1):i.xe(e),this.Qe=this.Qe.insert(e,this.ot(e).delete(t)),r&&(this.qe=this.qe.insert(e,r))}removeTarget(t){this.ke.delete(t)}Ze(t){let e=this.ze(t).ve();return this.Be.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Oe(t){this.ze(t).Oe()}ze(t){let e=this.ke.get(t);return e||(e=new Ps,this.ke.set(t,e)),e}ot(t){let e=this.Qe.get(t);return e||(e=new j(V),this.Qe=this.Qe.insert(t,e)),e}je(t){let e=this.Ye(t)!==null;return e||y("WatchChangeAggregator","Detected inactive target",t),e}Ye(t){let e=this.ke.get(t);return e&&e.be?null:this.Be._t(t)}He(t){this.ke.set(t,new Ps),this.Be.getRemoteKeysForTarget(t).forEach(e=>{this.We(t,e,null)})}st(t,e){return this.Be.getRemoteKeysForTarget(t).has(e)}};function Md(){return new $(I.comparator)}function Od(){return new $(I.comparator)}var R_={asc:"ASCENDING",desc:"DESCENDING"},P_={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},C_={and:"AND",or:"OR"},ru=class{constructor(t,e){this.databaseId=t,this.useProto3Json=e}};function iu(n,t){return n.useProto3Json||gi(t)?t:{value:t}}function jn(n,t){return n.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function em(n,t){return n.useProto3Json?t.toBase64():t.toUint8Array()}function b_(n,t){return jn(n,t.toTimestamp())}function nt(n){return R(!!n),P.fromTimestamp(function(e){let r=ce(e);return new W(r.seconds,r.nanos)}(n))}function Vc(n,t){return su(n,t).canonicalString()}function su(n,t){let e=function(i){return new M(["projects",i.projectId,"databases",i.database])}(n).child("documents");return t===void 0?e:e.child(t)}function nm(n){let t=M.fromString(n);return R(dm(t)),t}function ii(n,t){return Vc(n.databaseId,t.path)}function Jt(n,t){let e=nm(t);if(e.get(1)!==n.databaseId.projectId)throw new _(g.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+e.get(1)+" vs "+n.databaseId.projectId);if(e.get(3)!==n.databaseId.database)throw new _(g.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+e.get(3)+" vs "+n.databaseId.database);return new I(sm(e))}function rm(n,t){return Vc(n.databaseId,t)}function im(n){let t=nm(n);return t.length===4?M.emptyPath():sm(t)}function ou(n){return new M(["projects",n.databaseId.projectId,"databases",n.databaseId.database]).canonicalString()}function sm(n){return R(n.length>4&&n.get(4)==="documents"),n.popFirst(5)}function Ld(n,t,e){return{name:ii(n,t),fields:e.value.mapValue.fields}}function om(n,t,e){let r=Jt(n,t.name),i=nt(t.updateTime),s=t.createTime?nt(t.createTime):P.min(),o=new It({mapValue:{fields:t.fields}}),a=ut.newFoundDocument(r,i,s,o);return e&&a.setHasCommittedMutations(),e?a.setHasCommittedMutations():a}function x_(n,t){return"found"in t?function(r,i){R(!!i.found),i.found.name,i.found.updateTime;let s=Jt(r,i.found.name),o=nt(i.found.updateTime),a=i.found.createTime?nt(i.found.createTime):P.min(),u=new It({mapValue:{fields:i.found.fields}});return ut.newFoundDocument(s,o,a,u)}(n,t):"missing"in t?function(r,i){R(!!i.missing),R(!!i.readTime);let s=Jt(r,i.missing),o=nt(i.readTime);return ut.newNoDocument(s,o)}(n,t):S()}function V_(n,t){let e;if("targetChange"in t){t.targetChange;let r=function(c){return c==="NO_CHANGE"?0:c==="ADD"?1:c==="REMOVE"?2:c==="CURRENT"?3:c==="RESET"?4:S()}(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],s=function(c,l){return c.useProto3Json?(R(l===void 0||typeof l=="string"),dt.fromBase64String(l||"")):(R(l===void 0||l instanceof Buffer||l instanceof Uint8Array),dt.fromUint8Array(l||new Uint8Array))}(n,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(c){let l=c.code===void 0?g.UNKNOWN:Zf(c.code);return new _(l,c.message||"")}(o);e=new Rs(r,i,s,a||null)}else if("documentChange"in t){t.documentChange;let r=t.documentChange;r.document,r.document.name,r.document.updateTime;let i=Jt(n,r.document.name),s=nt(r.document.updateTime),o=r.document.createTime?nt(r.document.createTime):P.min(),a=new It({mapValue:{fields:r.document.fields}}),u=ut.newFoundDocument(i,s,o,a),c=r.targetIds||[],l=r.removedTargetIds||[];e=new Mn(c,l,u.key,u)}else if("documentDelete"in t){t.documentDelete;let r=t.documentDelete;r.document;let i=Jt(n,r.document),s=r.readTime?nt(r.readTime):P.min(),o=ut.newNoDocument(i,s),a=r.removedTargetIds||[];e=new Mn([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;let r=t.documentRemove;r.document;let i=Jt(n,r.document),s=r.removedTargetIds||[];e=new Mn([],s,i,null)}else{if(!("filter"in t))return S();{t.filter;let r=t.filter;r.targetId;let{count:i=0,unchangedNames:s}=r,o=new tu(i,s),a=r.targetId;e=new Ss(a,o)}}return e}function si(n,t){let e;if(t instanceof Ve)e={update:Ld(n,t.key,t.value)};else if(t instanceof De)e={delete:ii(n,t.key)};else if(t instanceof Bt)e={update:Ld(n,t.key,t.data),updateMask:O_(t.fieldMask)};else{if(!(t instanceof Zr))return S();e={verify:ii(n,t.key)}}return t.fieldTransforms.length>0&&(e.updateTransforms=t.fieldTransforms.map(r=>function(s,o){let a=o.transform;if(a instanceof be)return{fieldPath:o.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(a instanceof le)return{fieldPath:o.field.canonicalString(),appendMissingElements:{values:a.elements}};if(a instanceof he)return{fieldPath:o.field.canonicalString(),removeAllFromArray:{values:a.elements}};if(a instanceof xe)return{fieldPath:o.field.canonicalString(),increment:a.Ie};throw S()}(0,r))),t.precondition.isNone||(e.currentDocument=function(i,s){return s.updateTime!==void 0?{updateTime:b_(i,s.updateTime)}:s.exists!==void 0?{exists:s.exists}:S()}(n,t.precondition)),e}function au(n,t){let e=t.currentDocument?function(s){return s.updateTime!==void 0?Z.updateTime(nt(s.updateTime)):s.exists!==void 0?Z.exists(s.exists):Z.none()}(t.currentDocument):Z.none(),r=t.updateTransforms?t.updateTransforms.map(i=>function(o,a){let u=null;if("setToServerValue"in a)R(a.setToServerValue==="REQUEST_TIME"),u=new be;else if("appendMissingElements"in a){let l=a.appendMissingElements.values||[];u=new le(l)}else if("removeAllFromArray"in a){let l=a.removeAllFromArray.values||[];u=new he(l)}else"increment"in a?u=new xe(o,a.increment):S();let c=et.fromServerFormat(a.fieldPath);return new tn(c,u)}(n,i)):[];if(t.update){t.update.name;let i=Jt(n,t.update.name),s=new It({mapValue:{fields:t.update.fields}});if(t.updateMask){let o=function(u){let c=u.fieldPaths||[];return new bt(c.map(l=>et.fromServerFormat(l)))}(t.updateMask);return new Bt(i,s,o,e,r)}return new Ve(i,s,e,r)}if(t.delete){let i=Jt(n,t.delete);return new De(i,e)}if(t.verify){let i=Jt(n,t.verify);return new Zr(i,e)}return S()}function D_(n,t){return n&&n.length>0?(R(t!==void 0),n.map(e=>function(i,s){let o=i.updateTime?nt(i.updateTime):nt(s);return o.isEqual(P.min())&&(o=nt(s)),new Xa(o,i.transformResults||[])}(e,t))):[]}function am(n,t){return{documents:[rm(n,t.path)]}}function um(n,t){let e={structuredQuery:{}},r=t.path,i;t.collectionGroup!==null?(i=r,e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=r.popLast(),e.structuredQuery.from=[{collectionId:r.lastSegment()}]),e.parent=rm(n,i);let s=function(c){if(c.length!==0)return hm(G.create(c,"and"))}(t.filters);s&&(e.structuredQuery.where=s);let o=function(c){if(c.length!==0)return c.map(l=>function(d){return{field:xn(d.field),direction:k_(d.dir)}}(l))}(t.orderBy);o&&(e.structuredQuery.orderBy=o);let a=iu(n,t.limit);return a!==null&&(e.structuredQuery.limit=a),t.startAt&&(e.structuredQuery.startAt=function(c){return{before:c.inclusive,values:c.position}}(t.startAt)),t.endAt&&(e.structuredQuery.endAt=function(c){return{before:!c.inclusive,values:c.position}}(t.endAt)),{ut:e,parent:i}}function cm(n){let t=im(n.parent),e=n.structuredQuery,r=e.from?e.from.length:0,i=null;if(r>0){R(r===1);let l=e.from[0];l.allDescendants?i=l.collectionId:t=t.child(l.collectionId)}let s=[];e.where&&(s=function(h){let d=lm(h);return d instanceof G&&Cc(d)?d.getFilters():[d]}(e.where));let o=[];e.orderBy&&(o=function(h){return h.map(d=>function(A){return new Xe(Vn(A.field),function(v){switch(v){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(A.direction))}(d))}(e.orderBy));let a=null;e.limit&&(a=function(h){let d;return d=typeof h=="object"?h.value:h,gi(d)?null:d}(e.limit));let u=null;e.startAt&&(u=function(h){let d=!!h.before,m=h.values||[];return new te(m,d)}(e.startAt));let c=null;return e.endAt&&(c=function(h){let d=!h.before,m=h.values||[];return new te(m,d)}(e.endAt)),Mf(t,i,o,s,a,"F",u,c)}function N_(n,t){let e=function(i){switch(i){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return S()}}(t.purpose);return e==null?null:{"goog-listen-tags":e}}function lm(n){return n.unaryFilter!==void 0?function(e){switch(e.unaryFilter.op){case"IS_NAN":let r=Vn(e.unaryFilter.field);return k.create(r,"==",{doubleValue:NaN});case"IS_NULL":let i=Vn(e.unaryFilter.field);return k.create(i,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let s=Vn(e.unaryFilter.field);return k.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let o=Vn(e.unaryFilter.field);return k.create(o,"!=",{nullValue:"NULL_VALUE"});default:return S()}}(n):n.fieldFilter!==void 0?function(e){return k.create(Vn(e.fieldFilter.field),function(i){switch(i){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return S()}}(e.fieldFilter.op),e.fieldFilter.value)}(n):n.compositeFilter!==void 0?function(e){return G.create(e.compositeFilter.filters.map(r=>lm(r)),function(i){switch(i){case"AND":return"and";case"OR":return"or";default:return S()}}(e.compositeFilter.op))}(n):S()}function k_(n){return R_[n]}function F_(n){return P_[n]}function M_(n){return C_[n]}function xn(n){return{fieldPath:n.canonicalString()}}function Vn(n){return et.fromServerFormat(n.fieldPath)}function hm(n){return n instanceof k?function(e){if(e.op==="=="){if(Id(e.value))return{unaryFilter:{field:xn(e.field),op:"IS_NAN"}};if(vd(e.value))return{unaryFilter:{field:xn(e.field),op:"IS_NULL"}}}else if(e.op==="!="){if(Id(e.value))return{unaryFilter:{field:xn(e.field),op:"IS_NOT_NAN"}};if(vd(e.value))return{unaryFilter:{field:xn(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:xn(e.field),op:F_(e.op),value:e.value}}}(n):n instanceof G?function(e){let r=e.getFilters().map(i=>hm(i));return r.length===1?r[0]:{compositeFilter:{op:M_(e.op),filters:r}}}(n):S()}function O_(n){let t=[];return n.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}function dm(n){return n.length>=4&&n.get(0)==="projects"&&n.get(2)==="databases"}var zn=class n{constructor(t,e,r,i,s=P.min(),o=P.min(),a=dt.EMPTY_BYTE_STRING,u=null){this.target=t,this.targetId=e,this.purpose=r,this.sequenceNumber=i,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=a,this.expectedCount=u}withSequenceNumber(t){return new n(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}};var Cs=class{constructor(t){this.ct=t}};function L_(n,t){let e;if(t.document)e=om(n.ct,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let r=I.fromSegments(t.noDocument.path),i=nn(t.noDocument.readTime);e=ut.newNoDocument(r,i),t.hasCommittedMutations&&e.setHasCommittedMutations()}else{if(!t.unknownDocument)return S();{let r=I.fromSegments(t.unknownDocument.path),i=nn(t.unknownDocument.version);e=ut.newUnknownDocument(r,i)}}return t.readTime&&e.setReadTime(function(i){let s=new W(i[0],i[1]);return P.fromTimestamp(s)}(t.readTime)),e}function qd(n,t){let e=t.key,r={prefixPath:e.getCollectionPath().popLast().toArray(),collectionGroup:e.collectionGroup,documentId:e.path.lastSegment(),readTime:bs(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document=function(s,o){return{name:ii(s,o.key),fields:o.data.value.mapValue.fields,updateTime:jn(s,o.version.toTimestamp()),createTime:jn(s,o.createTime.toTimestamp())}}(n.ct,t);else if(t.isNoDocument())r.noDocument={path:e.path.toArray(),readTime:en(t.version)};else{if(!t.isUnknownDocument())return S();r.unknownDocument={path:e.path.toArray(),version:en(t.version)}}return r}function bs(n){let t=n.toTimestamp();return[t.seconds,t.nanoseconds]}function en(n){let t=n.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function nn(n){let t=new W(n.seconds,n.nanoseconds);return P.fromTimestamp(t)}function Ke(n,t){let e=(t.baseMutations||[]).map(s=>au(n.ct,s));for(let s=0;s<t.mutations.length-1;++s){let o=t.mutations[s];if(s+1<t.mutations.length&&t.mutations[s+1].transform!==void 0){let a=t.mutations[s+1];o.updateTransforms=a.transform.fieldTransforms,t.mutations.splice(s+1,1),++s}}let r=t.mutations.map(s=>au(n.ct,s)),i=W.fromMillis(t.localWriteTimeMs);return new ti(t.batchId,i,e,r)}function Ur(n){let t=nn(n.readTime),e=n.lastLimboFreeSnapshotVersion!==void 0?nn(n.lastLimboFreeSnapshotVersion):P.min(),r;return r=function(s){return s.documents!==void 0}(n.query)?function(s){return R(s.documents.length===1),At(er(im(s.documents[0])))}(n.query):function(s){return At(cm(s))}(n.query),new zn(r,n.targetId,"TargetPurposeListen",n.lastListenSequenceNumber,t,e,dt.fromBase64String(n.resumeToken))}function fm(n,t){let e=en(t.snapshotVersion),r=en(t.lastLimboFreeSnapshotVersion),i;i=Es(t.target)?am(n.ct,t.target):um(n.ct,t.target).ut;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:Ze(t.target),readTime:e,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:i}}function Dc(n){let t=cm({parent:n.parent,structuredQuery:n.structuredQuery});return n.limitType==="LAST"?As(t,t.limit,"L"):t}function Ea(n,t){return new ei(t.largestBatchId,au(n.ct,t.overlayMutation))}function Bd(n,t){let e=t.path.lastSegment();return[n,Tt(t.path.popLast()),e]}function Ud(n,t,e,r){return{indexId:n,uid:t,sequenceNumber:e,readTime:en(r.readTime),documentKey:Tt(r.documentKey.path),largestBatchId:r.largestBatchId}}var uu=class{getBundleMetadata(t,e){return Gd(t).get(e).next(r=>{if(r)return function(s){return{id:s.bundleId,createTime:nn(s.createTime),version:s.version}}(r)})}saveBundleMetadata(t,e){return Gd(t).put(function(i){return{bundleId:i.id,createTime:en(nt(i.createTime)),version:i.version}}(e))}getNamedQuery(t,e){return jd(t).get(e).next(r=>{if(r)return function(s){return{name:s.name,query:Dc(s.bundledQuery),readTime:nn(s.readTime)}}(r)})}saveNamedQuery(t,e){return jd(t).put(function(i){return{name:i.name,readTime:en(nt(i.readTime)),bundledQuery:i.bundledQuery}}(e))}};function Gd(n){return ft(n,"bundles")}function jd(n){return ft(n,"namedQueries")}var xs=class n{constructor(t,e){this.serializer=t,this.userId=e}static lt(t,e){let r=e.uid||"";return new n(t,r)}getOverlay(t,e){return Mr(t).get(Bd(this.userId,e)).next(r=>r?Ea(this.serializer,r):null)}getOverlays(t,e){let r=Ht();return f.forEach(e,i=>this.getOverlay(t,i).next(s=>{s!==null&&r.set(i,s)})).next(()=>r)}saveOverlays(t,e,r){let i=[];return r.forEach((s,o)=>{let a=new ei(e,o);i.push(this.ht(t,a))}),f.waitFor(i)}removeOverlaysForBatchId(t,e,r){let i=new Set;e.forEach(o=>i.add(Tt(o.getCollectionPath())));let s=[];return i.forEach(o=>{let a=IDBKeyRange.bound([this.userId,o,r],[this.userId,o,r+1],!1,!0);s.push(Mr(t).H("collectionPathOverlayIndex",a))}),f.waitFor(s)}getOverlaysForCollection(t,e,r){let i=Ht(),s=Tt(e),o=IDBKeyRange.bound([this.userId,s,r],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Mr(t).W("collectionPathOverlayIndex",o).next(a=>{for(let u of a){let c=Ea(this.serializer,u);i.set(c.getKey(),c)}return i})}getOverlaysForCollectionGroup(t,e,r,i){let s=Ht(),o,a=IDBKeyRange.bound([this.userId,e,r],[this.userId,e,Number.POSITIVE_INFINITY],!0);return Mr(t).Y({index:"collectionGroupOverlayIndex",range:a},(u,c,l)=>{let h=Ea(this.serializer,c);s.size()<i||h.largestBatchId===o?(s.set(h.getKey(),h),o=h.largestBatchId):l.done()}).next(()=>s)}ht(t,e){return Mr(t).put(function(i,s,o){let[a,u,c]=Bd(s,o.mutation.key);return{userId:s,collectionPath:u,documentId:c,collectionGroup:o.mutation.key.getCollectionGroup(),largestBatchId:o.largestBatchId,overlayMutation:si(i.ct,o.mutation)}}(this.serializer,this.userId,e))}};function Mr(n){return ft(n,"documentOverlays")}var oe=class{constructor(){}Pt(t,e){this.It(t,e),e.Tt()}It(t,e){if("nullValue"in t)this.Et(e,5);else if("booleanValue"in t)this.Et(e,10),e.dt(t.booleanValue?1:0);else if("integerValue"in t)this.Et(e,15),e.dt(X(t.integerValue));else if("doubleValue"in t){let r=X(t.doubleValue);isNaN(r)?this.Et(e,13):(this.Et(e,15),Wr(r)?e.dt(0):e.dt(r))}else if("timestampValue"in t){let r=t.timestampValue;this.Et(e,20),typeof r=="string"&&(r=ce(r)),e.At(`${r.seconds||""}`),e.dt(r.nanos||0)}else if("stringValue"in t)this.Rt(t.stringValue,e),this.Vt(e);else if("bytesValue"in t)this.Et(e,30),e.ft(Re(t.bytesValue)),this.Vt(e);else if("referenceValue"in t)this.gt(t.referenceValue,e);else if("geoPointValue"in t){let r=t.geoPointValue;this.Et(e,45),e.dt(r.latitude||0),e.dt(r.longitude||0)}else"mapValue"in t?bf(t)?this.Et(e,Number.MAX_SAFE_INTEGER):(this.yt(t.mapValue,e),this.Vt(e)):"arrayValue"in t?(this.wt(t.arrayValue,e),this.Vt(e)):S()}Rt(t,e){this.Et(e,25),this.St(t,e)}St(t,e){e.At(t)}yt(t,e){let r=t.fields||{};this.Et(e,55);for(let i of Object.keys(r))this.Rt(i,e),this.It(r[i],e)}wt(t,e){let r=t.values||[];this.Et(e,50);for(let i of r)this.It(i,e)}gt(t,e){this.Et(e,37),I.fromName(t).path.forEach(r=>{this.Et(e,60),this.St(r,e)})}Et(t,e){t.dt(e)}Vt(t){t.dt(2)}};oe.bt=new oe;function q_(n){if(n===0)return 8;let t=0;return!(n>>4)&&(t+=4,n<<=4),!(n>>6)&&(t+=2,n<<=2),!(n>>7)&&(t+=1),t}function zd(n){let t=64-function(r){let i=0;for(let s=0;s<8;++s){let o=q_(255&r[s]);if(i+=o,o!==8)break}return i}(n);return Math.ceil(t/8)}var cu=class{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Dt(t){let e=t[Symbol.iterator](),r=e.next();for(;!r.done;)this.Ct(r.value),r=e.next();this.vt()}Ft(t){let e=t[Symbol.iterator](),r=e.next();for(;!r.done;)this.Mt(r.value),r=e.next();this.xt()}Ot(t){for(let e of t){let r=e.charCodeAt(0);if(r<128)this.Ct(r);else if(r<2048)this.Ct(960|r>>>6),this.Ct(128|63&r);else if(e<"\uD800"||"\uDBFF"<e)this.Ct(480|r>>>12),this.Ct(128|63&r>>>6),this.Ct(128|63&r);else{let i=e.codePointAt(0);this.Ct(240|i>>>18),this.Ct(128|63&i>>>12),this.Ct(128|63&i>>>6),this.Ct(128|63&i)}}this.vt()}Nt(t){for(let e of t){let r=e.charCodeAt(0);if(r<128)this.Mt(r);else if(r<2048)this.Mt(960|r>>>6),this.Mt(128|63&r);else if(e<"\uD800"||"\uDBFF"<e)this.Mt(480|r>>>12),this.Mt(128|63&r>>>6),this.Mt(128|63&r);else{let i=e.codePointAt(0);this.Mt(240|i>>>18),this.Mt(128|63&i>>>12),this.Mt(128|63&i>>>6),this.Mt(128|63&i)}}this.xt()}Lt(t){let e=this.Bt(t),r=zd(e);this.kt(1+r),this.buffer[this.position++]=255&r;for(let i=e.length-r;i<e.length;++i)this.buffer[this.position++]=255&e[i]}qt(t){let e=this.Bt(t),r=zd(e);this.kt(1+r),this.buffer[this.position++]=~(255&r);for(let i=e.length-r;i<e.length;++i)this.buffer[this.position++]=~(255&e[i])}Qt(){this.Kt(255),this.Kt(255)}$t(){this.Ut(255),this.Ut(255)}reset(){this.position=0}seed(t){this.kt(t.length),this.buffer.set(t,this.position),this.position+=t.length}Wt(){return this.buffer.slice(0,this.position)}Bt(t){let e=function(s){let o=new DataView(new ArrayBuffer(8));return o.setFloat64(0,s,!1),new Uint8Array(o.buffer)}(t),r=(128&e[0])!=0;e[0]^=r?255:128;for(let i=1;i<e.length;++i)e[i]^=r?255:0;return e}Ct(t){let e=255&t;e===0?(this.Kt(0),this.Kt(255)):e===255?(this.Kt(255),this.Kt(0)):this.Kt(e)}Mt(t){let e=255&t;e===0?(this.Ut(0),this.Ut(255)):e===255?(this.Ut(255),this.Ut(0)):this.Ut(t)}vt(){this.Kt(0),this.Kt(1)}xt(){this.Ut(0),this.Ut(1)}Kt(t){this.kt(1),this.buffer[this.position++]=t}Ut(t){this.kt(1),this.buffer[this.position++]=~t}kt(t){let e=t+this.position;if(e<=this.buffer.length)return;let r=2*this.buffer.length;r<e&&(r=e);let i=new Uint8Array(r);i.set(this.buffer),this.buffer=i}},lu=class{constructor(t){this.Gt=t}ft(t){this.Gt.Dt(t)}At(t){this.Gt.Ot(t)}dt(t){this.Gt.Lt(t)}Tt(){this.Gt.Qt()}},hu=class{constructor(t){this.Gt=t}ft(t){this.Gt.Ft(t)}At(t){this.Gt.Nt(t)}dt(t){this.Gt.qt(t)}Tt(){this.Gt.$t()}},$e=class{constructor(){this.Gt=new cu,this.zt=new lu(this.Gt),this.jt=new hu(this.Gt)}seed(t){this.Gt.seed(t)}Ht(t){return t===0?this.zt:this.jt}Wt(){return this.Gt.Wt()}reset(){this.Gt.reset()}};var Qe=class n{constructor(t,e,r,i){this.indexId=t,this.documentKey=e,this.arrayValue=r,this.directionalValue=i}Jt(){let t=this.directionalValue.length,e=t===0||this.directionalValue[t-1]===255?t+1:t,r=new Uint8Array(e);return r.set(this.directionalValue,0),e!==t?r.set([0],this.directionalValue.length):++r[r.length-1],new n(this.indexId,this.documentKey,this.arrayValue,r)}};function we(n,t){let e=n.indexId-t.indexId;return e!==0?e:(e=Kd(n.arrayValue,t.arrayValue),e!==0?e:(e=Kd(n.directionalValue,t.directionalValue),e!==0?e:I.comparator(n.documentKey,t.documentKey)))}function Kd(n,t){for(let e=0;e<n.length&&e<t.length;++e){let r=n[e]-t[e];if(r!==0)return r}return n.length-t.length}var Vs=class{constructor(t){this.Yt=new j((e,r)=>et.comparator(e.field,r.field)),this.collectionId=t.collectionGroup!=null?t.collectionGroup:t.path.lastSegment(),this.Zt=t.orderBy,this.Xt=[];for(let e of t.filters){let r=e;r.isInequality()?this.Yt=this.Yt.add(r):this.Xt.push(r)}}get en(){return this.Yt.size>1}tn(t){if(R(t.collectionGroup===this.collectionId),this.en)return!1;let e=Na(t);if(e!==void 0&&!this.nn(e))return!1;let r=je(t),i=new Set,s=0,o=0;for(;s<r.length&&this.nn(r[s]);++s)i=i.add(r[s].fieldPath.canonicalString());if(s===r.length)return!0;if(this.Yt.size>0){let a=this.Yt.getIterator().getNext();if(!i.has(a.field.canonicalString())){let u=r[s];if(!this.rn(a,u)||!this.sn(this.Zt[o++],u))return!1}++s}for(;s<r.length;++s){let a=r[s];if(o>=this.Zt.length||!this.sn(this.Zt[o++],a))return!1}return!0}on(){if(this.en)return null;let t=new j(et.comparator),e=[];for(let r of this.Xt)if(!r.field.isKeyField())if(r.op==="array-contains"||r.op==="array-contains-any")e.push(new kn(r.field,2));else{if(t.has(r.field))continue;t=t.add(r.field),e.push(new kn(r.field,0))}for(let r of this.Zt)r.field.isKeyField()||t.has(r.field)||(t=t.add(r.field),e.push(new kn(r.field,r.dir==="asc"?0:1)));return new Ln(Ln.UNKNOWN_ID,this.collectionId,e,Qr.empty())}nn(t){for(let e of this.Xt)if(this.rn(e,t))return!0;return!1}rn(t,e){if(t===void 0||!t.field.isEqual(e.fieldPath))return!1;let r=t.op==="array-contains"||t.op==="array-contains-any";return e.kind===2===r}sn(t,e){return!!t.field.isEqual(e.fieldPath)&&(e.kind===0&&t.dir==="asc"||e.kind===1&&t.dir==="desc")}};function mm(n){var t,e;if(R(n instanceof k||n instanceof G),n instanceof k){if(n instanceof Is){let i=((e=(t=n.value.arrayValue)===null||t===void 0?void 0:t.values)===null||e===void 0?void 0:e.map(s=>k.create(n.field,"==",s)))||[];return G.create(i,"or")}return n}let r=n.filters.map(i=>mm(i));return G.create(r,n.op)}function B_(n){if(n.getFilters().length===0)return[];let t=mu(mm(n));return R(gm(t)),du(t)||fu(t)?[t]:t.getFilters()}function du(n){return n instanceof k}function fu(n){return n instanceof G&&Cc(n)}function gm(n){return du(n)||fu(n)||function(e){if(e instanceof G&&Ua(e)){for(let r of e.getFilters())if(!du(r)&&!fu(r))return!1;return!0}return!1}(n)}function mu(n){if(R(n instanceof k||n instanceof G),n instanceof k)return n;if(n.filters.length===1)return mu(n.filters[0]);let t=n.filters.map(r=>mu(r)),e=G.create(t,n.op);return e=Ds(e),gm(e)?e:(R(e instanceof G),R(Bn(e)),R(e.filters.length>1),e.filters.reduce((r,i)=>Nc(r,i)))}function Nc(n,t){let e;return R(n instanceof k||n instanceof G),R(t instanceof k||t instanceof G),e=n instanceof k?t instanceof k?function(i,s){return G.create([i,s],"and")}(n,t):$d(n,t):t instanceof k?$d(t,n):function(i,s){if(R(i.filters.length>0&&s.filters.length>0),Bn(i)&&Bn(s))return Nf(i,s.getFilters());let o=Ua(i)?i:s,a=Ua(i)?s:i,u=o.filters.map(c=>Nc(c,a));return G.create(u,"or")}(n,t),Ds(e)}function $d(n,t){if(Bn(t))return Nf(t,n.getFilters());{let e=t.filters.map(r=>Nc(n,r));return G.create(e,"or")}}function Ds(n){if(R(n instanceof k||n instanceof G),n instanceof k)return n;let t=n.getFilters();if(t.length===1)return Ds(t[0]);if(Vf(n))return n;let e=t.map(i=>Ds(i)),r=[];return e.forEach(i=>{i instanceof k?r.push(i):i instanceof G&&(i.op===n.op?r.push(...i.filters):r.push(i))}),r.length===1?r[0]:G.create(r,n.op)}var gu=class{constructor(){this._n=new oi}addToCollectionParentIndex(t,e){return this._n.add(e),f.resolve()}getCollectionParents(t,e){return f.resolve(this._n.getEntries(e))}addFieldIndex(t,e){return f.resolve()}deleteFieldIndex(t,e){return f.resolve()}deleteAllFieldIndexes(t){return f.resolve()}createTargetIndexes(t,e){return f.resolve()}getDocumentsMatchingTarget(t,e){return f.resolve(null)}getIndexType(t,e){return f.resolve(0)}getFieldIndexes(t,e){return f.resolve([])}getNextCollectionGroupToUpdate(t){return f.resolve(null)}getMinOffset(t,e){return f.resolve(Ft.min())}getMinOffsetFromCollectionGroup(t,e){return f.resolve(Ft.min())}updateCollectionGroup(t,e,r){return f.resolve()}updateIndexEntries(t,e){return f.resolve()}},oi=class{constructor(){this.index={}}add(t){let e=t.lastSegment(),r=t.popLast(),i=this.index[e]||new j(M.comparator),s=!i.has(r);return this.index[e]=i.add(r),s}has(t){let e=t.lastSegment(),r=t.popLast(),i=this.index[e];return i&&i.has(r)}getEntries(t){return(this.index[t]||new j(M.comparator)).toArray()}};var rs=new Uint8Array(0),pu=class{constructor(t,e){this.databaseId=e,this.an=new oi,this.un=new ee(r=>Ze(r),(r,i)=>pi(r,i)),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.an.has(e)){let r=e.lastSegment(),i=e.popLast();t.addOnCommittedListener(()=>{this.an.add(e)});let s={collectionId:r,parent:Tt(i)};return Qd(t).put(s)}return f.resolve()}getCollectionParents(t,e){let r=[],i=IDBKeyRange.bound([e,""],[_f(e),""],!1,!0);return Qd(t).W(i).next(s=>{for(let o of s){if(o.collectionId!==e)break;r.push(Wt(o.parent))}return r})}addFieldIndex(t,e){let r=Or(t),i=function(a){return{indexId:a.indexId,collectionGroup:a.collectionGroup,fields:a.fields.map(u=>[u.fieldPath.canonicalString(),u.kind])}}(e);delete i.indexId;let s=r.add(i);if(e.indexState){let o=Rn(t);return s.next(a=>{o.put(Ud(a,this.uid,e.indexState.sequenceNumber,e.indexState.offset))})}return s.next()}deleteFieldIndex(t,e){let r=Or(t),i=Rn(t),s=Sn(t);return r.delete(e.indexId).next(()=>i.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))}deleteAllFieldIndexes(t){let e=Or(t),r=Sn(t),i=Rn(t);return e.H().next(()=>r.H()).next(()=>i.H())}createTargetIndexes(t,e){return f.forEach(this.cn(e),r=>this.getIndexType(t,r).next(i=>{if(i===0||i===1){let s=new Vs(r).on();if(s!=null)return this.addFieldIndex(t,s)}}))}getDocumentsMatchingTarget(t,e){let r=Sn(t),i=!0,s=new Map;return f.forEach(this.cn(e),o=>this.ln(t,o).next(a=>{i&&(i=!!a),s.set(o,a)})).next(()=>{if(i){let o=D(),a=[];return f.forEach(s,(u,c)=>{y("IndexedDbIndexManager",`Using index ${function(b){return`id=${b.indexId}|cg=${b.collectionGroup}|f=${b.fields.map(q=>`${q.fieldPath}:${q.kind}`).join(",")}`}(u)} to execute ${Ze(e)}`);let l=function(b,q){let B=Na(q);if(B===void 0)return null;for(let L of Ts(b,B.fieldPath))switch(L.op){case"array-contains-any":return L.value.arrayValue.values||[];case"array-contains":return[L.value]}return null}(c,u),h=function(b,q){let B=new Map;for(let L of je(q))for(let rt of Ts(b,L.fieldPath))switch(rt.op){case"==":case"in":B.set(L.fieldPath.canonicalString(),rt.value);break;case"not-in":case"!=":return B.set(L.fieldPath.canonicalString(),rt.value),Array.from(B.values())}return null}(c,u),d=function(b,q){let B=[],L=!0;for(let rt of je(q)){let jt=rt.kind===0?Rd(b,rt.fieldPath,b.startAt):Pd(b,rt.fieldPath,b.startAt);B.push(jt.value),L&&(L=jt.inclusive)}return new te(B,L)}(c,u),m=function(b,q){let B=[],L=!0;for(let rt of je(q)){let jt=rt.kind===0?Pd(b,rt.fieldPath,b.endAt):Rd(b,rt.fieldPath,b.endAt);B.push(jt.value),L&&(L=jt.inclusive)}return new te(B,L)}(c,u),A=this.hn(u,c,d),w=this.hn(u,c,m),v=this.Pn(u,c,h),C=this.In(u.indexId,l,A,d.inclusive,w,m.inclusive,v);return f.forEach(C,N=>r.j(N,e.limit).next(b=>{b.forEach(q=>{let B=I.fromSegments(q.documentKey);o.has(B)||(o=o.add(B),a.push(B))})}))}).next(()=>a)}return f.resolve(null)})}cn(t){let e=this.un.get(t);return e||(t.filters.length===0?e=[t]:e=B_(G.create(t.filters,"and")).map(r=>Ya(t.path,t.collectionGroup,t.orderBy,r.getFilters(),t.limit,t.startAt,t.endAt)),this.un.set(t,e),e)}In(t,e,r,i,s,o,a){let u=(e!=null?e.length:1)*Math.max(r.length,s.length),c=u/(e!=null?e.length:1),l=[];for(let h=0;h<u;++h){let d=e?this.Tn(e[h/c]):rs,m=this.En(t,d,r[h%c],i),A=this.dn(t,d,s[h%c],o),w=a.map(v=>this.En(t,d,v,!0));l.push(...this.createRange(m,A,w))}return l}En(t,e,r,i){let s=new Qe(t,I.empty(),e,r);return i?s:s.Jt()}dn(t,e,r,i){let s=new Qe(t,I.empty(),e,r);return i?s.Jt():s}ln(t,e){let r=new Vs(e),i=e.collectionGroup!=null?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,i).next(s=>{let o=null;for(let a of s)r.tn(a)&&(!o||a.fields.length>o.fields.length)&&(o=a);return o})}getIndexType(t,e){let r=2,i=this.cn(e);return f.forEach(i,s=>this.ln(t,s).next(o=>{o?r!==0&&o.fields.length<function(u){let c=new j(et.comparator),l=!1;for(let h of u.filters)for(let d of h.getFlattenedFilters())d.field.isKeyField()||(d.op==="array-contains"||d.op==="array-contains-any"?l=!0:c=c.add(d.field));for(let h of u.orderBy)h.field.isKeyField()||(c=c.add(h.field));return c.size+(l?1:0)}(s)&&(r=1):r=0})).next(()=>function(o){return o.limit!==null}(e)&&i.length>1&&r===2?1:r)}An(t,e){let r=new $e;for(let i of je(t)){let s=e.data.field(i.fieldPath);if(s==null)return null;let o=r.Ht(i.kind);oe.bt.Pt(s,o)}return r.Wt()}Tn(t){let e=new $e;return oe.bt.Pt(t,e.Ht(0)),e.Wt()}Rn(t,e){let r=new $e;return oe.bt.Pt(Je(this.databaseId,e),r.Ht(function(s){let o=je(s);return o.length===0?0:o[o.length-1].kind}(t))),r.Wt()}Pn(t,e,r){if(r===null)return[];let i=[];i.push(new $e);let s=0;for(let o of je(t)){let a=r[s++];for(let u of i)if(this.Vn(e,o.fieldPath)&&Xr(a))i=this.mn(i,o,a);else{let c=u.Ht(o.kind);oe.bt.Pt(a,c)}}return this.fn(i)}hn(t,e,r){return this.Pn(t,e,r.position)}fn(t){let e=[];for(let r=0;r<t.length;++r)e[r]=t[r].Wt();return e}mn(t,e,r){let i=[...t],s=[];for(let o of r.arrayValue.values||[])for(let a of i){let u=new $e;u.seed(a.Wt()),oe.bt.Pt(o,u.Ht(e.kind)),s.push(u)}return s}Vn(t,e){return!!t.filters.find(r=>r instanceof k&&r.field.isEqual(e)&&(r.op==="in"||r.op==="not-in"))}getFieldIndexes(t,e){let r=Or(t),i=Rn(t);return(e?r.W("collectionGroupIndex",IDBKeyRange.bound(e,e)):r.W()).next(s=>{let o=[];return f.forEach(s,a=>i.get([a.indexId,this.uid]).next(u=>{o.push(function(l,h){let d=h?new Qr(h.sequenceNumber,new Ft(nn(h.readTime),new I(Wt(h.documentKey)),h.largestBatchId)):Qr.empty(),m=l.fields.map(([A,w])=>new kn(et.fromServerFormat(A),w));return new Ln(l.indexId,l.collectionGroup,m,d)}(a,u))})).next(()=>o)})}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next(e=>e.length===0?null:(e.sort((r,i)=>{let s=r.indexState.sequenceNumber-i.indexState.sequenceNumber;return s!==0?s:V(r.collectionGroup,i.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(t,e,r){let i=Or(t),s=Rn(t);return this.gn(t).next(o=>i.W("collectionGroupIndex",IDBKeyRange.bound(e,e)).next(a=>f.forEach(a,u=>s.put(Ud(u.indexId,this.uid,o,r)))))}updateIndexEntries(t,e){let r=new Map;return f.forEach(e,(i,s)=>{let o=r.get(i.collectionGroup);return(o?f.resolve(o):this.getFieldIndexes(t,i.collectionGroup)).next(a=>(r.set(i.collectionGroup,a),f.forEach(a,u=>this.pn(t,i,u).next(c=>{let l=this.yn(s,u);return c.isEqual(l)?f.resolve():this.wn(t,s,u,c,l)}))))})}Sn(t,e,r,i){return Sn(t).put({indexId:i.indexId,uid:this.uid,arrayValue:i.arrayValue,directionalValue:i.directionalValue,orderedDocumentKey:this.Rn(r,e.key),documentKey:e.key.path.toArray()})}bn(t,e,r,i){return Sn(t).delete([i.indexId,this.uid,i.arrayValue,i.directionalValue,this.Rn(r,e.key),e.key.path.toArray()])}pn(t,e,r){let i=Sn(t),s=new j(we);return i.Y({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.Rn(r,e)])},(o,a)=>{s=s.add(new Qe(r.indexId,e,a.arrayValue,a.directionalValue))}).next(()=>s)}yn(t,e){let r=new j(we),i=this.An(e,t);if(i==null)return r;let s=Na(e);if(s!=null){let o=t.data.field(s.fieldPath);if(Xr(o))for(let a of o.arrayValue.values||[])r=r.add(new Qe(e.indexId,t.key,this.Tn(a),i))}else r=r.add(new Qe(e.indexId,t.key,rs,i));return r}wn(t,e,r,i,s){y("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);let o=[];return function(u,c,l,h,d){let m=u.getIterator(),A=c.getIterator(),w=An(m),v=An(A);for(;w||v;){let C=!1,N=!1;if(w&&v){let b=l(w,v);b<0?N=!0:b>0&&(C=!0)}else w!=null?N=!0:C=!0;C?(h(v),v=An(A)):N?(d(w),w=An(m)):(w=An(m),v=An(A))}}(i,s,we,a=>{o.push(this.Sn(t,e,r,a))},a=>{o.push(this.bn(t,e,r,a))}),f.waitFor(o)}gn(t){let e=1;return Rn(t).Y({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(r,i,s)=>{s.done(),e=i.sequenceNumber+1}).next(()=>e)}createRange(t,e,r){r=r.sort((o,a)=>we(o,a)).filter((o,a,u)=>!a||we(o,u[a-1])!==0);let i=[];i.push(t);for(let o of r){let a=we(o,t),u=we(o,e);if(a===0)i[0]=t.Jt();else if(a>0&&u<0)i.push(o),i.push(o.Jt());else if(u>0)break}i.push(e);let s=[];for(let o=0;o<i.length;o+=2){if(this.Dn(i[o],i[o+1]))return[];let a=[i[o].indexId,this.uid,i[o].arrayValue,i[o].directionalValue,rs,[]],u=[i[o+1].indexId,this.uid,i[o+1].arrayValue,i[o+1].directionalValue,rs,[]];s.push(IDBKeyRange.bound(a,u))}return s}Dn(t,e){return we(t,e)>0}getMinOffsetFromCollectionGroup(t,e){return this.getFieldIndexes(t,e).next(Wd)}getMinOffset(t,e){return f.mapArray(this.cn(e),r=>this.ln(t,r).next(i=>i||S())).next(Wd)}};function Qd(n){return ft(n,"collectionParents")}function Sn(n){return ft(n,"indexEntries")}function Or(n){return ft(n,"indexConfiguration")}function Rn(n){return ft(n,"indexState")}function Wd(n){R(n.length!==0);let t=n[0].indexState.offset,e=t.largestBatchId;for(let r=1;r<n.length;r++){let i=n[r].indexState.offset;Sc(i,t)<0&&(t=i),e<i.largestBatchId&&(e=i.largestBatchId)}return new Ft(t.readTime,t.documentKey,e)}var Hd={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Nt=class n{constructor(t,e,r){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=r}static withCacheSize(t){return new n(t,n.DEFAULT_COLLECTION_PERCENTILE,n.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}};function pm(n,t,e){let r=n.store("mutations"),i=n.store("documentMutations"),s=[],o=IDBKeyRange.only(e.batchId),a=0,u=r.Y({range:o},(l,h,d)=>(a++,d.delete()));s.push(u.next(()=>{R(a===1)}));let c=[];for(let l of e.mutations){let h=Ef(t,l.key.path,e.batchId);s.push(i.delete(h)),c.push(l.key)}return f.waitFor(s).next(()=>c)}function Ns(n){if(!n)return 0;let t;if(n.document)t=n.document;else if(n.unknownDocument)t=n.unknownDocument;else{if(!n.noDocument)throw S();t=n.noDocument}return JSON.stringify(t).length}Nt.DEFAULT_COLLECTION_PERCENTILE=10,Nt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Nt.DEFAULT=new Nt(41943040,Nt.DEFAULT_COLLECTION_PERCENTILE,Nt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Nt.DISABLED=new Nt(-1,0,0);var ks=class n{constructor(t,e,r,i){this.userId=t,this.serializer=e,this.indexManager=r,this.referenceDelegate=i,this.Cn={}}static lt(t,e,r,i){R(t.uid!=="");let s=t.isAuthenticated()?t.uid:"";return new n(s,e,r,i)}checkEmpty(t){let e=!0,r=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return ve(t).Y({index:"userMutationsIndex",range:r},(i,s,o)=>{e=!1,o.done()}).next(()=>e)}addMutationBatch(t,e,r,i){let s=Dn(t),o=ve(t);return o.add({}).next(a=>{R(typeof a=="number");let u=new ti(a,e,r,i),c=function(m,A,w){let v=w.baseMutations.map(N=>si(m.ct,N)),C=w.mutations.map(N=>si(m.ct,N));return{userId:A,batchId:w.batchId,localWriteTimeMs:w.localWriteTime.toMillis(),baseMutations:v,mutations:C}}(this.serializer,this.userId,u),l=[],h=new j((d,m)=>V(d.canonicalString(),m.canonicalString()));for(let d of i){let m=Ef(this.userId,d.key.path,a);h=h.add(d.key.path.popLast()),l.push(o.put(c)),l.push(s.put(m,Qp))}return h.forEach(d=>{l.push(this.indexManager.addToCollectionParentIndex(t,d))}),t.addOnCommittedListener(()=>{this.Cn[a]=u.keys()}),f.waitFor(l).next(()=>u)})}lookupMutationBatch(t,e){return ve(t).get(e).next(r=>r?(R(r.userId===this.userId),Ke(this.serializer,r)):null)}vn(t,e){return this.Cn[e]?f.resolve(this.Cn[e]):this.lookupMutationBatch(t,e).next(r=>{if(r){let i=r.keys();return this.Cn[e]=i,i}return null})}getNextMutationBatchAfterBatchId(t,e){let r=e+1,i=IDBKeyRange.lowerBound([this.userId,r]),s=null;return ve(t).Y({index:"userMutationsIndex",range:i},(o,a,u)=>{a.userId===this.userId&&(R(a.batchId>=r),s=Ke(this.serializer,a)),u.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(t){let e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),r=-1;return ve(t).Y({index:"userMutationsIndex",range:e,reverse:!0},(i,s,o)=>{r=s.batchId,o.done()}).next(()=>r)}getAllMutationBatches(t){let e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return ve(t).W("userMutationsIndex",e).next(r=>r.map(i=>Ke(this.serializer,i)))}getAllMutationBatchesAffectingDocumentKey(t,e){let r=as(this.userId,e.path),i=IDBKeyRange.lowerBound(r),s=[];return Dn(t).Y({range:i},(o,a,u)=>{let[c,l,h]=o,d=Wt(l);if(c===this.userId&&e.path.isEqual(d))return ve(t).get(h).next(m=>{if(!m)throw S();R(m.userId===this.userId),s.push(Ke(this.serializer,m))});u.done()}).next(()=>s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let r=new j(V),i=[];return e.forEach(s=>{let o=as(this.userId,s.path),a=IDBKeyRange.lowerBound(o),u=Dn(t).Y({range:a},(c,l,h)=>{let[d,m,A]=c,w=Wt(m);d===this.userId&&s.path.isEqual(w)?r=r.add(A):h.done()});i.push(u)}),f.waitFor(i).next(()=>this.Fn(t,r))}getAllMutationBatchesAffectingQuery(t,e){let r=e.path,i=r.length+1,s=as(this.userId,r),o=IDBKeyRange.lowerBound(s),a=new j(V);return Dn(t).Y({range:o},(u,c,l)=>{let[h,d,m]=u,A=Wt(d);h===this.userId&&r.isPrefixOf(A)?A.length===i&&(a=a.add(m)):l.done()}).next(()=>this.Fn(t,a))}Fn(t,e){let r=[],i=[];return e.forEach(s=>{i.push(ve(t).get(s).next(o=>{if(o===null)throw S();R(o.userId===this.userId),r.push(Ke(this.serializer,o))}))}),f.waitFor(i).next(()=>r)}removeMutationBatch(t,e){return pm(t.ae,this.userId,e).next(r=>(t.addOnCommittedListener(()=>{this.Mn(e.batchId)}),f.forEach(r,i=>this.referenceDelegate.markPotentiallyOrphaned(t,i))))}Mn(t){delete this.Cn[t]}performConsistencyCheck(t){return this.checkEmpty(t).next(e=>{if(!e)return f.resolve();let r=IDBKeyRange.lowerBound(function(o){return[o]}(this.userId)),i=[];return Dn(t).Y({range:r},(s,o,a)=>{if(s[0]===this.userId){let u=Wt(s[1]);i.push(u)}else a.done()}).next(()=>{R(i.length===0)})})}containsKey(t,e){return _m(t,this.userId,e)}xn(t){return ym(t).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}};function _m(n,t,e){let r=as(t,e.path),i=r[1],s=IDBKeyRange.lowerBound(r),o=!1;return Dn(n).Y({range:s,J:!0},(a,u,c)=>{let[l,h,d]=a;l===t&&h===i&&(o=!0),c.done()}).next(()=>o)}function ve(n){return ft(n,"mutations")}function Dn(n){return ft(n,"documentMutations")}function ym(n){return ft(n,"mutationQueues")}var Kn=class n{constructor(t){this.On=t}next(){return this.On+=2,this.On}static Nn(){return new n(0)}static Ln(){return new n(-1)}};var _u=class{constructor(t,e){this.referenceDelegate=t,this.serializer=e}allocateTargetId(t){return this.Bn(t).next(e=>{let r=new Kn(e.highestTargetId);return e.highestTargetId=r.next(),this.kn(t,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(t){return this.Bn(t).next(e=>P.fromTimestamp(new W(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(t){return this.Bn(t).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,e,r){return this.Bn(t).next(i=>(i.highestListenSequenceNumber=e,r&&(i.lastRemoteSnapshotVersion=r.toTimestamp()),e>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=e),this.kn(t,i)))}addTargetData(t,e){return this.qn(t,e).next(()=>this.Bn(t).next(r=>(r.targetCount+=1,this.Qn(e,r),this.kn(t,r))))}updateTargetData(t,e){return this.qn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>Pn(t).delete(e.targetId)).next(()=>this.Bn(t)).next(r=>(R(r.targetCount>0),r.targetCount-=1,this.kn(t,r)))}removeTargets(t,e,r){let i=0,s=[];return Pn(t).Y((o,a)=>{let u=Ur(a);u.sequenceNumber<=e&&r.get(u.targetId)===null&&(i++,s.push(this.removeTargetData(t,u)))}).next(()=>f.waitFor(s)).next(()=>i)}forEachTarget(t,e){return Pn(t).Y((r,i)=>{let s=Ur(i);e(s)})}Bn(t){return Yd(t).get("targetGlobalKey").next(e=>(R(e!==null),e))}kn(t,e){return Yd(t).put("targetGlobalKey",e)}qn(t,e){return Pn(t).put(fm(this.serializer,e))}Qn(t,e){let r=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,r=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,r=!0),r}getTargetCount(t){return this.Bn(t).next(e=>e.targetCount)}getTargetData(t,e){let r=Ze(e),i=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),s=null;return Pn(t).Y({range:i,index:"queryTargetsIndex"},(o,a,u)=>{let c=Ur(a);pi(e,c.target)&&(s=c,u.done())}).next(()=>s)}addMatchingKeys(t,e,r){let i=[],s=Ie(t);return e.forEach(o=>{let a=Tt(o.path);i.push(s.put({targetId:r,path:a})),i.push(this.referenceDelegate.addReference(t,r,o))}),f.waitFor(i)}removeMatchingKeys(t,e,r){let i=Ie(t);return f.forEach(e,s=>{let o=Tt(s.path);return f.waitFor([i.delete([r,o]),this.referenceDelegate.removeReference(t,r,s)])})}removeMatchingKeysForTargetId(t,e){let r=Ie(t),i=IDBKeyRange.bound([e],[e+1],!1,!0);return r.delete(i)}getMatchingKeysForTargetId(t,e){let r=IDBKeyRange.bound([e],[e+1],!1,!0),i=Ie(t),s=D();return i.Y({range:r,J:!0},(o,a,u)=>{let c=Wt(o[1]),l=new I(c);s=s.add(l)}).next(()=>s)}containsKey(t,e){let r=Tt(e.path),i=IDBKeyRange.bound([r],[_f(r)],!1,!0),s=0;return Ie(t).Y({index:"documentTargetsIndex",J:!0,range:i},([o,a],u,c)=>{o!==0&&(s++,c.done())}).next(()=>s>0)}_t(t,e){return Pn(t).get(e).next(r=>r?Ur(r):null)}};function Pn(n){return ft(n,"targets")}function Yd(n){return ft(n,"targetGlobal")}function Ie(n){return ft(n,"targetDocuments")}function Jd([n,t],[e,r]){let i=V(n,e);return i===0?V(t,r):i}var yu=class{constructor(t){this.Kn=t,this.buffer=new j(Jd),this.$n=0}Un(){return++this.$n}Wn(t){let e=[t,this.Un()];if(this.buffer.size<this.Kn)this.buffer=this.buffer.add(e);else{let r=this.buffer.last();Jd(e,r)<0&&(this.buffer=this.buffer.delete(r).add(e))}}get maxValue(){return this.buffer.last()[0]}},wu=class{constructor(t,e,r){this.garbageCollector=t,this.asyncQueue=e,this.localStore=r,this.Gn=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.zn(6e4)}stop(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}get started(){return this.Gn!==null}zn(t){y("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.Gn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,()=>p(this,null,function*(){this.Gn=null;try{yield this.localStore.collectGarbage(this.garbageCollector)}catch(e){Fe(e)?y("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):yield ke(e)}yield this.zn(3e5)}))}},vu=class{constructor(t,e){this.jn=t,this.params=e}calculateTargetCount(t,e){return this.jn.Hn(t).next(r=>Math.floor(e/100*r))}nthSequenceNumber(t,e){if(e===0)return f.resolve(Ct._e);let r=new yu(e);return this.jn.forEachTarget(t,i=>r.Wn(i.sequenceNumber)).next(()=>this.jn.Jn(t,i=>r.Wn(i))).next(()=>r.maxValue)}removeTargets(t,e,r){return this.jn.removeTargets(t,e,r)}removeOrphanedDocuments(t,e){return this.jn.removeOrphanedDocuments(t,e)}collect(t,e){return this.params.cacheSizeCollectionThreshold===-1?(y("LruGarbageCollector","Garbage collection skipped; disabled"),f.resolve(Hd)):this.getCacheSize(t).next(r=>r<this.params.cacheSizeCollectionThreshold?(y("LruGarbageCollector",`Garbage collection skipped; Cache size ${r} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Hd):this.Yn(t,e))}getCacheSize(t){return this.jn.getCacheSize(t)}Yn(t,e){let r,i,s,o,a,u,c,l=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(h=>(h>this.params.maximumSequenceNumbersToCollect?(y("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${h}`),i=this.params.maximumSequenceNumbersToCollect):i=h,o=Date.now(),this.nthSequenceNumber(t,i))).next(h=>(r=h,a=Date.now(),this.removeTargets(t,r,e))).next(h=>(s=h,u=Date.now(),this.removeOrphanedDocuments(t,r))).next(h=>(c=Date.now(),Cn()<=zt.DEBUG&&y("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${o-l}ms
	Determined least recently used ${i} in `+(a-o)+`ms
	Removed ${s} targets in `+(u-a)+`ms
	Removed ${h} documents in `+(c-u)+`ms
Total Duration: ${c-l}ms`),f.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:h})))}};function U_(n,t){return new vu(n,t)}var Iu=class{constructor(t,e){this.db=t,this.garbageCollector=U_(this,e)}Hn(t){let e=this.Zn(t);return this.db.getTargetCache().getTargetCount(t).next(r=>e.next(i=>r+i))}Zn(t){let e=0;return this.Jn(t,r=>{e++}).next(()=>e)}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}Jn(t,e){return this.Xn(t,(r,i)=>e(i))}addReference(t,e,r){return is(t,r)}removeReference(t,e,r){return is(t,r)}removeTargets(t,e,r){return this.db.getTargetCache().removeTargets(t,e,r)}markPotentiallyOrphaned(t,e){return is(t,e)}er(t,e){return function(i,s){let o=!1;return ym(i).Z(a=>_m(i,a,s).next(u=>(u&&(o=!0),f.resolve(!u)))).next(()=>o)}(t,e)}removeOrphanedDocuments(t,e){let r=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[],s=0;return this.Xn(t,(o,a)=>{if(a<=e){let u=this.er(t,o).next(c=>{if(!c)return s++,r.getEntry(t,o).next(()=>(r.removeEntry(o,P.min()),Ie(t).delete(function(h){return[0,Tt(h.path)]}(o))))});i.push(u)}}).next(()=>f.waitFor(i)).next(()=>r.apply(t)).next(()=>s)}removeTarget(t,e){let r=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,r)}updateLimboDocument(t,e){return is(t,e)}Xn(t,e){let r=Ie(t),i,s=Ct._e;return r.Y({index:"documentTargetsIndex"},([o,a],{path:u,sequenceNumber:c})=>{o===0?(s!==Ct._e&&e(new I(Wt(i)),s),s=c,i=u):s=Ct._e}).next(()=>{s!==Ct._e&&e(new I(Wt(i)),s)})}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}};function is(n,t){return Ie(n).put(function(r,i){return{targetId:0,path:Tt(r.path),sequenceNumber:i}}(t,n.currentSequenceNumber))}var Fs=class{constructor(){this.changes=new ee(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,ut.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();let r=this.changes.get(e);return r!==void 0?f.resolve(r):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}};var Eu=class{constructor(t){this.serializer=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,r){return Ge(t).put(r)}removeEntry(t,e,r){return Ge(t).delete(function(s,o){let a=s.path.toArray();return[a.slice(0,a.length-2),a[a.length-2],bs(o),a[a.length-1]]}(e,r))}updateMetadata(t,e){return this.getMetadata(t).next(r=>(r.byteSize+=e,this.tr(t,r)))}getEntry(t,e){let r=ut.newInvalidDocument(e);return Ge(t).Y({index:"documentKeyIndex",range:IDBKeyRange.only(Lr(e))},(i,s)=>{r=this.nr(e,s)}).next(()=>r)}rr(t,e){let r={size:0,document:ut.newInvalidDocument(e)};return Ge(t).Y({index:"documentKeyIndex",range:IDBKeyRange.only(Lr(e))},(i,s)=>{r={document:this.nr(e,s),size:Ns(s)}}).next(()=>r)}getEntries(t,e){let r=Rt();return this.ir(t,e,(i,s)=>{let o=this.nr(i,s);r=r.insert(i,o)}).next(()=>r)}sr(t,e){let r=Rt(),i=new $(I.comparator);return this.ir(t,e,(s,o)=>{let a=this.nr(s,o);r=r.insert(s,a),i=i.insert(s,Ns(o))}).next(()=>({documents:r,_r:i}))}ir(t,e,r){if(e.isEmpty())return f.resolve();let i=new j(tf);e.forEach(u=>i=i.add(u));let s=IDBKeyRange.bound(Lr(i.first()),Lr(i.last())),o=i.getIterator(),a=o.getNext();return Ge(t).Y({index:"documentKeyIndex",range:s},(u,c,l)=>{let h=I.fromSegments([...c.prefixPath,c.collectionGroup,c.documentId]);for(;a&&tf(a,h)<0;)r(a,null),a=o.getNext();a&&a.isEqual(h)&&(r(a,c),a=o.hasNext()?o.getNext():null),a?l.U(Lr(a)):l.done()}).next(()=>{for(;a;)r(a,null),a=o.hasNext()?o.getNext():null})}getDocumentsMatchingQuery(t,e,r,i,s){let o=e.path,a=[o.popLast().toArray(),o.lastSegment(),bs(r.readTime),r.documentKey.path.isEmpty()?"":r.documentKey.path.lastSegment()],u=[o.popLast().toArray(),o.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Ge(t).W(IDBKeyRange.bound(a,u,!0)).next(c=>{s?.incrementDocumentReadCount(c.length);let l=Rt();for(let h of c){let d=this.nr(I.fromSegments(h.prefixPath.concat(h.collectionGroup,h.documentId)),h);d.isFoundDocument()&&(yi(e,d)||i.has(d.key))&&(l=l.insert(d.key,d))}return l})}getAllFromCollectionGroup(t,e,r,i){let s=Rt(),o=Zd(e,r),a=Zd(e,Ft.max());return Ge(t).Y({index:"collectionGroupIndex",range:IDBKeyRange.bound(o,a,!0)},(u,c,l)=>{let h=this.nr(I.fromSegments(c.prefixPath.concat(c.collectionGroup,c.documentId)),c);s=s.insert(h.key,h),s.size===i&&l.done()}).next(()=>s)}newChangeBuffer(t){return new Tu(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next(e=>e.byteSize)}getMetadata(t){return Xd(t).get("remoteDocumentGlobalKey").next(e=>(R(!!e),e))}tr(t,e){return Xd(t).put("remoteDocumentGlobalKey",e)}nr(t,e){if(e){let r=L_(this.serializer,e);if(!(r.isNoDocument()&&r.version.isEqual(P.min())))return r}return ut.newInvalidDocument(t)}};function wm(n){return new Eu(n)}var Tu=class extends Fs{constructor(t,e){super(),this.ar=t,this.trackRemovals=e,this.ur=new ee(r=>r.toString(),(r,i)=>r.isEqual(i))}applyChanges(t){let e=[],r=0,i=new j((s,o)=>V(s.canonicalString(),o.canonicalString()));return this.changes.forEach((s,o)=>{let a=this.ur.get(s);if(e.push(this.ar.removeEntry(t,s,a.readTime)),o.isValidDocument()){let u=qd(this.ar.serializer,o);i=i.add(s.path.popLast());let c=Ns(u);r+=c-a.size,e.push(this.ar.addEntry(t,s,u))}else if(r-=a.size,this.trackRemovals){let u=qd(this.ar.serializer,o.convertToNoDocument(P.min()));e.push(this.ar.addEntry(t,s,u))}}),i.forEach(s=>{e.push(this.ar.indexManager.addToCollectionParentIndex(t,s))}),e.push(this.ar.updateMetadata(t,r)),f.waitFor(e)}getFromCache(t,e){return this.ar.rr(t,e).next(r=>(this.ur.set(e,{size:r.size,readTime:r.document.readTime}),r.document))}getAllFromCache(t,e){return this.ar.sr(t,e).next(({documents:r,_r:i})=>(i.forEach((s,o)=>{this.ur.set(s,{size:o,readTime:r.get(s).readTime})}),r))}};function Xd(n){return ft(n,"remoteDocumentGlobal")}function Ge(n){return ft(n,"remoteDocumentsV14")}function Lr(n){let t=n.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function Zd(n,t){let e=t.documentKey.path.toArray();return[n,bs(t.readTime),e.slice(0,e.length-2),e.length>0?e[e.length-1]:""]}function tf(n,t){let e=n.path.toArray(),r=t.path.toArray(),i=0;for(let s=0;s<e.length-2&&s<r.length-2;++s)if(i=V(e[s],r[s]),i)return i;return i=V(e.length,r.length),i||(i=V(e[e.length-2],r[r.length-2]),i||V(e[e.length-1],r[r.length-1]))}var Au=class{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}};var Ms=class{constructor(t,e,r,i){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=r,this.indexManager=i}getDocument(t,e){let r=null;return this.documentOverlayCache.getOverlay(t,e).next(i=>(r=i,this.remoteDocumentCache.getEntry(t,e))).next(i=>(r!==null&&zr(r.mutation,i,bt.empty(),W.now()),i))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(r=>this.getLocalViewOfDocuments(t,r,D()).next(()=>r))}getLocalViewOfDocuments(t,e,r=D()){let i=Ht();return this.populateOverlays(t,i,e).next(()=>this.computeViews(t,e,i,r).next(s=>{let o=Br();return s.forEach((a,u)=>{o=o.insert(a,u.overlayedDocument)}),o}))}getOverlayedDocuments(t,e){let r=Ht();return this.populateOverlays(t,r,e).next(()=>this.computeViews(t,e,r,D()))}populateOverlays(t,e,r){let i=[];return r.forEach(s=>{e.has(s)||i.push(s)}),this.documentOverlayCache.getOverlays(t,i).next(s=>{s.forEach((o,a)=>{e.set(o,a)})})}computeViews(t,e,r,i){let s=Rt(),o=jr(),a=function(){return jr()}();return e.forEach((u,c)=>{let l=r.get(c.key);i.has(c.key)&&(l===void 0||l.mutation instanceof Bt)?s=s.insert(c.key,c):l!==void 0?(o.set(c.key,l.mutation.getFieldMask()),zr(l.mutation,c,l.mutation.getFieldMask(),W.now())):o.set(c.key,bt.empty())}),this.recalculateAndSaveOverlays(t,s).next(u=>(u.forEach((c,l)=>o.set(c,l)),e.forEach((c,l)=>{var h;return a.set(c,new Au(l,(h=o.get(c))!==null&&h!==void 0?h:null))}),a))}recalculateAndSaveOverlays(t,e){let r=jr(),i=new $((o,a)=>o-a),s=D();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next(o=>{for(let a of o)a.keys().forEach(u=>{let c=e.get(u);if(c===null)return;let l=r.get(u)||bt.empty();l=a.applyToLocalView(c,l),r.set(u,l);let h=(i.get(a.batchId)||D()).add(u);i=i.insert(a.batchId,h)})}).next(()=>{let o=[],a=i.getReverseIterator();for(;a.hasNext();){let u=a.getNext(),c=u.key,l=u.value,h=Gf();l.forEach(d=>{if(!s.has(d)){let m=Yf(e.get(d),r.get(d));m!==null&&h.set(d,m),s=s.add(d)}}),o.push(this.documentOverlayCache.saveOverlays(t,c,h))}return f.waitFor(o)}).next(()=>r)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(r=>this.recalculateAndSaveOverlays(t,r))}getDocumentsMatchingQuery(t,e,r,i){return function(o){return I.isDocumentKey(o.path)&&o.collectionGroup===null&&o.filters.length===0}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):bc(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,r,i):this.getDocumentsMatchingCollectionQuery(t,e,r,i)}getNextDocuments(t,e,r,i){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,r,i).next(s=>{let o=i-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,r.largestBatchId,i-s.size):f.resolve(Ht()),a=-1,u=s;return o.next(c=>f.forEach(c,(l,h)=>(a<h.largestBatchId&&(a=h.largestBatchId),s.get(l)?f.resolve():this.remoteDocumentCache.getEntry(t,l).next(d=>{u=u.insert(l,d)}))).next(()=>this.populateOverlays(t,c,s)).next(()=>this.computeViews(t,u,c,D())).next(l=>({batchId:a,changes:Uf(l)})))})}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new I(e)).next(r=>{let i=Br();return r.isFoundDocument()&&(i=i.insert(r.key,r)),i})}getDocumentsMatchingCollectionGroupQuery(t,e,r,i){let s=e.collectionGroup,o=Br();return this.indexManager.getCollectionParents(t,s).next(a=>f.forEach(a,u=>{let c=function(h,d){return new qt(d,null,h.explicitOrderBy.slice(),h.filters.slice(),h.limit,h.limitType,h.startAt,h.endAt)}(e,u.child(s));return this.getDocumentsMatchingCollectionQuery(t,c,r,i).next(l=>{l.forEach((h,d)=>{o=o.insert(h,d)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,e,r,i){let s;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,r.largestBatchId).next(o=>(s=o,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,r,s,i))).next(o=>{s.forEach((u,c)=>{let l=c.getKey();o.get(l)===null&&(o=o.insert(l,ut.newInvalidDocument(l)))});let a=Br();return o.forEach((u,c)=>{let l=s.get(u);l!==void 0&&zr(l.mutation,c,bt.empty(),W.now()),yi(e,c)&&(a=a.insert(u,c))}),a})}};var Su=class{constructor(t){this.serializer=t,this.cr=new Map,this.lr=new Map}getBundleMetadata(t,e){return f.resolve(this.cr.get(e))}saveBundleMetadata(t,e){return this.cr.set(e.id,function(i){return{id:i.id,version:i.version,createTime:nt(i.createTime)}}(e)),f.resolve()}getNamedQuery(t,e){return f.resolve(this.lr.get(e))}saveNamedQuery(t,e){return this.lr.set(e.name,function(i){return{name:i.name,query:Dc(i.bundledQuery),readTime:nt(i.readTime)}}(e)),f.resolve()}};var Ru=class{constructor(){this.overlays=new $(I.comparator),this.hr=new Map}getOverlay(t,e){return f.resolve(this.overlays.get(e))}getOverlays(t,e){let r=Ht();return f.forEach(e,i=>this.getOverlay(t,i).next(s=>{s!==null&&r.set(i,s)})).next(()=>r)}saveOverlays(t,e,r){return r.forEach((i,s)=>{this.ht(t,e,s)}),f.resolve()}removeOverlaysForBatchId(t,e,r){let i=this.hr.get(r);return i!==void 0&&(i.forEach(s=>this.overlays=this.overlays.remove(s)),this.hr.delete(r)),f.resolve()}getOverlaysForCollection(t,e,r){let i=Ht(),s=e.length+1,o=new I(e.child("")),a=this.overlays.getIteratorFrom(o);for(;a.hasNext();){let u=a.getNext().value,c=u.getKey();if(!e.isPrefixOf(c.path))break;c.path.length===s&&u.largestBatchId>r&&i.set(u.getKey(),u)}return f.resolve(i)}getOverlaysForCollectionGroup(t,e,r,i){let s=new $((c,l)=>c-l),o=this.overlays.getIterator();for(;o.hasNext();){let c=o.getNext().value;if(c.getKey().getCollectionGroup()===e&&c.largestBatchId>r){let l=s.get(c.largestBatchId);l===null&&(l=Ht(),s=s.insert(c.largestBatchId,l)),l.set(c.getKey(),c)}}let a=Ht(),u=s.getIterator();for(;u.hasNext()&&(u.getNext().value.forEach((c,l)=>a.set(c,l)),!(a.size()>=i)););return f.resolve(a)}ht(t,e,r){let i=this.overlays.get(r.key);if(i!==null){let o=this.hr.get(i.largestBatchId).delete(r.key);this.hr.set(i.largestBatchId,o)}this.overlays=this.overlays.insert(r.key,new ei(e,r));let s=this.hr.get(e);s===void 0&&(s=D(),this.hr.set(e,s)),this.hr.set(e,s.add(r.key))}};var ai=class{constructor(){this.Pr=new j(st.Ir),this.Tr=new j(st.Er)}isEmpty(){return this.Pr.isEmpty()}addReference(t,e){let r=new st(t,e);this.Pr=this.Pr.add(r),this.Tr=this.Tr.add(r)}dr(t,e){t.forEach(r=>this.addReference(r,e))}removeReference(t,e){this.Ar(new st(t,e))}Rr(t,e){t.forEach(r=>this.removeReference(r,e))}Vr(t){let e=new I(new M([])),r=new st(e,t),i=new st(e,t+1),s=[];return this.Tr.forEachInRange([r,i],o=>{this.Ar(o),s.push(o.key)}),s}mr(){this.Pr.forEach(t=>this.Ar(t))}Ar(t){this.Pr=this.Pr.delete(t),this.Tr=this.Tr.delete(t)}gr(t){let e=new I(new M([])),r=new st(e,t),i=new st(e,t+1),s=D();return this.Tr.forEachInRange([r,i],o=>{s=s.add(o.key)}),s}containsKey(t){let e=new st(t,0),r=this.Pr.firstAfterOrEqual(e);return r!==null&&t.isEqual(r.key)}},st=class{constructor(t,e){this.key=t,this.pr=e}static Ir(t,e){return I.comparator(t.key,e.key)||V(t.pr,e.pr)}static Er(t,e){return V(t.pr,e.pr)||I.comparator(t.key,e.key)}};var Pu=class{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.yr=1,this.wr=new j(st.Ir)}checkEmpty(t){return f.resolve(this.mutationQueue.length===0)}addMutationBatch(t,e,r,i){let s=this.yr;this.yr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let o=new ti(s,e,r,i);this.mutationQueue.push(o);for(let a of i)this.wr=this.wr.add(new st(a.key,s)),this.indexManager.addToCollectionParentIndex(t,a.key.path.popLast());return f.resolve(o)}lookupMutationBatch(t,e){return f.resolve(this.Sr(e))}getNextMutationBatchAfterBatchId(t,e){let r=e+1,i=this.br(r),s=i<0?0:i;return f.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return f.resolve(this.mutationQueue.length===0?-1:this.yr-1)}getAllMutationBatches(t){return f.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){let r=new st(e,0),i=new st(e,Number.POSITIVE_INFINITY),s=[];return this.wr.forEachInRange([r,i],o=>{let a=this.Sr(o.pr);s.push(a)}),f.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let r=new j(V);return e.forEach(i=>{let s=new st(i,0),o=new st(i,Number.POSITIVE_INFINITY);this.wr.forEachInRange([s,o],a=>{r=r.add(a.pr)})}),f.resolve(this.Dr(r))}getAllMutationBatchesAffectingQuery(t,e){let r=e.path,i=r.length+1,s=r;I.isDocumentKey(s)||(s=s.child(""));let o=new st(new I(s),0),a=new j(V);return this.wr.forEachWhile(u=>{let c=u.key.path;return!!r.isPrefixOf(c)&&(c.length===i&&(a=a.add(u.pr)),!0)},o),f.resolve(this.Dr(a))}Dr(t){let e=[];return t.forEach(r=>{let i=this.Sr(r);i!==null&&e.push(i)}),e}removeMutationBatch(t,e){R(this.Cr(e.batchId,"removed")===0),this.mutationQueue.shift();let r=this.wr;return f.forEach(e.mutations,i=>{let s=new st(i.key,e.batchId);return r=r.delete(s),this.referenceDelegate.markPotentiallyOrphaned(t,i.key)}).next(()=>{this.wr=r})}Mn(t){}containsKey(t,e){let r=new st(e,0),i=this.wr.firstAfterOrEqual(r);return f.resolve(e.isEqual(i&&i.key))}performConsistencyCheck(t){return this.mutationQueue.length,f.resolve()}Cr(t,e){return this.br(t)}br(t){return this.mutationQueue.length===0?0:t-this.mutationQueue[0].batchId}Sr(t){let e=this.br(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}};var Cu=class{constructor(t){this.vr=t,this.docs=function(){return new $(I.comparator)}(),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){let r=e.key,i=this.docs.get(r),s=i?i.size:0,o=this.vr(e);return this.docs=this.docs.insert(r,{document:e.mutableCopy(),size:o}),this.size+=o-s,this.indexManager.addToCollectionParentIndex(t,r.path.popLast())}removeEntry(t){let e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){let r=this.docs.get(e);return f.resolve(r?r.document.mutableCopy():ut.newInvalidDocument(e))}getEntries(t,e){let r=Rt();return e.forEach(i=>{let s=this.docs.get(i);r=r.insert(i,s?s.document.mutableCopy():ut.newInvalidDocument(i))}),f.resolve(r)}getDocumentsMatchingQuery(t,e,r,i){let s=Rt(),o=e.path,a=new I(o.child("")),u=this.docs.getIteratorFrom(a);for(;u.hasNext();){let{key:c,value:{document:l}}=u.getNext();if(!o.isPrefixOf(c.path))break;c.path.length>o.length+1||Sc(wf(l),r)<=0||(i.has(l.key)||yi(e,l))&&(s=s.insert(l.key,l.mutableCopy()))}return f.resolve(s)}getAllFromCollectionGroup(t,e,r,i){S()}Fr(t,e){return f.forEach(this.docs,r=>e(r))}newChangeBuffer(t){return new bu(this)}getSize(t){return f.resolve(this.size)}},bu=class extends Fs{constructor(t){super(),this.ar=t}applyChanges(t){let e=[];return this.changes.forEach((r,i)=>{i.isValidDocument()?e.push(this.ar.addEntry(t,i)):this.ar.removeEntry(r)}),f.waitFor(e)}getFromCache(t,e){return this.ar.getEntry(t,e)}getAllFromCache(t,e){return this.ar.getEntries(t,e)}};var xu=class{constructor(t){this.persistence=t,this.Mr=new ee(e=>Ze(e),pi),this.lastRemoteSnapshotVersion=P.min(),this.highestTargetId=0,this.Or=0,this.Nr=new ai,this.targetCount=0,this.Lr=Kn.Nn()}forEachTarget(t,e){return this.Mr.forEach((r,i)=>e(i)),f.resolve()}getLastRemoteSnapshotVersion(t){return f.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return f.resolve(this.Or)}allocateTargetId(t){return this.highestTargetId=this.Lr.next(),f.resolve(this.highestTargetId)}setTargetsMetadata(t,e,r){return r&&(this.lastRemoteSnapshotVersion=r),e>this.Or&&(this.Or=e),f.resolve()}qn(t){this.Mr.set(t.target,t);let e=t.targetId;e>this.highestTargetId&&(this.Lr=new Kn(e),this.highestTargetId=e),t.sequenceNumber>this.Or&&(this.Or=t.sequenceNumber)}addTargetData(t,e){return this.qn(e),this.targetCount+=1,f.resolve()}updateTargetData(t,e){return this.qn(e),f.resolve()}removeTargetData(t,e){return this.Mr.delete(e.target),this.Nr.Vr(e.targetId),this.targetCount-=1,f.resolve()}removeTargets(t,e,r){let i=0,s=[];return this.Mr.forEach((o,a)=>{a.sequenceNumber<=e&&r.get(a.targetId)===null&&(this.Mr.delete(o),s.push(this.removeMatchingKeysForTargetId(t,a.targetId)),i++)}),f.waitFor(s).next(()=>i)}getTargetCount(t){return f.resolve(this.targetCount)}getTargetData(t,e){let r=this.Mr.get(e)||null;return f.resolve(r)}addMatchingKeys(t,e,r){return this.Nr.dr(e,r),f.resolve()}removeMatchingKeys(t,e,r){this.Nr.Rr(e,r);let i=this.persistence.referenceDelegate,s=[];return i&&e.forEach(o=>{s.push(i.markPotentiallyOrphaned(t,o))}),f.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.Nr.Vr(e),f.resolve()}getMatchingKeysForTargetId(t,e){let r=this.Nr.gr(e);return f.resolve(r)}containsKey(t,e){return f.resolve(this.Nr.containsKey(e))}};var Os=class{constructor(t,e){this.Br={},this.overlays={},this.kr=new Ct(0),this.qr=!1,this.qr=!0,this.referenceDelegate=t(this),this.Qr=new xu(this),this.indexManager=new gu,this.remoteDocumentCache=function(i){return new Cu(i)}(r=>this.referenceDelegate.Kr(r)),this.serializer=new Cs(e),this.$r=new Su(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.qr=!1,Promise.resolve()}get started(){return this.qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new Ru,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let r=this.Br[t.toKey()];return r||(r=new Pu(e,this.referenceDelegate),this.Br[t.toKey()]=r),r}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.$r}runTransaction(t,e,r){y("MemoryPersistence","Starting transaction:",t);let i=new Vu(this.kr.next());return this.referenceDelegate.Ur(),r(i).next(s=>this.referenceDelegate.Wr(i).next(()=>s)).toPromise().then(s=>(i.raiseOnCommittedEvent(),s))}Gr(t,e){return f.or(Object.values(this.Br).map(r=>()=>r.containsKey(t,e)))}},Vu=class extends ps{constructor(t){super(),this.currentSequenceNumber=t}},Ls=class n{constructor(t){this.persistence=t,this.zr=new ai,this.jr=null}static Hr(t){return new n(t)}get Jr(){if(this.jr)return this.jr;throw S()}addReference(t,e,r){return this.zr.addReference(r,e),this.Jr.delete(r.toString()),f.resolve()}removeReference(t,e,r){return this.zr.removeReference(r,e),this.Jr.add(r.toString()),f.resolve()}markPotentiallyOrphaned(t,e){return this.Jr.add(e.toString()),f.resolve()}removeTarget(t,e){this.zr.Vr(e.targetId).forEach(i=>this.Jr.add(i.toString()));let r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(t,e.targetId).next(i=>{i.forEach(s=>this.Jr.add(s.toString()))}).next(()=>r.removeTargetData(t,e))}Ur(){this.jr=new Set}Wr(t){let e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return f.forEach(this.Jr,r=>{let i=I.fromPath(r);return this.Yr(t,i).next(s=>{s||e.removeEntry(i,P.min())})}).next(()=>(this.jr=null,e.apply(t)))}updateLimboDocument(t,e){return this.Yr(t,e).next(r=>{r?this.Jr.delete(e.toString()):this.Jr.add(e.toString())})}Kr(t){return 0}Yr(t,e){return f.or([()=>f.resolve(this.zr.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Gr(t,e)])}};var Du=class{constructor(t){this.serializer=t}N(t,e,r,i){let s=new _s("createOrUpgrade",e);r<1&&i>=1&&(function(u){u.createObjectStore("owner")}(t),function(u){u.createObjectStore("mutationQueues",{keyPath:"userId"}),u.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",_d,{unique:!0}),u.createObjectStore("documentMutations")}(t),ef(t),function(u){u.createObjectStore("remoteDocuments")}(t));let o=f.resolve();return r<3&&i>=3&&(r!==0&&(function(u){u.deleteObjectStore("targetDocuments"),u.deleteObjectStore("targets"),u.deleteObjectStore("targetGlobal")}(t),ef(t)),o=o.next(()=>function(u){let c=u.store("targetGlobal"),l={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:P.min().toTimestamp(),targetCount:0};return c.put("targetGlobalKey",l)}(s))),r<4&&i>=4&&(r!==0&&(o=o.next(()=>function(u,c){return c.store("mutations").W().next(l=>{u.deleteObjectStore("mutations"),u.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",_d,{unique:!0});let h=c.store("mutations"),d=l.map(m=>h.put(m));return f.waitFor(d)})}(t,s))),o=o.next(()=>{(function(u){u.createObjectStore("clientMetadata",{keyPath:"clientId"})})(t)})),r<5&&i>=5&&(o=o.next(()=>this.Xr(s))),r<6&&i>=6&&(o=o.next(()=>(function(u){u.createObjectStore("remoteDocumentGlobal")}(t),this.ei(s)))),r<7&&i>=7&&(o=o.next(()=>this.ti(s))),r<8&&i>=8&&(o=o.next(()=>this.ni(t,s))),r<9&&i>=9&&(o=o.next(()=>{(function(u){u.objectStoreNames.contains("remoteDocumentChanges")&&u.deleteObjectStore("remoteDocumentChanges")})(t)})),r<10&&i>=10&&(o=o.next(()=>this.ri(s))),r<11&&i>=11&&(o=o.next(()=>{(function(u){u.createObjectStore("bundles",{keyPath:"bundleId"})})(t),function(u){u.createObjectStore("namedQueries",{keyPath:"name"})}(t)})),r<12&&i>=12&&(o=o.next(()=>{(function(u){let c=u.createObjectStore("documentOverlays",{keyPath:s_});c.createIndex("collectionPathOverlayIndex",o_,{unique:!1}),c.createIndex("collectionGroupOverlayIndex",a_,{unique:!1})})(t)})),r<13&&i>=13&&(o=o.next(()=>function(u){let c=u.createObjectStore("remoteDocumentsV14",{keyPath:Wp});c.createIndex("documentKeyIndex",Hp),c.createIndex("collectionGroupIndex",Yp)}(t)).next(()=>this.ii(t,s)).next(()=>t.deleteObjectStore("remoteDocuments"))),r<14&&i>=14&&(o=o.next(()=>this.si(t,s))),r<15&&i>=15&&(o=o.next(()=>function(u){u.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),u.createObjectStore("indexState",{keyPath:e_}).createIndex("sequenceNumberIndex",n_,{unique:!1}),u.createObjectStore("indexEntries",{keyPath:r_}).createIndex("documentKeyIndex",i_,{unique:!1})}(t))),r<16&&i>=16&&(o=o.next(()=>{e.objectStore("indexState").clear()}).next(()=>{e.objectStore("indexEntries").clear()})),o}ei(t){let e=0;return t.store("remoteDocuments").Y((r,i)=>{e+=Ns(i)}).next(()=>{let r={byteSize:e};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",r)})}Xr(t){let e=t.store("mutationQueues"),r=t.store("mutations");return e.W().next(i=>f.forEach(i,s=>{let o=IDBKeyRange.bound([s.userId,-1],[s.userId,s.lastAcknowledgedBatchId]);return r.W("userMutationsIndex",o).next(a=>f.forEach(a,u=>{R(u.userId===s.userId);let c=Ke(this.serializer,u);return pm(t,s.userId,c).next(()=>{})}))}))}ti(t){let e=t.store("targetDocuments"),r=t.store("remoteDocuments");return t.store("targetGlobal").get("targetGlobalKey").next(i=>{let s=[];return r.Y((o,a)=>{let u=new M(o),c=function(h){return[0,Tt(h)]}(u);s.push(e.get(c).next(l=>l?f.resolve():(h=>e.put({targetId:0,path:Tt(h),sequenceNumber:i.highestListenSequenceNumber}))(u)))}).next(()=>f.waitFor(s))})}ni(t,e){t.createObjectStore("collectionParents",{keyPath:t_});let r=e.store("collectionParents"),i=new oi,s=o=>{if(i.add(o)){let a=o.lastSegment(),u=o.popLast();return r.put({collectionId:a,parent:Tt(u)})}};return e.store("remoteDocuments").Y({J:!0},(o,a)=>{let u=new M(o);return s(u.popLast())}).next(()=>e.store("documentMutations").Y({J:!0},([o,a,u],c)=>{let l=Wt(a);return s(l.popLast())}))}ri(t){let e=t.store("targets");return e.Y((r,i)=>{let s=Ur(i),o=fm(this.serializer,s);return e.put(o)})}ii(t,e){let r=e.store("remoteDocuments"),i=[];return r.Y((s,o)=>{let a=e.store("remoteDocumentsV14"),u=function(h){return h.document?new I(M.fromString(h.document.name).popFirst(5)):h.noDocument?I.fromSegments(h.noDocument.path):h.unknownDocument?I.fromSegments(h.unknownDocument.path):S()}(o).path.toArray(),c={prefixPath:u.slice(0,u.length-2),collectionGroup:u[u.length-2],documentId:u[u.length-1],readTime:o.readTime||[0,0],unknownDocument:o.unknownDocument,noDocument:o.noDocument,document:o.document,hasCommittedMutations:!!o.hasCommittedMutations};i.push(a.put(c))}).next(()=>f.waitFor(i))}si(t,e){let r=e.store("mutations"),i=wm(this.serializer),s=new Os(Ls.Hr,this.serializer.ct);return r.W().next(o=>{let a=new Map;return o.forEach(u=>{var c;let l=(c=a.get(u.userId))!==null&&c!==void 0?c:D();Ke(this.serializer,u).keys().forEach(h=>l=l.add(h)),a.set(u.userId,l)}),f.forEach(a,(u,c)=>{let l=new ot(c),h=xs.lt(this.serializer,l),d=s.getIndexManager(l),m=ks.lt(l,this.serializer,d,s.referenceDelegate);return new Ms(i,m,h,d).recalculateAndSaveOverlaysForDocumentKeys(new Hr(e,Ct._e),u).next()})})}};function ef(n){n.createObjectStore("targetDocuments",{keyPath:Xp}).createIndex("documentTargetsIndex",Zp,{unique:!0}),n.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Jp,{unique:!0}),n.createObjectStore("targetGlobal")}var Ta="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",Nu=class n{constructor(t,e,r,i,s,o,a,u,c,l,h=16){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=r,this.oi=s,this.window=o,this.document=a,this._i=c,this.ai=l,this.ui=h,this.kr=null,this.qr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ci=null,this.inForeground=!1,this.li=null,this.hi=null,this.Pi=Number.NEGATIVE_INFINITY,this.Ii=d=>Promise.resolve(),!n.D())throw new _(g.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Iu(this,i),this.Ti=e+"main",this.serializer=new Cs(u),this.Ei=new ue(this.Ti,this.ui,new Du(this.serializer)),this.Qr=new _u(this.referenceDelegate,this.serializer),this.remoteDocumentCache=wm(this.serializer),this.$r=new uu,this.window&&this.window.localStorage?this.di=this.window.localStorage:(this.di=null,l===!1&&tt("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ai().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new _(g.FAILED_PRECONDITION,Ta);return this.Ri(),this.Vi(),this.mi(),this.runTransaction("getHighestListenSequenceNumber","readonly",t=>this.Qr.getHighestSequenceNumber(t))}).then(t=>{this.kr=new Ct(t,this._i)}).then(()=>{this.qr=!0}).catch(t=>(this.Ei&&this.Ei.close(),Promise.reject(t)))}fi(t){return this.Ii=e=>p(this,null,function*(){if(this.started)return t(e)}),t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ei.B(e=>p(this,null,function*(){e.newVersion===null&&(yield t())}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.oi.enqueueAndForget(()=>p(this,null,function*(){this.started&&(yield this.Ai())})))}Ai(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>ss(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.gi(t).next(e=>{e||(this.isPrimary=!1,this.oi.enqueueRetryable(()=>this.Ii(!1)))})}).next(()=>this.pi(t)).next(e=>this.isPrimary&&!e?this.yi(t).next(()=>!1):!!e&&this.wi(t).next(()=>!0))).catch(t=>{if(Fe(t))return y("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return y("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1}).then(t=>{this.isPrimary!==t&&this.oi.enqueueRetryable(()=>this.Ii(t)),this.isPrimary=t})}gi(t){return qr(t).get("owner").next(e=>f.resolve(this.Si(e)))}bi(t){return ss(t).delete(this.clientId)}Di(){return p(this,null,function*(){if(this.isPrimary&&!this.Ci(this.Pi,18e5)){this.Pi=Date.now();let t=yield this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let r=ft(e,"clientMetadata");return r.W().next(i=>{let s=this.vi(i,18e5),o=i.filter(a=>s.indexOf(a)===-1);return f.forEach(o,a=>r.delete(a.clientId)).next(()=>o)})}).catch(()=>[]);if(this.di)for(let e of t)this.di.removeItem(this.Fi(e.clientId))}})}mi(){this.hi=this.oi.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Ai().then(()=>this.Di()).then(()=>this.mi()))}Si(t){return!!t&&t.ownerId===this.clientId}pi(t){return this.ai?f.resolve(!0):qr(t).get("owner").next(e=>{if(e!==null&&this.Ci(e.leaseTimestampMs,5e3)&&!this.Mi(e.ownerId)){if(this.Si(e)&&this.networkEnabled)return!0;if(!this.Si(e)){if(!e.allowTabSynchronization)throw new _(g.FAILED_PRECONDITION,Ta);return!1}}return!(!this.networkEnabled||!this.inForeground)||ss(t).W().next(r=>this.vi(r,5e3).find(i=>{if(this.clientId!==i.clientId){let s=!this.networkEnabled&&i.networkEnabled,o=!this.inForeground&&i.inForeground,a=this.networkEnabled===i.networkEnabled;if(s||o&&a)return!0}return!1})===void 0)}).next(e=>(this.isPrimary!==e&&y("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}shutdown(){return p(this,null,function*(){this.qr=!1,this.xi(),this.hi&&(this.hi.cancel(),this.hi=null),this.Oi(),this.Ni(),yield this.Ei.runTransaction("shutdown","readwrite",["owner","clientMetadata"],t=>{let e=new Hr(t,Ct._e);return this.yi(e).next(()=>this.bi(e))}),this.Ei.close(),this.Li()})}vi(t,e){return t.filter(r=>this.Ci(r.updateTimeMs,e)&&!this.Mi(r.clientId))}Bi(){return this.runTransaction("getActiveClients","readonly",t=>ss(t).W().next(e=>this.vi(e,18e5).map(r=>r.clientId)))}get started(){return this.qr}getMutationQueue(t,e){return ks.lt(t,this.serializer,e,this.referenceDelegate)}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(t){return new pu(t,this.serializer.ct.databaseId)}getDocumentOverlayCache(t){return xs.lt(this.serializer,t)}getBundleCache(){return this.$r}runTransaction(t,e,r){y("IndexedDbPersistence","Starting transaction:",t);let i=e==="readonly"?"readonly":"readwrite",s=function(u){return u===16?c_:u===15?Rf:u===14?Sf:u===13?Af:u===12?u_:u===11?Tf:void S()}(this.ui),o;return this.Ei.runTransaction(t,i,s,a=>(o=new Hr(a,this.kr?this.kr.next():Ct._e),e==="readwrite-primary"?this.gi(o).next(u=>!!u||this.pi(o)).next(u=>{if(!u)throw tt(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.oi.enqueueRetryable(()=>this.Ii(!1)),new _(g.FAILED_PRECONDITION,vf);return r(o)}).next(u=>this.wi(o).next(()=>u)):this.ki(o).next(()=>r(o)))).then(a=>(o.raiseOnCommittedEvent(),a))}ki(t){return qr(t).get("owner").next(e=>{if(e!==null&&this.Ci(e.leaseTimestampMs,5e3)&&!this.Mi(e.ownerId)&&!this.Si(e)&&!(this.ai||this.allowTabSynchronization&&e.allowTabSynchronization))throw new _(g.FAILED_PRECONDITION,Ta)})}wi(t){let e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return qr(t).put("owner",e)}static D(){return ue.D()}yi(t){let e=qr(t);return e.get("owner").next(r=>this.Si(r)?(y("IndexedDbPersistence","Releasing primary lease."),e.delete("owner")):f.resolve())}Ci(t,e){let r=Date.now();return!(t<r-e)&&(!(t>r)||(tt(`Detected an update time that is in the future: ${t} > ${r}`),!1))}Ri(){this.document!==null&&typeof this.document.addEventListener=="function"&&(this.li=()=>{this.oi.enqueueAndForget(()=>(this.inForeground=this.document.visibilityState==="visible",this.Ai()))},this.document.addEventListener("visibilitychange",this.li),this.inForeground=this.document.visibilityState==="visible")}Oi(){this.li&&(this.document.removeEventListener("visibilitychange",this.li),this.li=null)}Vi(){var t;typeof((t=this.window)===null||t===void 0?void 0:t.addEventListener)=="function"&&(this.ci=()=>{this.xi();let e=/(?:Version|Mobile)\/1[456]/;Co()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.oi.enterRestrictedMode(!0),this.oi.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.ci))}Ni(){this.ci&&(this.window.removeEventListener("pagehide",this.ci),this.ci=null)}Mi(t){var e;try{let r=((e=this.di)===null||e===void 0?void 0:e.getItem(this.Fi(t)))!==null;return y("IndexedDbPersistence",`Client '${t}' ${r?"is":"is not"} zombied in LocalStorage`),r}catch(r){return tt("IndexedDbPersistence","Failed to get zombied client id.",r),!1}}xi(){if(this.di)try{this.di.setItem(this.Fi(this.clientId),String(Date.now()))}catch(t){tt("Failed to set zombie client id.",t)}}Li(){if(this.di)try{this.di.removeItem(this.Fi(this.clientId))}catch{}}Fi(t){return`firestore_zombie_${this.persistenceKey}_${t}`}};function qr(n){return ft(n,"owner")}function ss(n){return ft(n,"clientMetadata")}function kc(n,t){let e=n.projectId;return n.isDefaultDatabase||(e+="."+n.database),"firestore/"+t+"/"+e+"/"}var ku=class n{constructor(t,e,r,i){this.targetId=t,this.fromCache=e,this.qi=r,this.Qi=i}static Ki(t,e){let r=D(),i=D();for(let s of e.docChanges)switch(s.type){case 0:r=r.add(s.doc.key);break;case 1:i=i.add(s.doc.key)}return new n(t,e.fromCache,r,i)}};var Fu=class{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}};var qs=class{constructor(){this.$i=!1,this.Ui=!1,this.Wi=100,this.Gi=function(){return Co()?8:ue.v(dr())>0?6:4}()}initialize(t,e){this.zi=t,this.indexManager=e,this.$i=!0}getDocumentsMatchingQuery(t,e,r,i){let s={result:null};return this.ji(t,e).next(o=>{s.result=o}).next(()=>{if(!s.result)return this.Hi(t,e,i,r).next(o=>{s.result=o})}).next(()=>{if(s.result)return;let o=new Fu;return this.Ji(t,e,o).next(a=>{if(s.result=a,this.Ui)return this.Yi(t,e,o,a.size)})}).next(()=>s.result)}Yi(t,e,r,i){return r.documentReadCount<this.Wi?(Cn()<=zt.DEBUG&&y("QueryEngine","SDK will not create cache indexes for query:",bn(e),"since it only creates cache indexes for collection contains","more than or equal to",this.Wi,"documents"),f.resolve()):(Cn()<=zt.DEBUG&&y("QueryEngine","Query:",bn(e),"scans",r.documentReadCount,"local documents and returns",i,"documents as results."),r.documentReadCount>this.Gi*i?(Cn()<=zt.DEBUG&&y("QueryEngine","The SDK decides to create cache indexes for query:",bn(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,At(e))):f.resolve())}ji(t,e){if(Cd(e))return f.resolve(null);let r=At(e);return this.indexManager.getIndexType(t,r).next(i=>i===0?null:(e.limit!==null&&i===1&&(e=As(e,null,"F"),r=At(e)),this.indexManager.getDocumentsMatchingTarget(t,r).next(s=>{let o=D(...s);return this.zi.getDocuments(t,o).next(a=>this.indexManager.getMinOffset(t,r).next(u=>{let c=this.Zi(e,a);return this.Xi(e,c,o,u.readTime)?this.ji(t,As(e,null,"F")):this.es(t,c,e,u)}))})))}Hi(t,e,r,i){return Cd(e)||i.isEqual(P.min())?f.resolve(null):this.zi.getDocuments(t,r).next(s=>{let o=this.Zi(e,s);return this.Xi(e,o,r,i)?f.resolve(null):(Cn()<=zt.DEBUG&&y("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),bn(e)),this.es(t,o,e,yf(i,-1)).next(a=>a))})}Zi(t,e){let r=new j(qf(t));return e.forEach((i,s)=>{yi(t,s)&&(r=r.add(s))}),r}Xi(t,e,r,i){if(t.limit===null)return!1;if(r.size!==e.size)return!0;let s=t.limitType==="F"?e.last():e.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(i)>0)}Ji(t,e,r){return Cn()<=zt.DEBUG&&y("QueryEngine","Using full collection scan to execute query:",bn(e)),this.zi.getDocumentsMatchingQuery(t,e,Ft.min(),r)}es(t,e,r,i){return this.zi.getDocumentsMatchingQuery(t,r,i).next(s=>(e.forEach(o=>{s=s.insert(o.key,o)}),s))}};var Mu=class{constructor(t,e,r,i){this.persistence=t,this.ts=e,this.serializer=i,this.ns=new $(V),this.rs=new ee(s=>Ze(s),pi),this.ss=new Map,this.os=t.getRemoteDocumentCache(),this.Qr=t.getTargetCache(),this.$r=t.getBundleCache(),this._s(r)}_s(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new Ms(this.os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.os.setIndexManager(this.indexManager),this.ts.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.ns))}};function vm(n,t,e,r){return new Mu(n,t,e,r)}function Im(n,t){return p(this,null,function*(){let e=E(n);return yield e.persistence.runTransaction("Handle user change","readonly",r=>{let i;return e.mutationQueue.getAllMutationBatches(r).next(s=>(i=s,e._s(t),e.mutationQueue.getAllMutationBatches(r))).next(s=>{let o=[],a=[],u=D();for(let c of i){o.push(c.batchId);for(let l of c.mutations)u=u.add(l.key)}for(let c of s){a.push(c.batchId);for(let l of c.mutations)u=u.add(l.key)}return e.localDocuments.getDocuments(r,u).next(c=>({us:c,removedBatchIds:o,addedBatchIds:a}))})})})}function G_(n,t){let e=E(n);return e.persistence.runTransaction("Acknowledge batch","readwrite-primary",r=>{let i=t.batch.keys(),s=e.os.newChangeBuffer({trackRemovals:!0});return function(a,u,c,l){let h=c.batch,d=h.keys(),m=f.resolve();return d.forEach(A=>{m=m.next(()=>l.getEntry(u,A)).next(w=>{let v=c.docVersions.get(A);R(v!==null),w.version.compareTo(v)<0&&(h.applyToRemoteDocument(w,c),w.isValidDocument()&&(w.setReadTime(c.commitVersion),l.addEntry(w)))})}),m.next(()=>a.mutationQueue.removeMutationBatch(u,h))}(e,r,t,s).next(()=>s.apply(r)).next(()=>e.mutationQueue.performConsistencyCheck(r)).next(()=>e.documentOverlayCache.removeOverlaysForBatchId(r,i,t.batch.batchId)).next(()=>e.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(r,function(a){let u=D();for(let c=0;c<a.mutationResults.length;++c)a.mutationResults[c].transformResults.length>0&&(u=u.add(a.batch.mutations[c].key));return u}(t))).next(()=>e.localDocuments.getDocuments(r,i))})}function Em(n){let t=E(n);return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Qr.getLastRemoteSnapshotVersion(e))}function j_(n,t){let e=E(n),r=t.snapshotVersion,i=e.ns;return e.persistence.runTransaction("Apply remote event","readwrite-primary",s=>{let o=e.os.newChangeBuffer({trackRemovals:!0});i=e.ns;let a=[];t.targetChanges.forEach((l,h)=>{let d=i.get(h);if(!d)return;a.push(e.Qr.removeMatchingKeys(s,l.removedDocuments,h).next(()=>e.Qr.addMatchingKeys(s,l.addedDocuments,h)));let m=d.withSequenceNumber(s.currentSequenceNumber);t.targetMismatches.get(h)!==null?m=m.withResumeToken(dt.EMPTY_BYTE_STRING,P.min()).withLastLimboFreeSnapshotVersion(P.min()):l.resumeToken.approximateByteSize()>0&&(m=m.withResumeToken(l.resumeToken,r)),i=i.insert(h,m),function(w,v,C){return w.resumeToken.approximateByteSize()===0||v.snapshotVersion.toMicroseconds()-w.snapshotVersion.toMicroseconds()>=3e8?!0:C.addedDocuments.size+C.modifiedDocuments.size+C.removedDocuments.size>0}(d,m,l)&&a.push(e.Qr.updateTargetData(s,m))});let u=Rt(),c=D();if(t.documentUpdates.forEach(l=>{t.resolvedLimboDocuments.has(l)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(s,l))}),a.push(Tm(s,o,t.documentUpdates).next(l=>{u=l.cs,c=l.ls})),!r.isEqual(P.min())){let l=e.Qr.getLastRemoteSnapshotVersion(s).next(h=>e.Qr.setTargetsMetadata(s,s.currentSequenceNumber,r));a.push(l)}return f.waitFor(a).next(()=>o.apply(s)).next(()=>e.localDocuments.getLocalViewOfDocuments(s,u,c)).next(()=>u)}).then(s=>(e.ns=i,s))}function Tm(n,t,e){let r=D(),i=D();return e.forEach(s=>r=r.add(s)),t.getEntries(n,r).next(s=>{let o=Rt();return e.forEach((a,u)=>{let c=s.get(a);u.isFoundDocument()!==c.isFoundDocument()&&(i=i.add(a)),u.isNoDocument()&&u.version.isEqual(P.min())?(t.removeEntry(a,u.readTime),o=o.insert(a,u)):!c.isValidDocument()||u.version.compareTo(c.version)>0||u.version.compareTo(c.version)===0&&c.hasPendingWrites?(t.addEntry(u),o=o.insert(a,u)):y("LocalStore","Ignoring outdated watch update for ",a,". Current version:",c.version," Watch version:",u.version)}),{cs:o,ls:i}})}function z_(n,t){let e=E(n);return e.persistence.runTransaction("Get next mutation batch","readonly",r=>(t===void 0&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(r,t)))}function $n(n,t){let e=E(n);return e.persistence.runTransaction("Allocate target","readwrite",r=>{let i;return e.Qr.getTargetData(r,t).next(s=>s?(i=s,f.resolve(i)):e.Qr.allocateTargetId(r).next(o=>(i=new zn(t,o,"TargetPurposeListen",r.currentSequenceNumber),e.Qr.addTargetData(r,i).next(()=>i))))}).then(r=>{let i=e.ns.get(r.targetId);return(i===null||r.snapshotVersion.compareTo(i.snapshotVersion)>0)&&(e.ns=e.ns.insert(r.targetId,r),e.rs.set(t,r.targetId)),r})}function Qn(n,t,e){return p(this,null,function*(){let r=E(n),i=r.ns.get(t),s=e?"readwrite":"readwrite-primary";try{e||(yield r.persistence.runTransaction("Release target",s,o=>r.persistence.referenceDelegate.removeTarget(o,i)))}catch(o){if(!Fe(o))throw o;y("LocalStore",`Failed to update sequence numbers for target ${t}: ${o}`)}r.ns=r.ns.remove(t),r.rs.delete(i.target)})}function Bs(n,t,e){let r=E(n),i=P.min(),s=D();return r.persistence.runTransaction("Execute query","readwrite",o=>function(u,c,l){let h=E(u),d=h.rs.get(l);return d!==void 0?f.resolve(h.ns.get(d)):h.Qr.getTargetData(c,l)}(r,o,At(t)).next(a=>{if(a)return i=a.lastLimboFreeSnapshotVersion,r.Qr.getMatchingKeysForTargetId(o,a.targetId).next(u=>{s=u})}).next(()=>r.ts.getDocumentsMatchingQuery(o,t,e?i:P.min(),e?s:D())).next(a=>(Rm(r,Lf(t),a),{documents:a,hs:s})))}function Am(n,t){let e=E(n),r=E(e.Qr),i=e.ns.get(t);return i?Promise.resolve(i.target):e.persistence.runTransaction("Get target data","readonly",s=>r._t(s,t).next(o=>o?o.target:null))}function Sm(n,t){let e=E(n),r=e.ss.get(t)||P.min();return e.persistence.runTransaction("Get new document changes","readonly",i=>e.os.getAllFromCollectionGroup(i,t,yf(r,-1),Number.MAX_SAFE_INTEGER)).then(i=>(Rm(e,t,i),i))}function Rm(n,t,e){let r=n.ss.get(t)||P.min();e.forEach((i,s)=>{s.readTime.compareTo(r)>0&&(r=s.readTime)}),n.ss.set(t,r)}function K_(n,t,e,r){return p(this,null,function*(){let i=E(n),s=D(),o=Rt();for(let c of e){let l=t.Ps(c.metadata.name);c.document&&(s=s.add(l));let h=t.Is(c);h.setReadTime(t.Ts(c.metadata.readTime)),o=o.insert(l,h)}let a=i.os.newChangeBuffer({trackRemovals:!0}),u=yield $n(i,function(l){return At(er(M.fromString(`__bundle__/docs/${l}`)))}(r));return i.persistence.runTransaction("Apply bundle documents","readwrite",c=>Tm(c,a,o).next(l=>(a.apply(c),l)).next(l=>i.Qr.removeMatchingKeysForTargetId(c,u.targetId).next(()=>i.Qr.addMatchingKeys(c,s,u.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(c,l.cs,l.ls)).next(()=>l.cs)))})}function $_(r,i){return p(this,arguments,function*(n,t,e=D()){let s=yield $n(n,At(Dc(t.bundledQuery))),o=E(n);return o.persistence.runTransaction("Save named query","readwrite",a=>{let u=nt(t.readTime);if(s.snapshotVersion.compareTo(u)>=0)return o.$r.saveNamedQuery(a,t);let c=s.withResumeToken(dt.EMPTY_BYTE_STRING,u);return o.ns=o.ns.insert(c.targetId,c),o.Qr.updateTargetData(a,c).next(()=>o.Qr.removeMatchingKeysForTargetId(a,s.targetId)).next(()=>o.Qr.addMatchingKeys(a,e,s.targetId)).next(()=>o.$r.saveNamedQuery(a,t))})})}function nf(n,t){return`firestore_clients_${n}_${t}`}function rf(n,t,e){let r=`firestore_mutations_${n}_${e}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function Aa(n,t){return`firestore_targets_${n}_${t}`}var Us=class n{constructor(t,e,r,i){this.user=t,this.batchId=e,this.state=r,this.error=i}static Es(t,e,r){let i=JSON.parse(r),s,o=typeof i=="object"&&["pending","acknowledged","rejected"].indexOf(i.state)!==-1&&(i.error===void 0||typeof i.error=="object");return o&&i.error&&(o=typeof i.error.message=="string"&&typeof i.error.code=="string",o&&(s=new _(i.error.code,i.error.message))),o?new n(t,e,i.state,s):(tt("SharedClientState",`Failed to parse mutation state for ID '${e}': ${r}`),null)}ds(){let t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}},Kr=class n{constructor(t,e,r){this.targetId=t,this.state=e,this.error=r}static Es(t,e){let r=JSON.parse(e),i,s=typeof r=="object"&&["not-current","current","rejected"].indexOf(r.state)!==-1&&(r.error===void 0||typeof r.error=="object");return s&&r.error&&(s=typeof r.error.message=="string"&&typeof r.error.code=="string",s&&(i=new _(r.error.code,r.error.message))),s?new n(t,r.state,i):(tt("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}ds(){let t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}},Gs=class n{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Es(t,e){let r=JSON.parse(e),i=typeof r=="object"&&r.activeTargetIds instanceof Array,s=xc();for(let o=0;i&&o<r.activeTargetIds.length;++o)i=If(r.activeTargetIds[o]),s=s.add(r.activeTargetIds[o]);return i?new n(t,s):(tt("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}},Ou=class n{constructor(t,e){this.clientId=t,this.onlineState=e}static Es(t){let e=JSON.parse(t);return typeof e=="object"&&["Unknown","Online","Offline"].indexOf(e.onlineState)!==-1&&typeof e.clientId=="string"?new n(e.clientId,e.onlineState):(tt("SharedClientState",`Failed to parse online state: ${t}`),null)}},ui=class{constructor(){this.activeTargetIds=xc()}As(t){this.activeTargetIds=this.activeTargetIds.add(t)}Rs(t){this.activeTargetIds=this.activeTargetIds.delete(t)}ds(){let t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}},$r=class{constructor(t,e,r,i,s){this.window=t,this.oi=e,this.persistenceKey=r,this.Vs=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.fs=this.gs.bind(this),this.ps=new $(V),this.started=!1,this.ys=[];let o=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ws=nf(this.persistenceKey,this.Vs),this.Ss=function(u){return`firestore_sequence_number_${u}`}(this.persistenceKey),this.ps=this.ps.insert(this.Vs,new ui),this.bs=new RegExp(`^firestore_clients_${o}_([^_]*)$`),this.Ds=new RegExp(`^firestore_mutations_${o}_(\\d+)(?:_(.*))?$`),this.Cs=new RegExp(`^firestore_targets_${o}_(\\d+)$`),this.vs=function(u){return`firestore_online_state_${u}`}(this.persistenceKey),this.Fs=function(u){return`firestore_bundle_loaded_v2_${u}`}(this.persistenceKey),this.window.addEventListener("storage",this.fs)}static D(t){return!(!t||!t.localStorage)}start(){return p(this,null,function*(){let t=yield this.syncEngine.Bi();for(let r of t){if(r===this.Vs)continue;let i=this.getItem(nf(this.persistenceKey,r));if(i){let s=Gs.Es(r,i);s&&(this.ps=this.ps.insert(s.clientId,s))}}this.Ms();let e=this.storage.getItem(this.vs);if(e){let r=this.xs(e);r&&this.Os(r)}for(let r of this.ys)this.gs(r);this.ys=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0})}writeSequenceNumber(t){this.setItem(this.Ss,JSON.stringify(t))}getAllActiveQueryTargets(){return this.Ns(this.ps)}isActiveQueryTarget(t){let e=!1;return this.ps.forEach((r,i)=>{i.activeTargetIds.has(t)&&(e=!0)}),e}addPendingMutation(t){this.Ls(t,"pending")}updateMutationState(t,e,r){this.Ls(t,e,r),this.Bs(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){let r=this.storage.getItem(Aa(this.persistenceKey,t));if(r){let i=Kr.Es(t,r);i&&(e=i.state)}}return this.ks.As(t),this.Ms(),e}removeLocalQueryTarget(t){this.ks.Rs(t),this.Ms()}isLocalQueryTarget(t){return this.ks.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(Aa(this.persistenceKey,t))}updateQueryState(t,e,r){this.qs(t,e,r)}handleUserChange(t,e,r){e.forEach(i=>{this.Bs(i)}),this.currentUser=t,r.forEach(i=>{this.addPendingMutation(i)})}setOnlineState(t){this.Qs(t)}notifyBundleLoaded(t){this.Ks(t)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.fs),this.removeItem(this.ws),this.started=!1)}getItem(t){let e=this.storage.getItem(t);return y("SharedClientState","READ",t,e),e}setItem(t,e){y("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){y("SharedClientState","REMOVE",t),this.storage.removeItem(t)}gs(t){let e=t;if(e.storageArea===this.storage){if(y("SharedClientState","EVENT",e.key,e.newValue),e.key===this.ws)return void tt("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.oi.enqueueRetryable(()=>p(this,null,function*(){if(this.started){if(e.key!==null){if(this.bs.test(e.key)){if(e.newValue==null){let r=this.$s(e.key);return this.Us(r,null)}{let r=this.Ws(e.key,e.newValue);if(r)return this.Us(r.clientId,r)}}else if(this.Ds.test(e.key)){if(e.newValue!==null){let r=this.Gs(e.key,e.newValue);if(r)return this.zs(r)}}else if(this.Cs.test(e.key)){if(e.newValue!==null){let r=this.js(e.key,e.newValue);if(r)return this.Hs(r)}}else if(e.key===this.vs){if(e.newValue!==null){let r=this.xs(e.newValue);if(r)return this.Os(r)}}else if(e.key===this.Ss){let r=function(s){let o=Ct._e;if(s!=null)try{let a=JSON.parse(s);R(typeof a=="number"),o=a}catch(a){tt("SharedClientState","Failed to read sequence number from WebStorage",a)}return o}(e.newValue);r!==Ct._e&&this.sequenceNumberHandler(r)}else if(e.key===this.Fs){let r=this.Js(e.newValue);yield Promise.all(r.map(i=>this.syncEngine.Ys(i)))}}}else this.ys.push(e)}))}}get ks(){return this.ps.get(this.Vs)}Ms(){this.setItem(this.ws,this.ks.ds())}Ls(t,e,r){let i=new Us(this.currentUser,t,e,r),s=rf(this.persistenceKey,this.currentUser,t);this.setItem(s,i.ds())}Bs(t){let e=rf(this.persistenceKey,this.currentUser,t);this.removeItem(e)}Qs(t){let e={clientId:this.Vs,onlineState:t};this.storage.setItem(this.vs,JSON.stringify(e))}qs(t,e,r){let i=Aa(this.persistenceKey,t),s=new Kr(t,e,r);this.setItem(i,s.ds())}Ks(t){let e=JSON.stringify(Array.from(t));this.setItem(this.Fs,e)}$s(t){let e=this.bs.exec(t);return e?e[1]:null}Ws(t,e){let r=this.$s(t);return Gs.Es(r,e)}Gs(t,e){let r=this.Ds.exec(t),i=Number(r[1]),s=r[2]!==void 0?r[2]:null;return Us.Es(new ot(s),i,e)}js(t,e){let r=this.Cs.exec(t),i=Number(r[1]);return Kr.Es(i,e)}xs(t){return Ou.Es(t)}Js(t){return JSON.parse(t)}zs(t){return p(this,null,function*(){if(t.user.uid===this.currentUser.uid)return this.syncEngine.Zs(t.batchId,t.state,t.error);y("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)})}Hs(t){return this.syncEngine.Xs(t.targetId,t.state,t.error)}Us(t,e){let r=e?this.ps.insert(t,e):this.ps.remove(t),i=this.Ns(this.ps),s=this.Ns(r),o=[],a=[];return s.forEach(u=>{i.has(u)||o.push(u)}),i.forEach(u=>{s.has(u)||a.push(u)}),this.syncEngine.eo(o,a).then(()=>{this.ps=r})}Os(t){this.ps.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}Ns(t){let e=xc();return t.forEach((r,i)=>{e=e.unionWith(i.activeTargetIds)}),e}},js=class{constructor(){this.no=new ui,this.ro={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,r){}addLocalQueryTarget(t){return this.no.As(t),this.ro[t]||"not-current"}updateQueryState(t,e,r){this.ro[t]=e}removeLocalQueryTarget(t){this.no.Rs(t)}isLocalQueryTarget(t){return this.no.activeTargetIds.has(t)}clearQueryState(t){delete this.ro[t]}getAllActiveQueryTargets(){return this.no.activeTargetIds}isActiveQueryTarget(t){return this.no.activeTargetIds.has(t)}start(){return this.no=new ui,Promise.resolve()}handleUserChange(t,e,r){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}};var Lu=class{io(t){}shutdown(){}};var zs=class{constructor(){this.so=()=>this.oo(),this._o=()=>this.ao(),this.uo=[],this.co()}io(t){this.uo.push(t)}shutdown(){window.removeEventListener("online",this.so),window.removeEventListener("offline",this._o)}co(){window.addEventListener("online",this.so),window.addEventListener("offline",this._o)}oo(){y("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(let t of this.uo)t(0)}ao(){y("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(let t of this.uo)t(1)}static D(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}};var os=null;function Sa(){return os===null?os=function(){return 268435456+Math.round(2147483648*Math.random())}():os++,"0x"+os.toString(16)}var Q_={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};var qu=class{constructor(t){this.lo=t.lo,this.ho=t.ho}Po(t){this.Io=t}To(t){this.Eo=t}onMessage(t){this.Ao=t}close(){this.ho()}send(t){this.lo(t)}Ro(){this.Io()}Vo(t){this.Eo(t)}mo(t){this.Ao(t)}};var vt="WebChannelConnection",Bu=class extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let r=e.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),s=encodeURIComponent(this.databaseId.database);this.fo=r+"://"+e.host,this.po=`projects/${i}/databases/${s}`,this.yo=this.databaseId.database==="(default)"?`project_id=${i}`:`project_id=${i}&database_id=${s}`}get wo(){return!1}So(e,r,i,s,o){let a=Sa(),u=this.bo(e,r.toUriEncodedString());y("RestConnection",`Sending RPC '${e}' ${a}:`,u,i);let c={"google-cloud-resource-prefix":this.po,"x-goog-request-params":this.yo};return this.Do(c,s,o),this.Co(e,u,c,i).then(l=>(y("RestConnection",`Received RPC '${e}' ${a}: `,l),l),l=>{throw kt("RestConnection",`RPC '${e}' ${a} failed with error: `,l,"url: ",u,"request:",i),l})}vo(e,r,i,s,o,a){return this.So(e,r,i,s,o)}Do(e,r,i){e["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+tr}(),e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),r&&r.headers.forEach((s,o)=>e[o]=s),i&&i.headers.forEach((s,o)=>e[o]=s)}bo(e,r){let i=Q_[e];return`${this.fo}/v1/${r}:${i}`}terminate(){}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}Co(t,e,r,i){let s=Sa();return new Promise((o,a)=>{let u=new dd;u.setWithCredentials(!0),u.listenOnce(ld.COMPLETE,()=>{try{switch(u.getLastErrorCode()){case ns.NO_ERROR:let l=u.getResponseJson();y(vt,`XHR for RPC '${t}' ${s} received:`,JSON.stringify(l)),o(l);break;case ns.TIMEOUT:y(vt,`RPC '${t}' ${s} timed out`),a(new _(g.DEADLINE_EXCEEDED,"Request time out"));break;case ns.HTTP_ERROR:let h=u.getStatus();if(y(vt,`RPC '${t}' ${s} failed with status:`,h,"response text:",u.getResponseText()),h>0){let d=u.getResponseJson();Array.isArray(d)&&(d=d[0]);let m=d?.error;if(m&&m.status&&m.message){let A=function(v){let C=v.toLowerCase().replace(/_/g,"-");return Object.values(g).indexOf(C)>=0?C:g.UNKNOWN}(m.status);a(new _(A,m.message))}else a(new _(g.UNKNOWN,"Server responded with status "+u.getStatus()))}else a(new _(g.UNAVAILABLE,"Connection failed."));break;default:S()}}finally{y(vt,`RPC '${t}' ${s} completed.`)}});let c=JSON.stringify(i);y(vt,`RPC '${t}' ${s} sending request:`,i),u.send(e,"POST",c,r,15)})}Fo(t,e,r){let i=Sa(),s=[this.fo,"/","google.firestore.v1.Firestore","/",t,"/channel"],o=ud(),a=cd(),u={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;c!==void 0&&(u.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(u.useFetchStreams=!0),this.Do(u.initMessageHeaders,e,r),u.encodeInitMessageHeaders=!0;let l=s.join("");y(vt,`Creating RPC '${t}' stream ${i}: ${l}`,u);let h=o.createWebChannel(l,u),d=!1,m=!1,A=new qu({lo:v=>{m?y(vt,`Not sending because RPC '${t}' stream ${i} is closed:`,v):(d||(y(vt,`Opening RPC '${t}' stream ${i} transport.`),h.open(),d=!0),y(vt,`RPC '${t}' stream ${i} sending:`,v),h.send(v))},ho:()=>h.close()}),w=(v,C,N)=>{v.listen(C,b=>{try{N(b)}catch(q){setTimeout(()=>{throw q},0)}})};return w(h,Fr.EventType.OPEN,()=>{m||y(vt,`RPC '${t}' stream ${i} transport opened.`)}),w(h,Fr.EventType.CLOSE,()=>{m||(m=!0,y(vt,`RPC '${t}' stream ${i} transport closed`),A.Vo())}),w(h,Fr.EventType.ERROR,v=>{m||(m=!0,kt(vt,`RPC '${t}' stream ${i} transport errored:`,v),A.Vo(new _(g.UNAVAILABLE,"The operation could not be completed")))}),w(h,Fr.EventType.MESSAGE,v=>{var C;if(!m){let N=v.data[0];R(!!N);let b=N,q=b.error||((C=b[0])===null||C===void 0?void 0:C.error);if(q){y(vt,`RPC '${t}' stream ${i} received error:`,q);let B=q.status,L=function($g){let yl=it[$g];if(yl!==void 0)return Zf(yl)}(B),rt=q.message;L===void 0&&(L=g.INTERNAL,rt="Unknown error status: "+B+" with message "+q.message),m=!0,A.Vo(new _(L,rt)),h.close()}else y(vt,`RPC '${t}' stream ${i} received:`,N),A.mo(N)}}),w(a,hd.STAT_EVENT,v=>{v.stat===Ia.PROXY?y(vt,`RPC '${t}' stream ${i} detected buffering proxy`):v.stat===Ia.NOPROXY&&y(vt,`RPC '${t}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{A.Ro()},0),A}};function Pm(){return typeof window<"u"?window:null}function hs(){return typeof document<"u"?document:null}function wi(n){return new ru(n,!0)}var ci=class{constructor(t,e,r=1e3,i=1.5,s=6e4){this.oi=t,this.timerId=e,this.Mo=r,this.xo=i,this.Oo=s,this.No=0,this.Lo=null,this.Bo=Date.now(),this.reset()}reset(){this.No=0}ko(){this.No=this.Oo}qo(t){this.cancel();let e=Math.floor(this.No+this.Qo()),r=Math.max(0,Date.now()-this.Bo),i=Math.max(0,e-r);i>0&&y("ExponentialBackoff",`Backing off for ${i} ms (base delay: ${this.No} ms, delay with jitter: ${e} ms, last attempt: ${r} ms ago)`),this.Lo=this.oi.enqueueAfterDelay(this.timerId,i,()=>(this.Bo=Date.now(),t())),this.No*=this.xo,this.No<this.Mo&&(this.No=this.Mo),this.No>this.Oo&&(this.No=this.Oo)}Ko(){this.Lo!==null&&(this.Lo.skipDelay(),this.Lo=null)}cancel(){this.Lo!==null&&(this.Lo.cancel(),this.Lo=null)}Qo(){return(Math.random()-.5)*this.No}};var Ks=class{constructor(t,e,r,i,s,o,a,u){this.oi=t,this.$o=r,this.Uo=i,this.connection=s,this.authCredentialsProvider=o,this.appCheckCredentialsProvider=a,this.listener=u,this.state=0,this.Wo=0,this.Go=null,this.zo=null,this.stream=null,this.jo=new ci(t,e)}Ho(){return this.state===1||this.state===5||this.Jo()}Jo(){return this.state===2||this.state===3}start(){this.state!==4?this.auth():this.Yo()}stop(){return p(this,null,function*(){this.Ho()&&(yield this.close(0))})}Zo(){this.state=0,this.jo.reset()}Xo(){this.Jo()&&this.Go===null&&(this.Go=this.oi.enqueueAfterDelay(this.$o,6e4,()=>this.e_()))}t_(t){this.n_(),this.stream.send(t)}e_(){return p(this,null,function*(){if(this.Jo())return this.close(0)})}n_(){this.Go&&(this.Go.cancel(),this.Go=null)}r_(){this.zo&&(this.zo.cancel(),this.zo=null)}close(t,e){return p(this,null,function*(){this.n_(),this.r_(),this.jo.cancel(),this.Wo++,t!==4?this.jo.reset():e&&e.code===g.RESOURCE_EXHAUSTED?(tt(e.toString()),tt("Using maximum backoff delay to prevent overloading the backend."),this.jo.ko()):e&&e.code===g.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.i_(),this.stream.close(),this.stream=null),this.state=t,yield this.listener.To(e)})}i_(){}auth(){this.state=1;let t=this.s_(this.Wo),e=this.Wo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([r,i])=>{this.Wo===e&&this.o_(r,i)},r=>{t(()=>{let i=new _(g.UNKNOWN,"Fetching auth token failed: "+r.message);return this.__(i)})})}o_(t,e){let r=this.s_(this.Wo);this.stream=this.a_(t,e),this.stream.Po(()=>{r(()=>(this.state=2,this.zo=this.oi.enqueueAfterDelay(this.Uo,1e4,()=>(this.Jo()&&(this.state=3),Promise.resolve())),this.listener.Po()))}),this.stream.To(i=>{r(()=>this.__(i))}),this.stream.onMessage(i=>{r(()=>this.onMessage(i))})}Yo(){this.state=5,this.jo.qo(()=>p(this,null,function*(){this.state=0,this.start()}))}__(t){return y("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}s_(t){return e=>{this.oi.enqueueAndForget(()=>this.Wo===t?e():(y("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}},Uu=class extends Ks{constructor(t,e,r,i,s,o){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,r,i,o),this.serializer=s}a_(t,e){return this.connection.Fo("Listen",t,e)}onMessage(t){this.jo.reset();let e=V_(this.serializer,t),r=function(s){if(!("targetChange"in s))return P.min();let o=s.targetChange;return o.targetIds&&o.targetIds.length?P.min():o.readTime?nt(o.readTime):P.min()}(t);return this.listener.u_(e,r)}c_(t){let e={};e.database=ou(this.serializer),e.addTarget=function(s,o){let a,u=o.target;if(a=Es(u)?{documents:am(s,u)}:{query:um(s,u).ut},a.targetId=o.targetId,o.resumeToken.approximateByteSize()>0){a.resumeToken=em(s,o.resumeToken);let c=iu(s,o.expectedCount);c!==null&&(a.expectedCount=c)}else if(o.snapshotVersion.compareTo(P.min())>0){a.readTime=jn(s,o.snapshotVersion.toTimestamp());let c=iu(s,o.expectedCount);c!==null&&(a.expectedCount=c)}return a}(this.serializer,t);let r=N_(this.serializer,t);r&&(e.labels=r),this.t_(e)}l_(t){let e={};e.database=ou(this.serializer),e.removeTarget=t,this.t_(e)}},Gu=class extends Ks{constructor(t,e,r,i,s,o){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,r,i,o),this.serializer=s,this.h_=!1}get P_(){return this.h_}start(){this.h_=!1,this.lastStreamToken=void 0,super.start()}i_(){this.h_&&this.I_([])}a_(t,e){return this.connection.Fo("Write",t,e)}onMessage(t){if(R(!!t.streamToken),this.lastStreamToken=t.streamToken,this.h_){this.jo.reset();let e=D_(t.writeResults,t.commitTime),r=nt(t.commitTime);return this.listener.T_(r,e)}return R(!t.writeResults||t.writeResults.length===0),this.h_=!0,this.listener.E_()}d_(){let t={};t.database=ou(this.serializer),this.t_(t)}I_(t){let e={streamToken:this.lastStreamToken,writes:t.map(r=>si(this.serializer,r))};this.t_(e)}};var ju=class extends class{}{constructor(t,e,r,i){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=r,this.serializer=i,this.A_=!1}R_(){if(this.A_)throw new _(g.FAILED_PRECONDITION,"The client has already been terminated.")}So(t,e,r,i){return this.R_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,o])=>this.connection.So(t,su(e,r),i,s,o)).catch(s=>{throw s.name==="FirebaseError"?(s.code===g.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),s):new _(g.UNKNOWN,s.toString())})}vo(t,e,r,i,s){return this.R_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([o,a])=>this.connection.vo(t,su(e,r),i,o,a,s)).catch(o=>{throw o.name==="FirebaseError"?(o.code===g.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),o):new _(g.UNKNOWN,o.toString())})}terminate(){this.A_=!0,this.connection.terminate()}};var zu=class{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.m_=0,this.f_=null,this.g_=!0}p_(){this.m_===0&&(this.y_("Unknown"),this.f_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.f_=null,this.w_("Backend didn't respond within 10 seconds."),this.y_("Offline"),Promise.resolve())))}S_(t){this.state==="Online"?this.y_("Unknown"):(this.m_++,this.m_>=1&&(this.b_(),this.w_(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.y_("Offline")))}set(t){this.b_(),this.m_=0,t==="Online"&&(this.g_=!1),this.y_(t)}y_(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}w_(t){let e=`Could not reach Cloud Firestore backend. ${t}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.g_?(tt(e),this.g_=!1):y("OnlineStateTracker",e)}b_(){this.f_!==null&&(this.f_.cancel(),this.f_=null)}};var Ku=class{constructor(t,e,r,i,s){this.localStore=t,this.datastore=e,this.asyncQueue=r,this.remoteSyncer={},this.D_=[],this.C_=new Map,this.v_=new Set,this.F_=[],this.M_=s,this.M_.io(o=>{r.enqueueAndForget(()=>p(this,null,function*(){Me(this)&&(y("RemoteStore","Restarting streams for network reachability change."),yield function(u){return p(this,null,function*(){let c=E(u);c.v_.add(4),yield nr(c),c.x_.set("Unknown"),c.v_.delete(4),yield vi(c)})}(this))}))}),this.x_=new zu(r,i)}};function vi(n){return p(this,null,function*(){if(Me(n))for(let t of n.F_)yield t(!0)})}function nr(n){return p(this,null,function*(){for(let t of n.F_)yield t(!1)})}function lo(n,t){let e=E(n);e.C_.has(t.targetId)||(e.C_.set(t.targetId,t),Oc(e)?Mc(e):ir(e).Jo()&&Fc(e,t))}function Wn(n,t){let e=E(n),r=ir(e);e.C_.delete(t),r.Jo()&&Cm(e,t),e.C_.size===0&&(r.Jo()?r.Xo():Me(e)&&e.x_.set("Unknown"))}function Fc(n,t){if(n.O_.Oe(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(P.min())>0){let e=n.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(e)}ir(n).c_(t)}function Cm(n,t){n.O_.Oe(t),ir(n).l_(t)}function Mc(n){n.O_=new nu({getRemoteKeysForTarget:t=>n.remoteSyncer.getRemoteKeysForTarget(t),_t:t=>n.C_.get(t)||null,nt:()=>n.datastore.serializer.databaseId}),ir(n).start(),n.x_.p_()}function Oc(n){return Me(n)&&!ir(n).Ho()&&n.C_.size>0}function Me(n){return E(n).v_.size===0}function bm(n){n.O_=void 0}function W_(n){return p(this,null,function*(){n.C_.forEach((t,e)=>{Fc(n,t)})})}function H_(n,t){return p(this,null,function*(){bm(n),Oc(n)?(n.x_.S_(t),Mc(n)):n.x_.set("Unknown")})}function Y_(n,t,e){return p(this,null,function*(){if(n.x_.set("Online"),t instanceof Rs&&t.state===2&&t.cause)try{yield function(i,s){return p(this,null,function*(){let o=s.cause;for(let a of s.targetIds)i.C_.has(a)&&(yield i.remoteSyncer.rejectListen(a,o),i.C_.delete(a),i.O_.removeTarget(a))})}(n,t)}catch(r){y("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),r),yield $s(n,r)}else if(t instanceof Mn?n.O_.$e(t):t instanceof Ss?n.O_.Je(t):n.O_.Ge(t),!e.isEqual(P.min()))try{let r=yield Em(n.localStore);e.compareTo(r)>=0&&(yield function(s,o){let a=s.O_.it(o);return a.targetChanges.forEach((u,c)=>{if(u.resumeToken.approximateByteSize()>0){let l=s.C_.get(c);l&&s.C_.set(c,l.withResumeToken(u.resumeToken,o))}}),a.targetMismatches.forEach((u,c)=>{let l=s.C_.get(u);if(!l)return;s.C_.set(u,l.withResumeToken(dt.EMPTY_BYTE_STRING,l.snapshotVersion)),Cm(s,u);let h=new zn(l.target,u,c,l.sequenceNumber);Fc(s,h)}),s.remoteSyncer.applyRemoteEvent(a)}(n,e))}catch(r){y("RemoteStore","Failed to raise snapshot:",r),yield $s(n,r)}})}function $s(n,t,e){return p(this,null,function*(){if(!Fe(t))throw t;n.v_.add(1),yield nr(n),n.x_.set("Offline"),e||(e=()=>Em(n.localStore)),n.asyncQueue.enqueueRetryable(()=>p(this,null,function*(){y("RemoteStore","Retrying IndexedDB access"),yield e(),n.v_.delete(1),yield vi(n)}))})}function xm(n,t){return t().catch(e=>$s(n,e,t))}function rr(n){return p(this,null,function*(){let t=E(n),e=Ne(t),r=t.D_.length>0?t.D_[t.D_.length-1].batchId:-1;for(;J_(t);)try{let i=yield z_(t.localStore,r);if(i===null){t.D_.length===0&&e.Xo();break}r=i.batchId,X_(t,i)}catch(i){yield $s(t,i)}Vm(t)&&Dm(t)})}function J_(n){return Me(n)&&n.D_.length<10}function X_(n,t){n.D_.push(t);let e=Ne(n);e.Jo()&&e.P_&&e.I_(t.mutations)}function Vm(n){return Me(n)&&!Ne(n).Ho()&&n.D_.length>0}function Dm(n){Ne(n).start()}function Z_(n){return p(this,null,function*(){Ne(n).d_()})}function ty(n){return p(this,null,function*(){let t=Ne(n);for(let e of n.D_)t.I_(e.mutations)})}function ey(n,t,e){return p(this,null,function*(){let r=n.D_.shift(),i=Za.from(r,t,e);yield xm(n,()=>n.remoteSyncer.applySuccessfulWrite(i)),yield rr(n)})}function ny(n,t){return p(this,null,function*(){t&&Ne(n).P_&&(yield function(r,i){return p(this,null,function*(){if(function(o){return Xf(o)&&o!==g.ABORTED}(i.code)){let s=r.D_.shift();Ne(r).Zo(),yield xm(r,()=>r.remoteSyncer.rejectFailedWrite(s.batchId,i)),yield rr(r)}})}(n,t)),Vm(n)&&Dm(n)})}function sf(n,t){return p(this,null,function*(){let e=E(n);e.asyncQueue.verifyOperationInProgress(),y("RemoteStore","RemoteStore received new credentials");let r=Me(e);e.v_.add(3),yield nr(e),r&&e.x_.set("Unknown"),yield e.remoteSyncer.handleCredentialChange(t),e.v_.delete(3),yield vi(e)})}function $u(n,t){return p(this,null,function*(){let e=E(n);t?(e.v_.delete(2),yield vi(e)):t||(e.v_.add(2),yield nr(e),e.x_.set("Unknown"))})}function ir(n){return n.N_||(n.N_=function(e,r,i){let s=E(e);return s.R_(),new Uu(r,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(n.datastore,n.asyncQueue,{Po:W_.bind(null,n),To:H_.bind(null,n),u_:Y_.bind(null,n)}),n.F_.push(t=>p(this,null,function*(){t?(n.N_.Zo(),Oc(n)?Mc(n):n.x_.set("Unknown")):(yield n.N_.stop(),bm(n))}))),n.N_}function Ne(n){return n.L_||(n.L_=function(e,r,i){let s=E(e);return s.R_(),new Gu(r,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(n.datastore,n.asyncQueue,{Po:Z_.bind(null,n),To:ny.bind(null,n),E_:ty.bind(null,n),T_:ey.bind(null,n)}),n.F_.push(t=>p(this,null,function*(){t?(n.L_.Zo(),yield rr(n)):(yield n.L_.stop(),n.D_.length>0&&(y("RemoteStore",`Stopping write stream with ${n.D_.length} pending writes`),n.D_=[]))}))),n.L_}var Qu=class n{constructor(t,e,r,i,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=r,this.op=i,this.removalCallback=s,this.deferred=new at,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(o=>{})}get promise(){return this.deferred.promise}static createAndSchedule(t,e,r,i,s){let o=Date.now()+r,a=new n(t,e,o,i,s);return a.start(r),a}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new _(g.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}};function sr(n,t){if(tt("AsyncQueue",`${t}: ${n}`),Fe(n))return new _(g.UNAVAILABLE,`${t}: ${n}`);throw n}var Qs=class n{constructor(t){this.comparator=t?(e,r)=>t(e,r)||I.comparator(e.key,r.key):(e,r)=>I.comparator(e.key,r.key),this.keyedMap=Br(),this.sortedSet=new $(this.comparator)}static emptySet(t){return new n(t.comparator)}has(t){return this.keyedMap.get(t)!=null}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){let e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal((e,r)=>(t(e),!1))}add(t){let e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){let e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof n)||this.size!==t.size)return!1;let e=this.sortedSet.getIterator(),r=t.sortedSet.getIterator();for(;e.hasNext();){let i=e.getNext().key,s=r.getNext().key;if(!i.isEqual(s))return!1}return!0}toString(){let t=[];return this.forEach(e=>{t.push(e.toString())}),t.length===0?"DocumentSet ()":`DocumentSet (
  `+t.join(`  
`)+`
)`}copy(t,e){let r=new n;return r.comparator=this.comparator,r.keyedMap=t,r.sortedSet=e,r}};var Ws=class{constructor(){this.B_=new $(I.comparator)}track(t){let e=t.doc.key,r=this.B_.get(e);r?t.type!==0&&r.type===3?this.B_=this.B_.insert(e,t):t.type===3&&r.type!==1?this.B_=this.B_.insert(e,{type:r.type,doc:t.doc}):t.type===2&&r.type===2?this.B_=this.B_.insert(e,{type:2,doc:t.doc}):t.type===2&&r.type===0?this.B_=this.B_.insert(e,{type:0,doc:t.doc}):t.type===1&&r.type===0?this.B_=this.B_.remove(e):t.type===1&&r.type===2?this.B_=this.B_.insert(e,{type:1,doc:r.doc}):t.type===0&&r.type===1?this.B_=this.B_.insert(e,{type:2,doc:t.doc}):S():this.B_=this.B_.insert(e,t)}k_(){let t=[];return this.B_.inorderTraversal((e,r)=>{t.push(r)}),t}},Hn=class n{constructor(t,e,r,i,s,o,a,u,c){this.query=t,this.docs=e,this.oldDocs=r,this.docChanges=i,this.mutatedKeys=s,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=u,this.hasCachedResults=c}static fromInitialDocuments(t,e,r,i,s){let o=[];return e.forEach(a=>{o.push({type:0,doc:a})}),new n(t,e,Qs.emptySet(e),o,r,i,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&_i(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;let e=this.docChanges,r=t.docChanges;if(e.length!==r.length)return!1;for(let i=0;i<e.length;i++)if(e[i].type!==r[i].type||!e[i].doc.isEqual(r[i].doc))return!1;return!0}};var Wu=class{constructor(){this.q_=void 0,this.Q_=[]}K_(){return this.Q_.some(t=>t.U_())}},Hu=class{constructor(){this.queries=new ee(t=>Of(t),_i),this.onlineState="Unknown",this.W_=new Set}};function Lc(n,t){return p(this,null,function*(){let e=E(n),r=3,i=t.query,s=e.queries.get(i);s?!s.K_()&&t.U_()&&(r=2):(s=new Wu,r=t.U_()?0:1);try{switch(r){case 0:s.q_=yield e.onListen(i,!0);break;case 1:s.q_=yield e.onListen(i,!1);break;case 2:yield e.onFirstRemoteStoreListen(i)}}catch(o){let a=sr(o,`Initialization of query '${bn(t.query)}' failed`);return void t.onError(a)}e.queries.set(i,s),s.Q_.push(t),t.G_(e.onlineState),s.q_&&t.z_(s.q_)&&Bc(e)})}function qc(n,t){return p(this,null,function*(){let e=E(n),r=t.query,i=3,s=e.queries.get(r);if(s){let o=s.Q_.indexOf(t);o>=0&&(s.Q_.splice(o,1),s.Q_.length===0?i=t.U_()?0:1:!s.K_()&&t.U_()&&(i=2))}switch(i){case 0:return e.queries.delete(r),e.onUnlisten(r,!0);case 1:return e.queries.delete(r),e.onUnlisten(r,!1);case 2:return e.onLastRemoteStoreUnlisten(r);default:return}})}function ry(n,t){let e=E(n),r=!1;for(let i of t){let s=i.query,o=e.queries.get(s);if(o){for(let a of o.Q_)a.z_(i)&&(r=!0);o.q_=i}}r&&Bc(e)}function iy(n,t,e){let r=E(n),i=r.queries.get(t);if(i)for(let s of i.Q_)s.onError(e);r.queries.delete(t)}function Bc(n){n.W_.forEach(t=>{t.next()})}var Yu,of;(of=Yu||(Yu={})).j_="default",of.Cache="cache";var li=class{constructor(t,e,r){this.query=t,this.H_=e,this.J_=!1,this.Y_=null,this.onlineState="Unknown",this.options=r||{}}z_(t){if(!this.options.includeMetadataChanges){let r=[];for(let i of t.docChanges)i.type!==3&&r.push(i);t=new Hn(t.query,t.docs,t.oldDocs,r,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.J_?this.Z_(t)&&(this.H_.next(t),e=!0):this.X_(t,this.onlineState)&&(this.ea(t),e=!0),this.Y_=t,e}onError(t){this.H_.error(t)}G_(t){this.onlineState=t;let e=!1;return this.Y_&&!this.J_&&this.X_(this.Y_,t)&&(this.ea(this.Y_),e=!0),e}X_(t,e){if(!t.fromCache||!this.U_())return!0;let r=e!=="Offline";return(!this.options.ta||!r)&&(!t.docs.isEmpty()||t.hasCachedResults||e==="Offline")}Z_(t){if(t.docChanges.length>0)return!0;let e=this.Y_&&this.Y_.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&this.options.includeMetadataChanges===!0}ea(t){t=Hn.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.J_=!0,this.H_.next(t)}U_(){return this.options.source!==Yu.Cache}};var Ju=class{constructor(t,e){this.na=t,this.byteLength=e}ra(){return"metadata"in this.na}};var Hs=class{constructor(t){this.serializer=t}Ps(t){return Jt(this.serializer,t)}Is(t){return t.metadata.exists?om(this.serializer,t.document,!1):ut.newNoDocument(this.Ps(t.metadata.name),this.Ts(t.metadata.readTime))}Ts(t){return nt(t)}},Xu=class{constructor(t,e,r){this.ia=t,this.localStore=e,this.serializer=r,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Nm(t)}sa(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;if(t.na.namedQuery)this.queries.push(t.na.namedQuery);else if(t.na.documentMetadata){this.documents.push({metadata:t.na.documentMetadata}),t.na.documentMetadata.exists||++e;let r=M.fromString(t.na.documentMetadata.name);this.collectionGroups.add(r.get(r.length-2))}else t.na.document&&(this.documents[this.documents.length-1].document=t.na.document,++e);return e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}oa(t){let e=new Map,r=new Hs(this.serializer);for(let i of t)if(i.metadata.queries){let s=r.Ps(i.metadata.name);for(let o of i.metadata.queries){let a=(e.get(o)||D()).add(s);e.set(o,a)}}return e}complete(){return p(this,null,function*(){let t=yield K_(this.localStore,new Hs(this.serializer),this.documents,this.ia.id),e=this.oa(this.documents);for(let r of this.queries)yield $_(this.localStore,r,e.get(r.name));return this.progress.taskState="Success",{progress:this.progress,_a:this.collectionGroups,aa:t}})}};function Nm(n){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:n.totalDocuments,totalBytes:n.totalBytes}}var Ys=class{constructor(t){this.key=t}},Js=class{constructor(t){this.key=t}},Xs=class{constructor(t,e){this.query=t,this.ua=e,this.ca=null,this.hasCachedResults=!1,this.current=!1,this.la=D(),this.mutatedKeys=D(),this.ha=qf(t),this.Pa=new Qs(this.ha)}get Ia(){return this.ua}Ta(t,e){let r=e?e.Ea:new Ws,i=e?e.Pa:this.Pa,s=e?e.mutatedKeys:this.mutatedKeys,o=i,a=!1,u=this.query.limitType==="F"&&i.size===this.query.limit?i.last():null,c=this.query.limitType==="L"&&i.size===this.query.limit?i.first():null;if(t.inorderTraversal((l,h)=>{let d=i.get(l),m=yi(this.query,h)?h:null,A=!!d&&this.mutatedKeys.has(d.key),w=!!m&&(m.hasLocalMutations||this.mutatedKeys.has(m.key)&&m.hasCommittedMutations),v=!1;d&&m?d.data.isEqual(m.data)?A!==w&&(r.track({type:3,doc:m}),v=!0):this.da(d,m)||(r.track({type:2,doc:m}),v=!0,(u&&this.ha(m,u)>0||c&&this.ha(m,c)<0)&&(a=!0)):!d&&m?(r.track({type:0,doc:m}),v=!0):d&&!m&&(r.track({type:1,doc:d}),v=!0,(u||c)&&(a=!0)),v&&(m?(o=o.add(m),s=w?s.add(l):s.delete(l)):(o=o.delete(l),s=s.delete(l)))}),this.query.limit!==null)for(;o.size>this.query.limit;){let l=this.query.limitType==="F"?o.last():o.first();o=o.delete(l.key),s=s.delete(l.key),r.track({type:1,doc:l})}return{Pa:o,Ea:r,Xi:a,mutatedKeys:s}}da(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,r,i){let s=this.Pa;this.Pa=t.Pa,this.mutatedKeys=t.mutatedKeys;let o=t.Ea.k_();o.sort((l,h)=>function(m,A){let w=v=>{switch(v){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return S()}};return w(m)-w(A)}(l.type,h.type)||this.ha(l.doc,h.doc)),this.Aa(r),i=i!=null&&i;let a=e&&!i?this.Ra():[],u=this.la.size===0&&this.current&&!i?1:0,c=u!==this.ca;return this.ca=u,o.length!==0||c?{snapshot:new Hn(this.query,t.Pa,s,o,t.mutatedKeys,u===0,c,!1,!!r&&r.resumeToken.approximateByteSize()>0),Va:a}:{Va:a}}G_(t){return this.current&&t==="Offline"?(this.current=!1,this.applyChanges({Pa:this.Pa,Ea:new Ws,mutatedKeys:this.mutatedKeys,Xi:!1},!1)):{Va:[]}}ma(t){return!this.ua.has(t)&&!!this.Pa.has(t)&&!this.Pa.get(t).hasLocalMutations}Aa(t){t&&(t.addedDocuments.forEach(e=>this.ua=this.ua.add(e)),t.modifiedDocuments.forEach(e=>{}),t.removedDocuments.forEach(e=>this.ua=this.ua.delete(e)),this.current=t.current)}Ra(){if(!this.current)return[];let t=this.la;this.la=D(),this.Pa.forEach(r=>{this.ma(r.key)&&(this.la=this.la.add(r.key))});let e=[];return t.forEach(r=>{this.la.has(r)||e.push(new Js(r))}),this.la.forEach(r=>{t.has(r)||e.push(new Ys(r))}),e}fa(t){this.ua=t.hs,this.la=D();let e=this.Ta(t.documents);return this.applyChanges(e,!0)}ga(){return Hn.fromInitialDocuments(this.query,this.Pa,this.mutatedKeys,this.ca===0,this.hasCachedResults)}},Zu=class{constructor(t,e,r){this.query=t,this.targetId=e,this.view=r}},tc=class{constructor(t){this.key=t,this.pa=!1}},ec=class{constructor(t,e,r,i,s,o){this.localStore=t,this.remoteStore=e,this.eventManager=r,this.sharedClientState=i,this.currentUser=s,this.maxConcurrentLimboResolutions=o,this.ya={},this.wa=new ee(a=>Of(a),_i),this.Sa=new Map,this.ba=new Set,this.Da=new $(I.comparator),this.Ca=new Map,this.va=new ai,this.Fa={},this.Ma=new Map,this.xa=Kn.Ln(),this.onlineState="Unknown",this.Oa=void 0}get isPrimaryClient(){return this.Oa===!0}};function sy(n,t,e=!0){return p(this,null,function*(){let r=ho(n),i,s=r.wa.get(t);return s?(r.sharedClientState.addLocalQueryTarget(s.targetId),i=s.view.ga()):i=yield km(r,t,e,!0),i})}function oy(n,t){return p(this,null,function*(){let e=ho(n);yield km(e,t,!0,!1)})}function km(n,t,e,r){return p(this,null,function*(){let i=yield $n(n.localStore,At(t)),s=i.targetId,o=e?n.sharedClientState.addLocalQueryTarget(s):"not-current",a;return r&&(a=yield Uc(n,t,s,o==="current",i.resumeToken)),n.isPrimaryClient&&e&&lo(n.remoteStore,i),a})}function Uc(n,t,e,r,i){return p(this,null,function*(){n.Na=(h,d,m)=>function(w,v,C,N){return p(this,null,function*(){let b=v.view.Ta(C);b.Xi&&(b=yield Bs(w.localStore,v.query,!1).then(({documents:rt})=>v.view.Ta(rt,b)));let q=N&&N.targetChanges.get(v.targetId),B=N&&N.targetMismatches.get(v.targetId)!=null,L=v.view.applyChanges(b,w.isPrimaryClient,q,B);return nc(w,v.targetId,L.Va),L.snapshot})}(n,h,d,m);let s=yield Bs(n.localStore,t,!0),o=new Xs(t,s.hs),a=o.Ta(s.documents),u=ri.createSynthesizedTargetChangeForCurrentChange(e,r&&n.onlineState!=="Offline",i),c=o.applyChanges(a,n.isPrimaryClient,u);nc(n,e,c.Va);let l=new Zu(t,e,o);return n.wa.set(t,l),n.Sa.has(e)?n.Sa.get(e).push(t):n.Sa.set(e,[t]),c.snapshot})}function ay(n,t,e){return p(this,null,function*(){let r=E(n),i=r.wa.get(t),s=r.Sa.get(i.targetId);if(s.length>1)return r.Sa.set(i.targetId,s.filter(o=>!_i(o,t))),void r.wa.delete(t);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(i.targetId),r.sharedClientState.isActiveQueryTarget(i.targetId)||(yield Qn(r.localStore,i.targetId,!1).then(()=>{r.sharedClientState.clearQueryState(i.targetId),e&&Wn(r.remoteStore,i.targetId),Yn(r,i.targetId)}).catch(ke))):(Yn(r,i.targetId),yield Qn(r.localStore,i.targetId,!0))})}function uy(n,t){return p(this,null,function*(){let e=E(n),r=e.wa.get(t),i=e.Sa.get(r.targetId);e.isPrimaryClient&&i.length===1&&(e.sharedClientState.removeLocalQueryTarget(r.targetId),Wn(e.remoteStore,r.targetId))})}function cy(n,t,e){return p(this,null,function*(){let r=Kc(n);try{let i=yield function(o,a){let u=E(o),c=W.now(),l=a.reduce((m,A)=>m.add(A.key),D()),h,d;return u.persistence.runTransaction("Locally write mutations","readwrite",m=>{let A=Rt(),w=D();return u.os.getEntries(m,l).next(v=>{A=v,A.forEach((C,N)=>{N.isValidDocument()||(w=w.add(C))})}).next(()=>u.localDocuments.getOverlayedDocuments(m,A)).next(v=>{h=v;let C=[];for(let N of a){let b=A_(N,h.get(N.key).overlayedDocument);b!=null&&C.push(new Bt(N.key,b,xf(b.value.mapValue),Z.exists(!0)))}return u.mutationQueue.addMutationBatch(m,c,C,a)}).next(v=>{d=v;let C=v.applyToLocalDocumentSet(h,w);return u.documentOverlayCache.saveOverlays(m,v.batchId,C)})}).then(()=>({batchId:d.batchId,changes:Uf(h)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(i.batchId),function(o,a,u){let c=o.Fa[o.currentUser.toKey()];c||(c=new $(V)),c=c.insert(a,u),o.Fa[o.currentUser.toKey()]=c}(r,i.batchId,e),yield me(r,i.changes),yield rr(r.remoteStore)}catch(i){let s=sr(i,"Failed to persist write");e.reject(s)}})}function Fm(n,t){return p(this,null,function*(){let e=E(n);try{let r=yield j_(e.localStore,t);t.targetChanges.forEach((i,s)=>{let o=e.Ca.get(s);o&&(R(i.addedDocuments.size+i.modifiedDocuments.size+i.removedDocuments.size<=1),i.addedDocuments.size>0?o.pa=!0:i.modifiedDocuments.size>0?R(o.pa):i.removedDocuments.size>0&&(R(o.pa),o.pa=!1))}),yield me(e,r,t)}catch(r){yield ke(r)}})}function af(n,t,e){let r=E(n);if(r.isPrimaryClient&&e===0||!r.isPrimaryClient&&e===1){let i=[];r.wa.forEach((s,o)=>{let a=o.view.G_(t);a.snapshot&&i.push(a.snapshot)}),function(o,a){let u=E(o);u.onlineState=a;let c=!1;u.queries.forEach((l,h)=>{for(let d of h.Q_)d.G_(a)&&(c=!0)}),c&&Bc(u)}(r.eventManager,t),i.length&&r.ya.u_(i),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}function ly(n,t,e){return p(this,null,function*(){let r=E(n);r.sharedClientState.updateQueryState(t,"rejected",e);let i=r.Ca.get(t),s=i&&i.key;if(s){let o=new $(I.comparator);o=o.insert(s,ut.newNoDocument(s,P.min()));let a=D().add(s),u=new ni(P.min(),new Map,new $(V),o,a);yield Fm(r,u),r.Da=r.Da.remove(s),r.Ca.delete(t),zc(r)}else yield Qn(r.localStore,t,!1).then(()=>Yn(r,t,e)).catch(ke)})}function hy(n,t){return p(this,null,function*(){let e=E(n),r=t.batch.batchId;try{let i=yield G_(e.localStore,t);jc(e,r,null),Gc(e,r),e.sharedClientState.updateMutationState(r,"acknowledged"),yield me(e,i)}catch(i){yield ke(i)}})}function dy(n,t,e){return p(this,null,function*(){let r=E(n);try{let i=yield function(o,a){let u=E(o);return u.persistence.runTransaction("Reject batch","readwrite-primary",c=>{let l;return u.mutationQueue.lookupMutationBatch(c,a).next(h=>(R(h!==null),l=h.keys(),u.mutationQueue.removeMutationBatch(c,h))).next(()=>u.mutationQueue.performConsistencyCheck(c)).next(()=>u.documentOverlayCache.removeOverlaysForBatchId(c,l,a)).next(()=>u.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(c,l)).next(()=>u.localDocuments.getDocuments(c,l))})}(r.localStore,t);jc(r,t,e),Gc(r,t),r.sharedClientState.updateMutationState(t,"rejected",e),yield me(r,i)}catch(i){yield ke(i)}})}function fy(n,t){return p(this,null,function*(){let e=E(n);Me(e.remoteStore)||y("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{let r=yield function(o){let a=E(o);return a.persistence.runTransaction("Get highest unacknowledged batch id","readonly",u=>a.mutationQueue.getHighestUnacknowledgedBatchId(u))}(e.localStore);if(r===-1)return void t.resolve();let i=e.Ma.get(r)||[];i.push(t),e.Ma.set(r,i)}catch(r){let i=sr(r,"Initialization of waitForPendingWrites() operation failed");t.reject(i)}})}function Gc(n,t){(n.Ma.get(t)||[]).forEach(e=>{e.resolve()}),n.Ma.delete(t)}function jc(n,t,e){let r=E(n),i=r.Fa[r.currentUser.toKey()];if(i){let s=i.get(t);s&&(e?s.reject(e):s.resolve(),i=i.remove(t)),r.Fa[r.currentUser.toKey()]=i}}function Yn(n,t,e=null){n.sharedClientState.removeLocalQueryTarget(t);for(let r of n.Sa.get(t))n.wa.delete(r),e&&n.ya.La(r,e);n.Sa.delete(t),n.isPrimaryClient&&n.va.Vr(t).forEach(r=>{n.va.containsKey(r)||Mm(n,r)})}function Mm(n,t){n.ba.delete(t.path.canonicalString());let e=n.Da.get(t);e!==null&&(Wn(n.remoteStore,e),n.Da=n.Da.remove(t),n.Ca.delete(e),zc(n))}function nc(n,t,e){for(let r of e)r instanceof Ys?(n.va.addReference(r.key,t),my(n,r)):r instanceof Js?(y("SyncEngine","Document no longer in limbo: "+r.key),n.va.removeReference(r.key,t),n.va.containsKey(r.key)||Mm(n,r.key)):S()}function my(n,t){let e=t.key,r=e.path.canonicalString();n.Da.get(e)||n.ba.has(r)||(y("SyncEngine","New document in limbo: "+e),n.ba.add(r),zc(n))}function zc(n){for(;n.ba.size>0&&n.Da.size<n.maxConcurrentLimboResolutions;){let t=n.ba.values().next().value;n.ba.delete(t);let e=new I(M.fromString(t)),r=n.xa.next();n.Ca.set(r,new tc(e)),n.Da=n.Da.insert(e,r),lo(n.remoteStore,new zn(At(er(e.path)),r,"TargetPurposeLimboResolution",Ct._e))}}function me(n,t,e){return p(this,null,function*(){let r=E(n),i=[],s=[],o=[];r.wa.isEmpty()||(r.wa.forEach((a,u)=>{o.push(r.Na(u,t,e).then(c=>{if((c||e)&&r.isPrimaryClient&&r.sharedClientState.updateQueryState(u.targetId,c?.fromCache?"not-current":"current"),c){i.push(c);let l=ku.Ki(u.targetId,c);s.push(l)}}))}),yield Promise.all(o),r.ya.u_(i),yield function(u,c){return p(this,null,function*(){let l=E(u);try{yield l.persistence.runTransaction("notifyLocalViewChanges","readwrite",h=>f.forEach(c,d=>f.forEach(d.qi,m=>l.persistence.referenceDelegate.addReference(h,d.targetId,m)).next(()=>f.forEach(d.Qi,m=>l.persistence.referenceDelegate.removeReference(h,d.targetId,m)))))}catch(h){if(!Fe(h))throw h;y("LocalStore","Failed to update sequence numbers: "+h)}for(let h of c){let d=h.targetId;if(!h.fromCache){let m=l.ns.get(d),A=m.snapshotVersion,w=m.withLastLimboFreeSnapshotVersion(A);l.ns=l.ns.insert(d,w)}}})}(r.localStore,s))})}function gy(n,t){return p(this,null,function*(){let e=E(n);if(!e.currentUser.isEqual(t)){y("SyncEngine","User change. New user:",t.toKey());let r=yield Im(e.localStore,t);e.currentUser=t,function(s,o){s.Ma.forEach(a=>{a.forEach(u=>{u.reject(new _(g.CANCELLED,o))})}),s.Ma.clear()}(e,"'waitForPendingWrites' promise is rejected due to a user change."),e.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),yield me(e,r.us)}})}function py(n,t){let e=E(n),r=e.Ca.get(t);if(r&&r.pa)return D().add(r.key);{let i=D(),s=e.Sa.get(t);if(!s)return i;for(let o of s){let a=e.wa.get(o);i=i.unionWith(a.view.Ia)}return i}}function _y(n,t){return p(this,null,function*(){let e=E(n),r=yield Bs(e.localStore,t.query,!0),i=t.view.fa(r);return e.isPrimaryClient&&nc(e,t.targetId,i.Va),i})}function yy(n,t){return p(this,null,function*(){let e=E(n);return Sm(e.localStore,t).then(r=>me(e,r))})}function wy(n,t,e,r){return p(this,null,function*(){let i=E(n),s=yield function(a,u){let c=E(a),l=E(c.mutationQueue);return c.persistence.runTransaction("Lookup mutation documents","readonly",h=>l.vn(h,u).next(d=>d?c.localDocuments.getDocuments(h,d):f.resolve(null)))}(i.localStore,t);s!==null?(e==="pending"?yield rr(i.remoteStore):e==="acknowledged"||e==="rejected"?(jc(i,t,r||null),Gc(i,t),function(a,u){E(E(a).mutationQueue).Mn(u)}(i.localStore,t)):S(),yield me(i,s)):y("SyncEngine","Cannot apply mutation batch with id: "+t)})}function vy(n,t){return p(this,null,function*(){let e=E(n);if(ho(e),Kc(e),t===!0&&e.Oa!==!0){let r=e.sharedClientState.getAllActiveQueryTargets(),i=yield uf(e,r.toArray());e.Oa=!0,yield $u(e.remoteStore,!0);for(let s of i)lo(e.remoteStore,s)}else if(t===!1&&e.Oa!==!1){let r=[],i=Promise.resolve();e.Sa.forEach((s,o)=>{e.sharedClientState.isLocalQueryTarget(o)?r.push(o):i=i.then(()=>(Yn(e,o),Qn(e.localStore,o,!0))),Wn(e.remoteStore,o)}),yield i,yield uf(e,r),function(o){let a=E(o);a.Ca.forEach((u,c)=>{Wn(a.remoteStore,c)}),a.va.mr(),a.Ca=new Map,a.Da=new $(I.comparator)}(e),e.Oa=!1,yield $u(e.remoteStore,!1)}})}function uf(n,t,e){return p(this,null,function*(){let r=E(n),i=[],s=[];for(let o of t){let a,u=r.Sa.get(o);if(u&&u.length!==0){a=yield $n(r.localStore,At(u[0]));for(let c of u){let l=r.wa.get(c),h=yield _y(r,l);h.snapshot&&s.push(h.snapshot)}}else{let c=yield Am(r.localStore,o);a=yield $n(r.localStore,c),yield Uc(r,Om(c),o,!1,a.resumeToken)}i.push(a)}return r.ya.u_(s),i})}function Om(n){return Mf(n.path,n.collectionGroup,n.orderBy,n.filters,n.limit,"F",n.startAt,n.endAt)}function Iy(n){return function(e){return E(E(e).persistence).Bi()}(E(n).localStore)}function Ey(n,t,e,r){return p(this,null,function*(){let i=E(n);if(i.Oa)return void y("SyncEngine","Ignoring unexpected query state notification.");let s=i.Sa.get(t);if(s&&s.length>0)switch(e){case"current":case"not-current":{let o=yield Sm(i.localStore,Lf(s[0])),a=ni.createSynthesizedRemoteEventForCurrentChange(t,e==="current",dt.EMPTY_BYTE_STRING);yield me(i,o,a);break}case"rejected":yield Qn(i.localStore,t,!0),Yn(i,t,r);break;default:S()}})}function Ty(n,t,e){return p(this,null,function*(){let r=ho(n);if(r.Oa){for(let i of t){if(r.Sa.has(i)&&r.sharedClientState.isActiveQueryTarget(i)){y("SyncEngine","Adding an already active target "+i);continue}let s=yield Am(r.localStore,i),o=yield $n(r.localStore,s);yield Uc(r,Om(s),o.targetId,!1,o.resumeToken),lo(r.remoteStore,o)}for(let i of e)r.Sa.has(i)&&(yield Qn(r.localStore,i,!1).then(()=>{Wn(r.remoteStore,i),Yn(r,i)}).catch(ke))}})}function ho(n){let t=E(n);return t.remoteStore.remoteSyncer.applyRemoteEvent=Fm.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=py.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=ly.bind(null,t),t.ya.u_=ry.bind(null,t.eventManager),t.ya.La=iy.bind(null,t.eventManager),t}function Kc(n){let t=E(n);return t.remoteStore.remoteSyncer.applySuccessfulWrite=hy.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=dy.bind(null,t),t}function Ay(n,t,e){let r=E(n);(function(s,o,a){return p(this,null,function*(){try{let u=yield o.getMetadata();if(yield function(m,A){let w=E(m),v=nt(A.createTime);return w.persistence.runTransaction("hasNewerBundle","readonly",C=>w.$r.getBundleMetadata(C,A.id)).then(C=>!!C&&C.createTime.compareTo(v)>=0)}(s.localStore,u))return yield o.close(),a._completeWith(function(m){return{taskState:"Success",documentsLoaded:m.totalDocuments,bytesLoaded:m.totalBytes,totalDocuments:m.totalDocuments,totalBytes:m.totalBytes}}(u)),Promise.resolve(new Set);a._updateProgress(Nm(u));let c=new Xu(u,s.localStore,o.serializer),l=yield o.Ba();for(;l;){let d=yield c.sa(l);d&&a._updateProgress(d),l=yield o.Ba()}let h=yield c.complete();return yield me(s,h.aa,void 0),yield function(m,A){let w=E(m);return w.persistence.runTransaction("Save bundle","readwrite",v=>w.$r.saveBundleMetadata(v,A))}(s.localStore,u),a._completeWith(h.progress),Promise.resolve(h._a)}catch(u){return kt("SyncEngine",`Loading bundle failed with ${u}`),a._failWith(u),Promise.resolve(new Set)}})})(r,t,e).then(i=>{r.sharedClientState.notifyBundleLoaded(i)})}var hi=class{constructor(){this.synchronizeTabs=!1}initialize(t){return p(this,null,function*(){this.serializer=wi(t.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(t),this.persistence=this.createPersistence(t),yield this.persistence.start(),this.localStore=this.createLocalStore(t),this.gcScheduler=this.createGarbageCollectionScheduler(t,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(t,this.localStore)})}createGarbageCollectionScheduler(t,e){return null}createIndexBackfillerScheduler(t,e){return null}createLocalStore(t){return vm(this.persistence,new qs,t.initialUser,this.serializer)}createPersistence(t){return new Os(Ls.Hr,this.serializer)}createSharedClientState(t){return new js}terminate(){return p(this,null,function*(){var t,e;(t=this.gcScheduler)===null||t===void 0||t.stop(),(e=this.indexBackfillerScheduler)===null||e===void 0||e.stop(),this.sharedClientState.shutdown(),yield this.persistence.shutdown()})}};var Zs=class n extends hi{constructor(t,e,r){super(),this.ka=t,this.cacheSizeBytes=e,this.forceOwnership=r,this.synchronizeTabs=!1}initialize(t){return p(this,null,function*(){yield So(n.prototype,this,"initialize").call(this,t),yield this.ka.initialize(this,t),yield Kc(this.ka.syncEngine),yield rr(this.ka.remoteStore),yield this.persistence.fi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))})}createLocalStore(t){return vm(this.persistence,new qs,t.initialUser,this.serializer)}createGarbageCollectionScheduler(t,e){let r=this.persistence.referenceDelegate.garbageCollector;return new wu(r,t.asyncQueue,e)}createIndexBackfillerScheduler(t,e){let r=new Oa(e,this.persistence);return new Ma(t.asyncQueue,r)}createPersistence(t){let e=kc(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),r=this.cacheSizeBytes!==void 0?Nt.withCacheSize(this.cacheSizeBytes):Nt.DEFAULT;return new Nu(this.synchronizeTabs,e,t.clientId,r,t.asyncQueue,Pm(),hs(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(t){return new js}},rc=class n extends Zs{constructor(t,e){super(t,e,!1),this.ka=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}initialize(t){return p(this,null,function*(){yield So(n.prototype,this,"initialize").call(this,t);let e=this.ka.syncEngine;this.sharedClientState instanceof $r&&(this.sharedClientState.syncEngine={Zs:wy.bind(null,e),Xs:Ey.bind(null,e),eo:Ty.bind(null,e),Bi:Iy.bind(null,e),Ys:yy.bind(null,e)},yield this.sharedClientState.start()),yield this.persistence.fi(r=>p(this,null,function*(){yield vy(this.ka.syncEngine,r),this.gcScheduler&&(r&&!this.gcScheduler.started?this.gcScheduler.start():r||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(r&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():r||this.indexBackfillerScheduler.stop())}))})}createSharedClientState(t){let e=Pm();if(!$r.D(e))throw new _(g.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let r=kc(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new $r(e,t.asyncQueue,r,t.clientId,t.initialUser)}},di=class{initialize(t,e){return p(this,null,function*(){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=r=>af(this.syncEngine,r,1),this.remoteStore.remoteSyncer.handleCredentialChange=gy.bind(null,this.syncEngine),yield $u(this.remoteStore,this.syncEngine.isPrimaryClient))})}createEventManager(t){return function(){return new Hu}()}createDatastore(t){let e=wi(t.databaseInfo.databaseId),r=function(s){return new Bu(s)}(t.databaseInfo);return function(s,o,a,u){return new ju(s,o,a,u)}(t.authCredentials,t.appCheckCredentials,r,e)}createRemoteStore(t){return function(r,i,s,o,a){return new Ku(r,i,s,o,a)}(this.localStore,this.datastore,t.asyncQueue,e=>af(this.syncEngine,e,0),function(){return zs.D()?new zs:new Lu}())}createSyncEngine(t,e){return function(i,s,o,a,u,c,l){let h=new ec(i,s,o,a,u,c);return l&&(h.Oa=!0),h}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return p(this,null,function*(){var t;yield function(r){return p(this,null,function*(){let i=E(r);y("RemoteStore","RemoteStore shutting down."),i.v_.add(5),yield nr(i),i.M_.shutdown(),i.x_.set("Unknown")})}(this.remoteStore),(t=this.datastore)===null||t===void 0||t.terminate()})}};function cf(n,t=10240){let e=0;return{read(){return p(this,null,function*(){if(e<n.byteLength){let i={value:n.slice(e,e+t),done:!1};return e+=t,i}return{done:!0}})},cancel(){return p(this,null,function*(){})},releaseLock(){},closed:Promise.resolve()}}var Jn=class{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.qa(this.observer.next,t)}error(t){this.observer.error?this.qa(this.observer.error,t):tt("Uncaught Error in snapshot listener:",t.toString())}Qa(){this.muted=!0}qa(t,e){this.muted||setTimeout(()=>{this.muted||t(e)},0)}};var ic=class{constructor(t,e){this.Ka=t,this.serializer=e,this.metadata=new at,this.buffer=new Uint8Array,this.$a=function(){return new TextDecoder("utf-8")}(),this.Ua().then(r=>{r&&r.ra()?this.metadata.resolve(r.na.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(r?.na)}`))},r=>this.metadata.reject(r))}close(){return this.Ka.cancel()}getMetadata(){return p(this,null,function*(){return this.metadata.promise})}Ba(){return p(this,null,function*(){return yield this.getMetadata(),this.Ua()})}Ua(){return p(this,null,function*(){let t=yield this.Wa();if(t===null)return null;let e=this.$a.decode(t),r=Number(e);isNaN(r)&&this.Ga(`length string (${e}) is not valid number`);let i=yield this.za(r);return new Ju(JSON.parse(i),t.length+r)})}ja(){return this.buffer.findIndex(t=>t===123)}Wa(){return p(this,null,function*(){for(;this.ja()<0&&!(yield this.Ha()););if(this.buffer.length===0)return null;let t=this.ja();t<0&&this.Ga("Reached the end of bundle when a length string is expected.");let e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e})}za(t){return p(this,null,function*(){for(;this.buffer.length<t;)(yield this.Ha())&&this.Ga("Reached the end of bundle when more is expected.");let e=this.$a.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e})}Ga(t){throw this.Ka.cancel(),new Error(`Invalid bundle format: ${t}`)}Ha(){return p(this,null,function*(){let t=yield this.Ka.read();if(!t.done){let e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done})}};var sc=class{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}lookup(t){return p(this,null,function*(){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new _(g.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let e=yield function(i,s){return p(this,null,function*(){let o=E(i),a={documents:s.map(h=>ii(o.serializer,h))},u=yield o.vo("BatchGetDocuments",o.serializer.databaseId,M.emptyPath(),a,s.length),c=new Map;u.forEach(h=>{let d=x_(o.serializer,h);c.set(d.key.toString(),d)});let l=[];return s.forEach(h=>{let d=c.get(h.toString());R(!!d),l.push(d)}),l})}(this.datastore,t);return e.forEach(r=>this.recordVersion(r)),e})}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(r){this.lastTransactionError=r}this.writtenDocs.add(t.toString())}delete(t){this.write(new De(t,this.precondition(t))),this.writtenDocs.add(t.toString())}commit(){return p(this,null,function*(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,r)=>{let i=I.fromPath(r);this.mutations.push(new Zr(i,this.precondition(i)))}),yield function(r,i){return p(this,null,function*(){let s=E(r),o={writes:i.map(a=>si(s.serializer,a))};yield s.So("Commit",s.serializer.databaseId,M.emptyPath(),o)})}(this.datastore,this.mutations),this.committed=!0})}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw S();e=P.min()}let r=this.readVersions.get(t.key.toString());if(r){if(!e.isEqual(r))throw new _(g.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){let e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?e.isEqual(P.min())?Z.exists(!1):Z.updateTime(e):Z.none()}preconditionForUpdate(t){let e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(P.min()))throw new _(g.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Z.updateTime(e)}return Z.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}};var oc=class{constructor(t,e,r,i,s){this.asyncQueue=t,this.datastore=e,this.options=r,this.updateFunction=i,this.deferred=s,this.Ja=r.maxAttempts,this.jo=new ci(this.asyncQueue,"transaction_retry")}Ya(){this.Ja-=1,this.Za()}Za(){this.jo.qo(()=>p(this,null,function*(){let t=new sc(this.datastore),e=this.Xa(t);e&&e.then(r=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(r)}).catch(i=>{this.eu(i)}))}).catch(r=>{this.eu(r)})}))}Xa(t){try{let e=this.updateFunction(t);return!gi(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}eu(t){this.Ja>0&&this.tu(t)?(this.Ja-=1,this.asyncQueue.enqueueAndForget(()=>(this.Za(),Promise.resolve()))):this.deferred.reject(t)}tu(t){if(t.name==="FirebaseError"){let e=t.code;return e==="aborted"||e==="failed-precondition"||e==="already-exists"||!Xf(e)}return!1}};var ac=class{constructor(t,e,r,i){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=r,this.databaseInfo=i,this.user=ot.UNAUTHENTICATED,this.clientId=ms.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(r,s=>p(this,null,function*(){y("FirestoreClient","Received user=",s.uid),yield this.authCredentialListener(s),this.user=s})),this.appCheckCredentials.start(r,s=>(y("FirestoreClient","Received new app check token=",s),this.appCheckCredentialListener(s,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new _(g.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();let t=new at;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(()=>p(this,null,function*(){try{this._onlineComponents&&(yield this._onlineComponents.terminate()),this._offlineComponents&&(yield this._offlineComponents.terminate()),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){let r=sr(e,"Failed to shutdown persistence");t.reject(r)}})),t.promise}};function ds(n,t){return p(this,null,function*(){n.asyncQueue.verifyOperationInProgress(),y("FirestoreClient","Initializing OfflineComponentProvider");let e=n.configuration;yield t.initialize(e);let r=e.initialUser;n.setCredentialChangeListener(i=>p(this,null,function*(){r.isEqual(i)||(yield Im(t.localStore,i),r=i)})),t.persistence.setDatabaseDeletedListener(()=>n.terminate()),n._offlineComponents=t})}function uc(n,t){return p(this,null,function*(){n.asyncQueue.verifyOperationInProgress();let e=yield $c(n);y("FirestoreClient","Initializing OnlineComponentProvider"),yield t.initialize(e,n.configuration),n.setCredentialChangeListener(r=>sf(t.remoteStore,r)),n.setAppCheckTokenChangeListener((r,i)=>sf(t.remoteStore,i)),n._onlineComponents=t})}function Lm(n){return n.name==="FirebaseError"?n.code===g.FAILED_PRECONDITION||n.code===g.UNIMPLEMENTED:!(typeof DOMException<"u"&&n instanceof DOMException)||n.code===22||n.code===20||n.code===11}function $c(n){return p(this,null,function*(){if(!n._offlineComponents)if(n._uninitializedComponentsProvider){y("FirestoreClient","Using user provided OfflineComponentProvider");try{yield ds(n,n._uninitializedComponentsProvider._offline)}catch(t){let e=t;if(!Lm(e))throw e;kt("Error using user provided cache. Falling back to memory cache: "+e),yield ds(n,new hi)}}else y("FirestoreClient","Using default OfflineComponentProvider"),yield ds(n,new hi);return n._offlineComponents})}function fo(n){return p(this,null,function*(){return n._onlineComponents||(n._uninitializedComponentsProvider?(y("FirestoreClient","Using user provided OnlineComponentProvider"),yield uc(n,n._uninitializedComponentsProvider._online)):(y("FirestoreClient","Using default OnlineComponentProvider"),yield uc(n,new di))),n._onlineComponents})}function qm(n){return $c(n).then(t=>t.persistence)}function Qc(n){return $c(n).then(t=>t.localStore)}function Bm(n){return fo(n).then(t=>t.remoteStore)}function Wc(n){return fo(n).then(t=>t.syncEngine)}function Sy(n){return fo(n).then(t=>t.datastore)}function Xn(n){return p(this,null,function*(){let t=yield fo(n),e=t.eventManager;return e.onListen=sy.bind(null,t.syncEngine),e.onUnlisten=ay.bind(null,t.syncEngine),e.onFirstRemoteStoreListen=oy.bind(null,t.syncEngine),e.onLastRemoteStoreUnlisten=uy.bind(null,t.syncEngine),e})}function Ry(n){return n.asyncQueue.enqueue(()=>p(this,null,function*(){let t=yield qm(n),e=yield Bm(n);return t.setNetworkEnabled(!0),function(i){let s=E(i);return s.v_.delete(0),vi(s)}(e)}))}function Py(n){return n.asyncQueue.enqueue(()=>p(this,null,function*(){let t=yield qm(n),e=yield Bm(n);return t.setNetworkEnabled(!1),function(i){return p(this,null,function*(){let s=E(i);s.v_.add(0),yield nr(s),s.x_.set("Offline")})}(e)}))}function Cy(n,t){let e=new at;return n.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return function(i,s,o){return p(this,null,function*(){try{let a=yield function(c,l){let h=E(c);return h.persistence.runTransaction("read document","readonly",d=>h.localDocuments.getDocument(d,l))}(i,s);a.isFoundDocument()?o.resolve(a):a.isNoDocument()?o.resolve(null):o.reject(new _(g.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(a){let u=sr(a,`Failed to get document '${s} from cache`);o.reject(u)}})}(yield Qc(n),t,e)})),e.promise}function Um(n,t,e={}){let r=new at;return n.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return function(s,o,a,u,c){let l=new Jn({next:d=>{o.enqueueAndForget(()=>qc(s,h));let m=d.docs.has(a);!m&&d.fromCache?c.reject(new _(g.UNAVAILABLE,"Failed to get document because the client is offline.")):m&&d.fromCache&&u&&u.source==="server"?c.reject(new _(g.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):c.resolve(d)},error:d=>c.reject(d)}),h=new li(er(a.path),l,{includeMetadataChanges:!0,ta:!0});return Lc(s,h)}(yield Xn(n),n.asyncQueue,t,e,r)})),r.promise}function by(n,t){let e=new at;return n.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return function(i,s,o){return p(this,null,function*(){try{let a=yield Bs(i,s,!0),u=new Xs(s,a.hs),c=u.Ta(a.documents),l=u.applyChanges(c,!1);o.resolve(l.snapshot)}catch(a){let u=sr(a,`Failed to execute query '${s} against cache`);o.reject(u)}})}(yield Qc(n),t,e)})),e.promise}function Gm(n,t,e={}){let r=new at;return n.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return function(s,o,a,u,c){let l=new Jn({next:d=>{o.enqueueAndForget(()=>qc(s,h)),d.fromCache&&u.source==="server"?c.reject(new _(g.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):c.resolve(d)},error:d=>c.reject(d)}),h=new li(a,l,{includeMetadataChanges:!0,ta:!0});return Lc(s,h)}(yield Xn(n),n.asyncQueue,t,e,r)})),r.promise}function xy(n,t){let e=new Jn(t);return n.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return function(i,s){E(i).W_.add(s),s.next()}(yield Xn(n),e)})),()=>{e.Qa(),n.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return function(i,s){E(i).W_.delete(s)}(yield Xn(n),e)}))}}function Vy(n,t,e,r){let i=function(o,a){let u;return u=typeof o=="string"?tm().encode(o):o,function(l,h){return new ic(l,h)}(function(l,h){if(l instanceof Uint8Array)return cf(l,h);if(l instanceof ArrayBuffer)return cf(new Uint8Array(l),h);if(l instanceof ReadableStream)return l.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(u),a)}(e,wi(t));n.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){Ay(yield Wc(n),i,r)}))}function Dy(n,t){return n.asyncQueue.enqueue(()=>p(this,null,function*(){return function(r,i){let s=E(r);return s.persistence.runTransaction("Get named query","readonly",o=>s.$r.getNamedQuery(o,i))}(yield Qc(n),t)}))}function jm(n){let t={};return n.timeoutSeconds!==void 0&&(t.timeoutSeconds=n.timeoutSeconds),t}var lf=new Map;function Hc(n,t,e){if(!e)throw new _(g.INVALID_ARGUMENT,`Function ${n}() cannot be called with an empty ${t}.`)}function Yc(n,t,e,r){if(t===!0&&r===!0)throw new _(g.INVALID_ARGUMENT,`${n} and ${e} cannot be used together.`)}function hf(n){if(!I.isDocumentKey(n))throw new _(g.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${n} has ${n.length}.`)}function df(n){if(I.isDocumentKey(n))throw new _(g.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${n} has ${n.length}.`)}function mo(n){if(n===void 0)return"undefined";if(n===null)return"null";if(typeof n=="string")return n.length>20&&(n=`${n.substring(0,20)}...`),JSON.stringify(n);if(typeof n=="number"||typeof n=="boolean")return""+n;if(typeof n=="object"){if(n instanceof Array)return"an array";{let t=function(r){return r.constructor?r.constructor.name:null}(n);return t?`a custom ${t} object`:"an object"}}return typeof n=="function"?"a function":S()}function O(n,t){if("_delegate"in n&&(n=n._delegate),!(n instanceof t)){if(t.name===n.constructor.name)throw new _(g.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let e=mo(n);throw new _(g.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${e}`)}}return n}function zm(n,t){if(t<=0)throw new _(g.INVALID_ARGUMENT,`Function ${n}() requires a positive number, but it was: ${t}.`)}var to=class{constructor(t){var e,r;if(t.host===void 0){if(t.ssl!==void 0)throw new _(g.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=(e=t.ssl)===null||e===void 0||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,t.cacheSizeBytes===void 0)this.cacheSizeBytes=41943040;else{if(t.cacheSizeBytes!==-1&&t.cacheSizeBytes<1048576)throw new _(g.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}Yc("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:t.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=jm((r=t.experimentalLongPollingOptions)!==null&&r!==void 0?r:{}),function(s){if(s.timeoutSeconds!==void 0){if(isNaN(s.timeoutSeconds))throw new _(g.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (must not be NaN)`);if(s.timeoutSeconds<5)throw new _(g.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (minimum allowed value is 5)`);if(s.timeoutSeconds>30)throw new _(g.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(r,i){return r.timeoutSeconds===i.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}},rn=class{constructor(t,e,r,i){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=r,this._app=i,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new to({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new _(g.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!==void 0}_setSettings(t){if(this._settingsFrozen)throw new _(g.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new to(t),t.credentials!==void 0&&(this._authCredentials=function(r){if(!r)return new Ra;switch(r.type){case"firstParty":return new xa(r.sessionIndex||"0",r.iamToken||null,r.authTokenFactory||null);case"provider":return r.client;default:throw new _(g.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let r=lf.get(e);r&&(y("ComponentProvider","Removing Datastore"),lf.delete(e),r.terminate())}(this),Promise.resolve()}};function Km(n,t,e,r={}){var i;let s=(n=O(n,rn))._getSettings(),o=`${t}:${e}`;if(s.host!=="firestore.googleapis.com"&&s.host!==o&&kt("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),n._setSettings(Object.assign(Object.assign({},s),{host:o,ssl:!1})),r.mockUserToken){let a,u;if(typeof r.mockUserToken=="string")a=r.mockUserToken,u=ot.MOCK_USER;else{a=Pl(r.mockUserToken,(i=n._app)===null||i===void 0?void 0:i.options.projectId);let c=r.mockUserToken.sub||r.mockUserToken.user_id;if(!c)throw new _(g.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");u=new ot(c)}n._authCredentials=new Pa(new fs(a,u))}}var pt=class n{constructor(t,e,r){this.converter=e,this._query=r,this.type="query",this.firestore=t}withConverter(t){return new n(this.firestore,t,this._query)}},z=class n{constructor(t,e,r){this.converter=e,this._key=r,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Xt(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new n(this.firestore,t,this._key)}},Xt=class n extends pt{constructor(t,e,r){super(t,e,er(r)),this._path=r,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let t=this._path.popLast();return t.isEmpty()?null:new z(this.firestore,null,new I(t))}withConverter(t){return new n(this.firestore,t,this._path)}};function Jc(n,t,...e){if(n=Y(n),Hc("collection","path",t),n instanceof rn){let r=M.fromString(t,...e);return df(r),new Xt(n,null,r)}{if(!(n instanceof z||n instanceof Xt))throw new _(g.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=n._path.child(M.fromString(t,...e));return df(r),new Xt(n.firestore,null,r)}}function $m(n,t){if(n=O(n,rn),Hc("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new _(g.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new pt(n,null,function(r){return new qt(M.emptyPath(),r)}(t))}function Ii(n,t,...e){if(n=Y(n),arguments.length===1&&(t=ms.newId()),Hc("doc","path",t),n instanceof rn){let r=M.fromString(t,...e);return hf(r),new z(n,null,new I(r))}{if(!(n instanceof z||n instanceof Xt))throw new _(g.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=n._path.child(M.fromString(t,...e));return hf(r),new z(n.firestore,n instanceof Xt?n.converter:null,new I(r))}}function Xc(n,t){return n=Y(n),t=Y(t),(n instanceof z||n instanceof Xt)&&(t instanceof z||t instanceof Xt)&&n.firestore===t.firestore&&n.path===t.path&&n.converter===t.converter}function Zc(n,t){return n=Y(n),t=Y(t),n instanceof pt&&t instanceof pt&&n.firestore===t.firestore&&_i(n._query,t._query)&&n.converter===t.converter}var cc=class{constructor(){this.nu=Promise.resolve(),this.ru=[],this.iu=!1,this.su=[],this.ou=null,this._u=!1,this.au=!1,this.uu=[],this.jo=new ci(this,"async_queue_retry"),this.cu=()=>{let e=hs();e&&y("AsyncQueue","Visibility state changed to "+e.visibilityState),this.jo.Ko()};let t=hs();t&&typeof t.addEventListener=="function"&&t.addEventListener("visibilitychange",this.cu)}get isShuttingDown(){return this.iu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.lu(),this.hu(t)}enterRestrictedMode(t){if(!this.iu){this.iu=!0,this.au=t||!1;let e=hs();e&&typeof e.removeEventListener=="function"&&e.removeEventListener("visibilitychange",this.cu)}}enqueue(t){if(this.lu(),this.iu)return new Promise(()=>{});let e=new at;return this.hu(()=>this.iu&&this.au?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.ru.push(t),this.Pu()))}Pu(){return p(this,null,function*(){if(this.ru.length!==0){try{yield this.ru[0](),this.ru.shift(),this.jo.reset()}catch(t){if(!Fe(t))throw t;y("AsyncQueue","Operation failed with retryable error: "+t)}this.ru.length>0&&this.jo.qo(()=>this.Pu())}})}hu(t){let e=this.nu.then(()=>(this._u=!0,t().catch(r=>{this.ou=r,this._u=!1;let i=function(o){let a=o.message||"";return o.stack&&(a=o.stack.includes(o.message)?o.stack:o.message+`
`+o.stack),a}(r);throw tt("INTERNAL UNHANDLED ERROR: ",i),r}).then(r=>(this._u=!1,r))));return this.nu=e,e}enqueueAfterDelay(t,e,r){this.lu(),this.uu.indexOf(t)>-1&&(e=0);let i=Qu.createAndSchedule(this,t,e,r,s=>this.Iu(s));return this.su.push(i),i}lu(){this.ou&&S()}verifyOperationInProgress(){}Tu(){return p(this,null,function*(){let t;do t=this.nu,yield t;while(t!==this.nu)})}Eu(t){for(let e of this.su)if(e.timerId===t)return!0;return!1}du(t){return this.Tu().then(()=>{this.su.sort((e,r)=>e.targetTimeMs-r.targetTimeMs);for(let e of this.su)if(e.skipDelay(),t!=="all"&&e.timerId===t)break;return this.Tu()})}Au(t){this.uu.push(t)}Iu(t){let e=this.su.indexOf(t);this.su.splice(e,1)}};function lc(n){return function(e,r){if(typeof e!="object"||e===null)return!1;let i=e;for(let s of r)if(s in i&&typeof i[s]=="function")return!0;return!1}(n,["next","error","complete"])}var hc=class{constructor(){this._progressObserver={},this._taskCompletionResolver=new at,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,r){this._progressObserver={next:t,error:e,complete:r}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}};var Qm=-1,Q=class extends rn{constructor(t,e,r,i){super(t,e,r,i),this.type="firestore",this._queue=function(){return new cc}(),this._persistenceKey=i?.name||"[DEFAULT]"}_terminate(){return this._firestoreClient||Wm(this),this._firestoreClient.terminate()}};function ct(n){return n._firestoreClient||Wm(n),n._firestoreClient.verifyNotTerminated(),n._firestoreClient}function Wm(n){var t,e,r;let i=n._freezeSettings(),s=function(a,u,c,l){return new La(a,u,c,l.host,l.ssl,l.experimentalForceLongPolling,l.experimentalAutoDetectLongPolling,jm(l.experimentalLongPollingOptions),l.useFetchStreams)}(n._databaseId,((t=n._app)===null||t===void 0?void 0:t.options.appId)||"",n._persistenceKey,i);n._firestoreClient=new ac(n._authCredentials,n._appCheckCredentials,n._queue,s),!((e=i.localCache)===null||e===void 0)&&e._offlineComponentProvider&&(!((r=i.localCache)===null||r===void 0)&&r._onlineComponentProvider)&&(n._firestoreClient._uninitializedComponentsProvider={_offlineKind:i.localCache.kind,_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider})}function Hm(n,t){ig(n=O(n,Q));let e=ct(n);if(e._uninitializedComponentsProvider)throw new _(g.FAILED_PRECONDITION,"SDK cache is already specified.");kt("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let r=n._freezeSettings(),i=new di;return Jm(e,i,new Zs(i,r.cacheSizeBytes,t?.forceOwnership))}function Ym(n){ig(n=O(n,Q));let t=ct(n);if(t._uninitializedComponentsProvider)throw new _(g.FAILED_PRECONDITION,"SDK cache is already specified.");kt("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let e=n._freezeSettings(),r=new di;return Jm(t,r,new rc(r,e.cacheSizeBytes))}function Jm(n,t,e){let r=new at;return n.asyncQueue.enqueue(()=>p(this,null,function*(){try{yield ds(n,e),yield uc(n,t),r.resolve()}catch(i){let s=i;if(!Lm(s))throw s;kt("Error enabling indexeddb cache. Falling back to memory cache: "+s),r.reject(s)}})).then(()=>r.promise)}function Xm(n){if(n._initialized&&!n._terminated)throw new _(g.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");let t=new at;return n._queue.enqueueAndForgetEvenWhileRestricted(()=>p(this,null,function*(){try{yield function(r){return p(this,null,function*(){if(!ue.D())return Promise.resolve();let i=r+"main";yield ue.delete(i)})}(kc(n._databaseId,n._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise}function Zm(n){return function(e){let r=new at;return e.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return fy(yield Wc(e),r)})),r.promise}(ct(n=O(n,Q)))}function tg(n){return Ry(ct(n=O(n,Q)))}function eg(n){return Py(ct(n=O(n,Q)))}function ng(n,t){let e=ct(n=O(n,Q)),r=new hc;return Vy(e,n._databaseId,t,r),r}function rg(n,t){return Dy(ct(n=O(n,Q)),t).then(e=>e?new pt(n,null,e.query):null)}function ig(n){if(n._initialized||n._terminated)throw new _(g.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}var ne=class n{constructor(t){this._byteString=t}static fromBase64String(t){try{return new n(dt.fromBase64String(t))}catch(e){throw new _(g.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(t){return new n(dt.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}};var Ut=class{constructor(...t){for(let e=0;e<t.length;++e)if(t[e].length===0)throw new _(g.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new et(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}};var de=class{constructor(t){this._methodName=t}};var sn=class{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new _(g.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new _(g.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return V(this._lat,t._lat)||V(this._long,t._long)}};var Ny=/^__.*__$/,dc=class{constructor(t,e,r){this.data=t,this.fieldMask=e,this.fieldTransforms=r}toMutation(t,e){return this.fieldMask!==null?new Bt(t,this.data,this.fieldMask,e,this.fieldTransforms):new Ve(t,this.data,e,this.fieldTransforms)}},eo=class{constructor(t,e,r){this.data=t,this.fieldMask=e,this.fieldTransforms=r}toMutation(t,e){return new Bt(t,this.data,this.fieldMask,e,this.fieldTransforms)}};function sg(n){switch(n){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw S()}}var no=class n{constructor(t,e,r,i,s,o){this.settings=t,this.databaseId=e,this.serializer=r,this.ignoreUndefinedProperties=i,s===void 0&&this.Ru(),this.fieldTransforms=s||[],this.fieldMask=o||[]}get path(){return this.settings.path}get Vu(){return this.settings.Vu}mu(t){return new n(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}fu(t){var e;let r=(e=this.path)===null||e===void 0?void 0:e.child(t),i=this.mu({path:r,gu:!1});return i.pu(t),i}yu(t){var e;let r=(e=this.path)===null||e===void 0?void 0:e.child(t),i=this.mu({path:r,gu:!1});return i.Ru(),i}wu(t){return this.mu({path:void 0,gu:!0})}Su(t){return ro(t,this.settings.methodName,this.settings.bu||!1,this.path,this.settings.Du)}contains(t){return this.fieldMask.find(e=>t.isPrefixOf(e))!==void 0||this.fieldTransforms.find(e=>t.isPrefixOf(e.field))!==void 0}Ru(){if(this.path)for(let t=0;t<this.path.length;t++)this.pu(this.path.get(t))}pu(t){if(t.length===0)throw this.Su("Document fields must not be empty");if(sg(this.Vu)&&Ny.test(t))throw this.Su('Document fields cannot begin and end with "__"')}},fc=class{constructor(t,e,r){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=r||wi(t)}Cu(t,e,r,i=!1){return new no({Vu:t,methodName:e,Du:r,path:et.emptyPath(),gu:!1,bu:i},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}};function cn(n){let t=n._freezeSettings(),e=wi(n._databaseId);return new fc(n._databaseId,!!t.ignoreUndefinedProperties,e)}function go(n,t,e,r,i,s={}){let o=n.Cu(s.merge||s.mergeFields?2:0,t,e,i);nl("Data must be an object, but it was:",o,r);let a=ug(r,o),u,c;if(s.merge)u=new bt(o.fieldMask),c=o.fieldTransforms;else if(s.mergeFields){let l=[];for(let h of s.mergeFields){let d=yc(t,h,e);if(!o.contains(d))throw new _(g.INVALID_ARGUMENT,`Field '${d}' is specified in your field mask but missing from your input data.`);lg(l,d)||l.push(d)}u=new bt(l),c=o.fieldTransforms.filter(h=>u.covers(h.field))}else u=null,c=o.fieldTransforms;return new dc(new It(a),u,c)}var fi=class n extends de{_toFieldTransform(t){if(t.Vu!==2)throw t.Vu===1?t.Su(`${this._methodName}() can only appear at the top level of your update data`):t.Su(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof n}};function og(n,t,e){return new no({Vu:3,Du:t.settings.Du,methodName:n._methodName,gu:e},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}var mc=class n extends de{_toFieldTransform(t){return new tn(t.path,new be)}isEqual(t){return t instanceof n}},gc=class n extends de{constructor(t,e){super(t),this.vu=e}_toFieldTransform(t){let e=og(this,t,!0),r=this.vu.map(s=>ln(s,e)),i=new le(r);return new tn(t.path,i)}isEqual(t){return t instanceof n&&bo(this.vu,t.vu)}},pc=class n extends de{constructor(t,e){super(t),this.vu=e}_toFieldTransform(t){let e=og(this,t,!0),r=this.vu.map(s=>ln(s,e)),i=new he(r);return new tn(t.path,i)}isEqual(t){return t instanceof n&&bo(this.vu,t.vu)}},_c=class n extends de{constructor(t,e){super(t),this.Fu=e}_toFieldTransform(t){let e=new xe(t.serializer,Kf(t.serializer,this.Fu));return new tn(t.path,e)}isEqual(t){return t instanceof n&&this.Fu===t.Fu}};function tl(n,t,e,r){let i=n.Cu(1,t,e);nl("Data must be an object, but it was:",i,r);let s=[],o=It.empty();un(r,(u,c)=>{let l=rl(t,u,e);c=Y(c);let h=i.yu(l);if(c instanceof fi)s.push(l);else{let d=ln(c,h);d!=null&&(s.push(l),o.set(l,d))}});let a=new bt(s);return new eo(o,a,i.fieldTransforms)}function el(n,t,e,r,i,s){let o=n.Cu(1,t,e),a=[yc(t,r,e)],u=[i];if(s.length%2!=0)throw new _(g.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let d=0;d<s.length;d+=2)a.push(yc(t,s[d])),u.push(s[d+1]);let c=[],l=It.empty();for(let d=a.length-1;d>=0;--d)if(!lg(c,a[d])){let m=a[d],A=u[d];A=Y(A);let w=o.yu(m);if(A instanceof fi)c.push(m);else{let v=ln(A,w);v!=null&&(c.push(m),l.set(m,v))}}let h=new bt(c);return new eo(l,h,o.fieldTransforms)}function ag(n,t,e,r=!1){return ln(e,n.Cu(r?4:3,t))}function ln(n,t){if(cg(n=Y(n)))return nl("Unsupported field value:",t,n),ug(n,t);if(n instanceof de)return function(r,i){if(!sg(i.Vu))throw i.Su(`${r._methodName}() can only be used with update() and set()`);if(!i.path)throw i.Su(`${r._methodName}() is not currently supported inside arrays`);let s=r._toFieldTransform(i);s&&i.fieldTransforms.push(s)}(n,t),null;if(n===void 0&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),n instanceof Array){if(t.settings.gu&&t.Vu!==4)throw t.Su("Nested arrays are not supported");return function(r,i){let s=[],o=0;for(let a of r){let u=ln(a,i.wu(o));u==null&&(u={nullValue:"NULL_VALUE"}),s.push(u),o++}return{arrayValue:{values:s}}}(n,t)}return function(r,i){if((r=Y(r))===null)return{nullValue:"NULL_VALUE"};if(typeof r=="number")return Kf(i.serializer,r);if(typeof r=="boolean")return{booleanValue:r};if(typeof r=="string")return{stringValue:r};if(r instanceof Date){let s=W.fromDate(r);return{timestampValue:jn(i.serializer,s)}}if(r instanceof W){let s=new W(r.seconds,1e3*Math.floor(r.nanoseconds/1e3));return{timestampValue:jn(i.serializer,s)}}if(r instanceof sn)return{geoPointValue:{latitude:r.latitude,longitude:r.longitude}};if(r instanceof ne)return{bytesValue:em(i.serializer,r._byteString)};if(r instanceof z){let s=i.databaseId,o=r.firestore._databaseId;if(!o.isEqual(s))throw i.Su(`Document reference is for database ${o.projectId}/${o.database} but should be for database ${s.projectId}/${s.database}`);return{referenceValue:Vc(r.firestore._databaseId||i.databaseId,r._key.path)}}throw i.Su(`Unsupported field value: ${mo(r)}`)}(n,t)}function ug(n,t){let e={};return Pf(n)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):un(n,(r,i)=>{let s=ln(i,t.fu(r));s!=null&&(e[r]=s)}),{mapValue:{fields:e}}}function cg(n){return!(typeof n!="object"||n===null||n instanceof Array||n instanceof Date||n instanceof W||n instanceof sn||n instanceof ne||n instanceof z||n instanceof de)}function nl(n,t,e){if(!cg(e)||!function(i){return typeof i=="object"&&i!==null&&(Object.getPrototypeOf(i)===Object.prototype||Object.getPrototypeOf(i)===null)}(e)){let r=mo(e);throw r==="an object"?t.Su(n+" a custom object"):t.Su(n+" "+r)}}function yc(n,t,e){if((t=Y(t))instanceof Ut)return t._internalPath;if(typeof t=="string")return rl(n,t);throw ro("Field path arguments must be of type string or ",n,!1,void 0,e)}var ky=new RegExp("[~\\*/\\[\\]]");function rl(n,t,e){if(t.search(ky)>=0)throw ro(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,n,!1,void 0,e);try{return new Ut(...t.split("."))._internalPath}catch{throw ro(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,n,!1,void 0,e)}}function ro(n,t,e,r,i){let s=r&&!r.isEmpty(),o=i!==void 0,a=`Function ${t}() called with invalid data`;e&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(s||o)&&(u+=" (found",s&&(u+=` in field ${r}`),o&&(u+=` in document ${i}`),u+=")"),new _(g.INVALID_ARGUMENT,a+n+u)}function lg(n,t){return n.some(e=>e.isEqual(t))}var on=class{constructor(t,e,r,i,s){this._firestore=t,this._userDataWriter=e,this._key=r,this._document=i,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new z(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){let t=new wc(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){let e=this._document.data.field(po("DocumentSnapshot.get",t));if(e!==null)return this._userDataWriter.convertValue(e)}}},wc=class extends on{data(){return super.data()}};function po(n,t){return typeof t=="string"?rl(n,t):t instanceof Ut?t._internalPath:t._delegate._internalPath}function hg(n){if(n.limitType==="L"&&n.explicitOrderBy.length===0)throw new _(g.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}var mi=class{},an=class extends mi{};function ge(n,t,...e){let r=[];t instanceof mi&&r.push(t),r=r.concat(e),function(s){let o=s.filter(u=>u instanceof vc).length,a=s.filter(u=>u instanceof io).length;if(o>1||o>0&&a>0)throw new _(g.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(let i of r)n=i._apply(n);return n}var io=class n extends an{constructor(t,e,r){super(),this._field=t,this._op=e,this._value=r,this.type="where"}static _create(t,e,r){return new n(t,e,r)}_apply(t){let e=this._parse(t);return Ig(t._query,e),new pt(t.firestore,t.converter,Ja(t._query,e))}_parse(t){let e=cn(t.firestore);return function(s,o,a,u,c,l,h){let d;if(c.isKeyField()){if(l==="array-contains"||l==="array-contains-any")throw new _(g.INVALID_ARGUMENT,`Invalid Query. You can't perform '${l}' queries on documentId().`);if(l==="in"||l==="not-in"){mf(h,l);let m=[];for(let A of h)m.push(ff(u,s,A));d={arrayValue:{values:m}}}else d=ff(u,s,h)}else l!=="in"&&l!=="not-in"&&l!=="array-contains-any"||mf(h,l),d=ag(a,o,h,l==="in"||l==="not-in");return k.create(c,l,d)}(t._query,"where",e,t.firestore._databaseId,this._field,this._op,this._value)}};function dg(n,t,e){let r=t,i=po("where",n);return io._create(i,r,e)}var vc=class n extends mi{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new n(t,e)}_parse(t){let e=this._queryConstraints.map(r=>r._parse(t)).filter(r=>r.getFilters().length>0);return e.length===1?e[0]:G.create(e,this._getOperator())}_apply(t){let e=this._parse(t);return e.getFilters().length===0?t:(function(i,s){let o=i,a=s.getFlattenedFilters();for(let u of a)Ig(o,u),o=Ja(o,u)}(t._query,e),new pt(t.firestore,t.converter,Ja(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}};var Ic=class n extends an{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new n(t,e)}_apply(t){let e=function(i,s,o){if(i.startAt!==null)throw new _(g.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(i.endAt!==null)throw new _(g.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Xe(s,o)}(t._query,this._field,this._direction);return new pt(t.firestore,t.converter,function(i,s){let o=i.explicitOrderBy.concat([s]);return new qt(i.path,i.collectionGroup,o,i.filters.slice(),i.limit,i.limitType,i.startAt,i.endAt)}(t._query,e))}};function fg(n,t="asc"){let e=t,r=po("orderBy",n);return Ic._create(r,e)}var so=class n extends an{constructor(t,e,r){super(),this.type=t,this._limit=e,this._limitType=r}static _create(t,e,r){return new n(t,e,r)}_apply(t){return new pt(t.firestore,t.converter,As(t._query,this._limit,this._limitType))}};function mg(n){return zm("limit",n),so._create("limit",n,"F")}function gg(n){return zm("limitToLast",n),so._create("limitToLast",n,"L")}var oo=class n extends an{constructor(t,e,r){super(),this.type=t,this._docOrFields=e,this._inclusive=r}static _create(t,e,r){return new n(t,e,r)}_apply(t){let e=vg(t,this.type,this._docOrFields,this._inclusive);return new pt(t.firestore,t.converter,function(i,s){return new qt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,s,i.endAt)}(t._query,e))}};function pg(...n){return oo._create("startAt",n,!0)}function _g(...n){return oo._create("startAfter",n,!1)}var ao=class n extends an{constructor(t,e,r){super(),this.type=t,this._docOrFields=e,this._inclusive=r}static _create(t,e,r){return new n(t,e,r)}_apply(t){let e=vg(t,this.type,this._docOrFields,this._inclusive);return new pt(t.firestore,t.converter,function(i,s){return new qt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,i.startAt,s)}(t._query,e))}};function yg(...n){return ao._create("endBefore",n,!1)}function wg(...n){return ao._create("endAt",n,!0)}function vg(n,t,e,r){if(e[0]=Y(e[0]),e[0]instanceof on)return function(s,o,a,u,c){if(!u)throw new _(g.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${a}().`);let l=[];for(let h of Fn(s))if(h.field.isKeyField())l.push(Je(o,u.key));else{let d=u.data.field(h.field);if(co(d))throw new _(g.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+h.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(d===null){let m=h.field.canonicalString();throw new _(g.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${m}' (used as the orderBy) does not exist.`)}l.push(d)}return new te(l,c)}(n._query,n.firestore._databaseId,t,e[0]._document,r);{let i=cn(n.firestore);return function(o,a,u,c,l,h){let d=o.explicitOrderBy;if(l.length>d.length)throw new _(g.INVALID_ARGUMENT,`Too many arguments provided to ${c}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let m=[];for(let A=0;A<l.length;A++){let w=l[A];if(d[A].field.isKeyField()){if(typeof w!="string")throw new _(g.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${c}(), but got a ${typeof w}`);if(!bc(o)&&w.indexOf("/")!==-1)throw new _(g.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${c}() must be a plain document ID, but '${w}' contains a slash.`);let v=o.path.child(M.fromString(w));if(!I.isDocumentKey(v))throw new _(g.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${c}() must result in a valid document path, but '${v}' is not because it contains an odd number of segments.`);let C=new I(v);m.push(Je(a,C))}else{let v=ag(u,c,w);m.push(v)}}return new te(m,h)}(n._query,n.firestore._databaseId,i,t,e,r)}}function ff(n,t,e){if(typeof(e=Y(e))=="string"){if(e==="")throw new _(g.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!bc(t)&&e.indexOf("/")!==-1)throw new _(g.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${e}' contains a '/' character.`);let r=t.path.child(M.fromString(e));if(!I.isDocumentKey(r))throw new _(g.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Je(n,new I(r))}if(e instanceof z)return Je(n,e._key);throw new _(g.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${mo(e)}.`)}function mf(n,t){if(!Array.isArray(n)||n.length===0)throw new _(g.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function Ig(n,t){let e=function(i,s){for(let o of i)for(let a of o.getFlattenedFilters())if(s.indexOf(a.op)>=0)return a.op;return null}(n.filters,function(i){switch(i){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(e!==null)throw e===t.op?new _(g.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new _(g.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${e.toString()}' filters.`)}var Zn=class{convertValue(t,e="none"){switch(Ye(t)){case 0:return null;case 1:return t.booleanValue;case 2:return X(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(Re(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw S()}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t,e="none"){let r={};return un(t,(i,s)=>{r[i]=this.convertValue(s,e)}),r}convertGeoPoint(t){return new sn(X(t.latitude),X(t.longitude))}convertArray(t,e){return(t.values||[]).map(r=>this.convertValue(r,e))}convertServerTimestamp(t,e){switch(e){case"previous":let r=Pc(t);return r==null?null:this.convertValue(r,e);case"estimate":return this.convertTimestamp(Yr(t));default:return null}}convertTimestamp(t){let e=ce(t);return new W(e.seconds,e.nanos)}convertDocumentKey(t,e){let r=M.fromString(t);R(dm(r));let i=new Pe(r.get(1),r.get(3)),s=new I(r.popFirst(5));return i.isEqual(e)||tt(`Document ${s} contains a document reference within a different database (${i.projectId}/${i.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}};function _o(n,t,e){let r;return r=n?e&&(e.merge||e.mergeFields)?n.toFirestore(t,e):n.toFirestore(t):t,r}var Ec=class extends Zn{constructor(t){super(),this.firestore=t}convertBytes(t){return new ne(t)}convertReference(t){let e=this.convertDocumentKey(t,this.firestore._databaseId);return new z(this.firestore,null,e)}};var ae=class{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}},Mt=class extends on{constructor(t,e,r,i,s,o){super(t,e,r,i,o),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){let e=new Ae(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){let r=this._document.data.field(po("DocumentSnapshot.get",t));if(r!==null)return this._userDataWriter.convertValue(r,e.serverTimestamps)}}},Ae=class extends Mt{data(t={}){return super.data(t)}},Gt=class{constructor(t,e,r,i){this._firestore=t,this._userDataWriter=e,this._snapshot=i,this.metadata=new ae(i.hasPendingWrites,i.fromCache),this.query=r}get docs(){let t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(t,e){this._snapshot.docs.forEach(r=>{t.call(e,new Ae(this._firestore,this._userDataWriter,r.key,r,new ae(this._snapshot.mutatedKeys.has(r.key),this._snapshot.fromCache),this.query.converter))})}docChanges(t={}){let e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new _(g.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(i,s){if(i._snapshot.oldDocs.isEmpty()){let o=0;return i._snapshot.docChanges.map(a=>{let u=new Ae(i._firestore,i._userDataWriter,a.doc.key,a.doc,new ae(i._snapshot.mutatedKeys.has(a.doc.key),i._snapshot.fromCache),i.query.converter);return a.doc,{type:"added",doc:u,oldIndex:-1,newIndex:o++}})}{let o=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(a=>s||a.type!==3).map(a=>{let u=new Ae(i._firestore,i._userDataWriter,a.doc.key,a.doc,new ae(i._snapshot.mutatedKeys.has(a.doc.key),i._snapshot.fromCache),i.query.converter),c=-1,l=-1;return a.type!==0&&(c=o.indexOf(a.doc.key),o=o.delete(a.doc.key)),a.type!==1&&(o=o.add(a.doc),l=o.indexOf(a.doc.key)),{type:Fy(a.type),doc:u,oldIndex:c,newIndex:l}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}};function Fy(n){switch(n){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return S()}}function il(n,t){return n instanceof Mt&&t instanceof Mt?n._firestore===t._firestore&&n._key.isEqual(t._key)&&(n._document===null?t._document===null:n._document.isEqual(t._document))&&n._converter===t._converter:n instanceof Gt&&t instanceof Gt&&n._firestore===t._firestore&&Zc(n.query,t.query)&&n.metadata.isEqual(t.metadata)&&n._snapshot.isEqual(t._snapshot)}function Eg(n){n=O(n,z);let t=O(n.firestore,Q);return Um(ct(t),n._key).then(e=>ul(t,n,e))}var fe=class extends Zn{constructor(t){super(),this.firestore=t}convertBytes(t){return new ne(t)}convertReference(t){let e=this.convertDocumentKey(t,this.firestore._databaseId);return new z(this.firestore,null,e)}};function Tg(n){n=O(n,z);let t=O(n.firestore,Q),e=ct(t),r=new fe(t);return Cy(e,n._key).then(i=>new Mt(t,r,n._key,i,new ae(i!==null&&i.hasLocalMutations,!0),n.converter))}function Ag(n){n=O(n,z);let t=O(n.firestore,Q);return Um(ct(t),n._key,{source:"server"}).then(e=>ul(t,n,e))}function Sg(n){n=O(n,pt);let t=O(n.firestore,Q),e=ct(t),r=new fe(t);return hg(n._query),Gm(e,n._query).then(i=>new Gt(t,r,n,i))}function Rg(n){n=O(n,pt);let t=O(n.firestore,Q),e=ct(t),r=new fe(t);return by(e,n._query).then(i=>new Gt(t,r,n,i))}function Pg(n){n=O(n,pt);let t=O(n.firestore,Q),e=ct(t),r=new fe(t);return Gm(e,n._query,{source:"server"}).then(i=>new Gt(t,r,n,i))}function sl(n,t,e){n=O(n,z);let r=O(n.firestore,Q),i=_o(n.converter,t,e);return or(r,[go(cn(r),"setDoc",n._key,i,n.converter!==null,e).toMutation(n._key,Z.none())])}function ol(n,t,e,...r){n=O(n,z);let i=O(n.firestore,Q),s=cn(i),o;return o=typeof(t=Y(t))=="string"||t instanceof Ut?el(s,"updateDoc",n._key,t,e,r):tl(s,"updateDoc",n._key,t),or(i,[o.toMutation(n._key,Z.exists(!0))])}function Cg(n){return or(O(n.firestore,Q),[new De(n._key,Z.none())])}function bg(n,t){let e=O(n.firestore,Q),r=Ii(n),i=_o(n.converter,t);return or(e,[go(cn(n.firestore),"addDoc",r._key,i,n.converter!==null,{}).toMutation(r._key,Z.exists(!1))]).then(()=>r)}function al(n,...t){var e,r,i;n=Y(n);let s={includeMetadataChanges:!1,source:"default"},o=0;typeof t[o]!="object"||lc(t[o])||(s=t[o],o++);let a={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(lc(t[o])){let h=t[o];t[o]=(e=h.next)===null||e===void 0?void 0:e.bind(h),t[o+1]=(r=h.error)===null||r===void 0?void 0:r.bind(h),t[o+2]=(i=h.complete)===null||i===void 0?void 0:i.bind(h)}let u,c,l;if(n instanceof z)c=O(n.firestore,Q),l=er(n._key.path),u={next:h=>{t[o]&&t[o](ul(c,n,h))},error:t[o+1],complete:t[o+2]};else{let h=O(n,pt);c=O(h.firestore,Q),l=h._query;let d=new fe(c);u={next:m=>{t[o]&&t[o](new Gt(c,d,h,m))},error:t[o+1],complete:t[o+2]},hg(n._query)}return function(d,m,A,w){let v=new Jn(w),C=new li(m,v,A);return d.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return Lc(yield Xn(d),C)})),()=>{v.Qa(),d.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return qc(yield Xn(d),C)}))}}(ct(c),l,a,u)}function xg(n,t){return xy(ct(n=O(n,Q)),lc(t)?t:{next:t})}function or(n,t){return function(r,i){let s=new at;return r.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return cy(yield Wc(r),i,s)})),s.promise}(ct(n),t)}function ul(n,t,e){let r=e.docs.get(t._key),i=new fe(n);return new Mt(n,i,t._key,r,new ae(e.hasPendingWrites,e.fromCache),t.converter)}var My={maxAttempts:5};var uo=class{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=cn(t)}set(t,e,r){this._verifyNotCommitted();let i=Ee(t,this._firestore),s=_o(i.converter,e,r),o=go(this._dataReader,"WriteBatch.set",i._key,s,i.converter!==null,r);return this._mutations.push(o.toMutation(i._key,Z.none())),this}update(t,e,r,...i){this._verifyNotCommitted();let s=Ee(t,this._firestore),o;return o=typeof(e=Y(e))=="string"||e instanceof Ut?el(this._dataReader,"WriteBatch.update",s._key,e,r,i):tl(this._dataReader,"WriteBatch.update",s._key,e),this._mutations.push(o.toMutation(s._key,Z.exists(!0))),this}delete(t){this._verifyNotCommitted();let e=Ee(t,this._firestore);return this._mutations=this._mutations.concat(new De(e._key,Z.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new _(g.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}};function Ee(n,t){if((n=Y(n)).firestore!==t)throw new _(g.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return n}var Tc=class extends class{constructor(e,r){this._firestore=e,this._transaction=r,this._dataReader=cn(e)}get(e){let r=Ee(e,this._firestore),i=new Ec(this._firestore);return this._transaction.lookup([r._key]).then(s=>{if(!s||s.length!==1)return S();let o=s[0];if(o.isFoundDocument())return new on(this._firestore,i,o.key,o,r.converter);if(o.isNoDocument())return new on(this._firestore,i,r._key,null,r.converter);throw S()})}set(e,r,i){let s=Ee(e,this._firestore),o=_o(s.converter,r,i),a=go(this._dataReader,"Transaction.set",s._key,o,s.converter!==null,i);return this._transaction.set(s._key,a),this}update(e,r,i,...s){let o=Ee(e,this._firestore),a;return a=typeof(r=Y(r))=="string"||r instanceof Ut?el(this._dataReader,"Transaction.update",o._key,r,i,s):tl(this._dataReader,"Transaction.update",o._key,r),this._transaction.update(o._key,a),this}delete(e){let r=Ee(e,this._firestore);return this._transaction.delete(r._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){let e=Ee(t,this._firestore),r=new fe(this._firestore);return super.get(t).then(i=>new Mt(this._firestore,r,e._key,i._document,new ae(!1,!1),e.converter))}};function Vg(n,t,e){n=O(n,Q);let r=Object.assign(Object.assign({},My),e);return function(s){if(s.maxAttempts<1)throw new _(g.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(s,o,a){let u=new at;return s.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){let c=yield Sy(s);new oc(s.asyncQueue,c,a,o,u).Ya()})),u.promise}(ct(n),i=>t(new Tc(n,i)),r)}function Dg(){return new fi("deleteField")}function Ng(){return new mc("serverTimestamp")}function kg(...n){return new gc("arrayUnion",n)}function Fg(...n){return new pc("arrayRemove",n)}function Mg(n){return new _c("increment",n)}(function(t,e=!0){(function(i){tr=i})(Dl),Vl(new Ri("firestore",(r,{instanceIdentifier:i,options:s})=>{let o=r.getProvider("app").getImmediate(),a=new Q(new Ca(r.getProvider("auth-internal")),new Da(r.getProvider("app-check-internal")),function(c,l){if(!Object.prototype.hasOwnProperty.apply(c.options,["projectId"]))throw new _(g.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Pe(c.options.projectId,l)}(o,i),o);return s=Object.assign({useFetchStreams:e},s),a._setSettings(s),a},"PUBLIC").setMultipleInstances(!0)),xo(md,"4.6.0",t),xo(md,"4.6.0","esm2017")})();var Oy="@firebase/firestore-compat",Ly="0.3.29";function ml(n,t){if(t===void 0)return{merge:!1};if(t.mergeFields!==void 0&&t.merge!==void 0)throw new _("invalid-argument",`Invalid options passed to function ${n}(): You cannot specify both "merge" and "mergeFields".`);return t}function Og(){if(typeof Uint8Array>"u")throw new _("unimplemented","Uint8Arrays are not available in this environment.")}function Lg(){if(!Cf())throw new _("unimplemented","Blobs are unavailable in Firestore in this environment.")}var yo=class n{constructor(t){this._delegate=t}static fromBase64String(t){return Lg(),new n(ne.fromBase64String(t))}static fromUint8Array(t){return Og(),new n(ne.fromUint8Array(t))}toBase64(){return Lg(),this._delegate.toBase64()}toUint8Array(){return Og(),this._delegate.toUint8Array()}isEqual(t){return this._delegate.isEqual(t._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}};function cl(n){return qy(n,["next","error","complete"])}function qy(n,t){if(typeof n!="object"||n===null)return!1;let e=n;for(let r of t)if(r in e&&typeof e[r]=="function")return!0;return!1}var ll=class{enableIndexedDbPersistence(t,e){return Hm(t._delegate,{forceOwnership:e})}enableMultiTabIndexedDbPersistence(t){return Ym(t._delegate)}clearIndexedDbPersistence(t){return Xm(t._delegate)}},wo=class{constructor(t,e,r){this._delegate=e,this._persistenceProvider=r,this.INTERNAL={delete:()=>this.terminate()},t instanceof Pe||(this._appCompat=t)}get _databaseId(){return this._delegate._databaseId}settings(t){let e=this._delegate._getSettings();!t.merge&&e.host!==t.host&&kt("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),t.merge&&(t=Object.assign(Object.assign({},e),t),delete t.merge),this._delegate._setSettings(t)}useEmulator(t,e,r={}){Km(this._delegate,t,e,r)}enableNetwork(){return tg(this._delegate)}disableNetwork(){return eg(this._delegate)}enablePersistence(t){let e=!1,r=!1;return t&&(e=!!t.synchronizeTabs,r=!!t.experimentalForceOwningTab,Yc("synchronizeTabs",e,"experimentalForceOwningTab",r)),e?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,r)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return Zm(this._delegate)}onSnapshotsInSync(t){return xg(this._delegate,t)}get app(){if(!this._appCompat)throw new _("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(t){try{return new cr(this,Jc(this._delegate,t))}catch(e){throw St(e,"collection()","Firestore.collection()")}}doc(t){try{return new re(this,Ii(this._delegate,t))}catch(e){throw St(e,"doc()","Firestore.doc()")}}collectionGroup(t){try{return new mn(this,$m(this._delegate,t))}catch(e){throw St(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){return Vg(this._delegate,e=>t(new vo(this,e)))}batch(){return ct(this._delegate),new Io(new uo(this._delegate,t=>or(this._delegate,t)))}loadBundle(t){return ng(this._delegate,t)}namedQuery(t){return rg(this._delegate,t).then(e=>e?new mn(this,e):null)}},ar=class extends Zn{constructor(t){super(),this.firestore=t}convertBytes(t){return new yo(new ne(t))}convertReference(t){let e=this.convertDocumentKey(t,this.firestore._databaseId);return re.forKey(e,this.firestore,null)}};function By(n){gf(n)}var vo=class{constructor(t,e){this._firestore=t,this._delegate=e,this._userDataWriter=new ar(t)}get(t){let e=hn(t);return this._delegate.get(e).then(r=>new dn(this._firestore,new Mt(this._firestore._delegate,this._userDataWriter,r._key,r._document,r.metadata,e.converter)))}set(t,e,r){let i=hn(t);return r?(ml("Transaction.set",r),this._delegate.set(i,e,r)):this._delegate.set(i,e),this}update(t,e,r,...i){let s=hn(t);return arguments.length===2?this._delegate.update(s,e):this._delegate.update(s,e,r,...i),this}delete(t){let e=hn(t);return this._delegate.delete(e),this}},Io=class{constructor(t){this._delegate=t}set(t,e,r){let i=hn(t);return r?(ml("WriteBatch.set",r),this._delegate.set(i,e,r)):this._delegate.set(i,e),this}update(t,e,r,...i){let s=hn(t);return arguments.length===2?this._delegate.update(s,e):this._delegate.update(s,e,r,...i),this}delete(t){let e=hn(t);return this._delegate.delete(e),this}commit(){return this._delegate.commit()}},ur=class n{constructor(t,e,r){this._firestore=t,this._userDataWriter=e,this._delegate=r}fromFirestore(t,e){let r=new Ae(this._firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,null);return this._delegate.fromFirestore(new fn(this._firestore,r),e??{})}toFirestore(t,e){return e?this._delegate.toFirestore(t,e):this._delegate.toFirestore(t)}static getInstance(t,e){let r=n.INSTANCES,i=r.get(t);i||(i=new WeakMap,r.set(t,i));let s=i.get(e);return s||(s=new n(t,new ar(t),e),i.set(e,s)),s}};ur.INSTANCES=new WeakMap;var re=class n{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new ar(t)}static forPath(t,e,r){if(t.length%2!==0)throw new _("invalid-argument",`Invalid document reference. Document references must have an even number of segments, but ${t.canonicalString()} has ${t.length}`);return new n(e,new z(e._delegate,r,new I(t)))}static forKey(t,e,r){return new n(e,new z(e._delegate,r,t))}get id(){return this._delegate.id}get parent(){return new cr(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(t){try{return new cr(this.firestore,Jc(this._delegate,t))}catch(e){throw St(e,"collection()","DocumentReference.collection()")}}isEqual(t){return t=Y(t),t instanceof z?Xc(this._delegate,t):!1}set(t,e){e=ml("DocumentReference.set",e);try{return e?sl(this._delegate,t,e):sl(this._delegate,t)}catch(r){throw St(r,"setDoc()","DocumentReference.set()")}}update(t,e,...r){try{return arguments.length===1?ol(this._delegate,t):ol(this._delegate,t,e,...r)}catch(i){throw St(i,"updateDoc()","DocumentReference.update()")}}delete(){return Cg(this._delegate)}onSnapshot(...t){let e=qg(t),r=Bg(t,i=>new dn(this.firestore,new Mt(this.firestore._delegate,this._userDataWriter,i._key,i._document,i.metadata,this._delegate.converter)));return al(this._delegate,e,r)}get(t){let e;return t?.source==="cache"?e=Tg(this._delegate):t?.source==="server"?e=Ag(this._delegate):e=Eg(this._delegate),e.then(r=>new dn(this.firestore,new Mt(this.firestore._delegate,this._userDataWriter,r._key,r._document,r.metadata,this._delegate.converter)))}withConverter(t){return new n(this.firestore,t?this._delegate.withConverter(ur.getInstance(this.firestore,t)):this._delegate.withConverter(null))}};function St(n,t,e){return n.message=n.message.replace(t,e),n}function qg(n){for(let t of n)if(typeof t=="object"&&!cl(t))return t;return{}}function Bg(n,t){var e,r;let i;return cl(n[0])?i=n[0]:cl(n[1])?i=n[1]:typeof n[0]=="function"?i={next:n[0],error:n[1],complete:n[2]}:i={next:n[1],error:n[2],complete:n[3]},{next:s=>{i.next&&i.next(t(s))},error:(e=i.error)===null||e===void 0?void 0:e.bind(i),complete:(r=i.complete)===null||r===void 0?void 0:r.bind(i)}}var dn=class{constructor(t,e){this._firestore=t,this._delegate=e}get ref(){return new re(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(t){return this._delegate.data(t)}get(t,e){return this._delegate.get(t,e)}isEqual(t){return il(this._delegate,t._delegate)}},fn=class extends dn{data(t){let e=this._delegate.data(t);return this._delegate._converter||pf(e!==void 0,"Document in a QueryDocumentSnapshot should exist"),e}},mn=class n{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new ar(t)}where(t,e,r){try{return new n(this.firestore,ge(this._delegate,dg(t,e,r)))}catch(i){throw St(i,/(orderBy|where)\(\)/,"Query.$1()")}}orderBy(t,e){try{return new n(this.firestore,ge(this._delegate,fg(t,e)))}catch(r){throw St(r,/(orderBy|where)\(\)/,"Query.$1()")}}limit(t){try{return new n(this.firestore,ge(this._delegate,mg(t)))}catch(e){throw St(e,"limit()","Query.limit()")}}limitToLast(t){try{return new n(this.firestore,ge(this._delegate,gg(t)))}catch(e){throw St(e,"limitToLast()","Query.limitToLast()")}}startAt(...t){try{return new n(this.firestore,ge(this._delegate,pg(...t)))}catch(e){throw St(e,"startAt()","Query.startAt()")}}startAfter(...t){try{return new n(this.firestore,ge(this._delegate,_g(...t)))}catch(e){throw St(e,"startAfter()","Query.startAfter()")}}endBefore(...t){try{return new n(this.firestore,ge(this._delegate,yg(...t)))}catch(e){throw St(e,"endBefore()","Query.endBefore()")}}endAt(...t){try{return new n(this.firestore,ge(this._delegate,wg(...t)))}catch(e){throw St(e,"endAt()","Query.endAt()")}}isEqual(t){return Zc(this._delegate,t._delegate)}get(t){let e;return t?.source==="cache"?e=Rg(this._delegate):t?.source==="server"?e=Pg(this._delegate):e=Sg(this._delegate),e.then(r=>new Ei(this.firestore,new Gt(this.firestore._delegate,this._userDataWriter,this._delegate,r._snapshot)))}onSnapshot(...t){let e=qg(t),r=Bg(t,i=>new Ei(this.firestore,new Gt(this.firestore._delegate,this._userDataWriter,this._delegate,i._snapshot)));return al(this._delegate,e,r)}withConverter(t){return new n(this.firestore,t?this._delegate.withConverter(ur.getInstance(this.firestore,t)):this._delegate.withConverter(null))}},hl=class{constructor(t,e){this._firestore=t,this._delegate=e}get type(){return this._delegate.type}get doc(){return new fn(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}},Ei=class{constructor(t,e){this._firestore=t,this._delegate=e}get query(){return new mn(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(t=>new fn(this._firestore,t))}docChanges(t){return this._delegate.docChanges(t).map(e=>new hl(this._firestore,e))}forEach(t,e){this._delegate.forEach(r=>{t.call(e,new fn(this._firestore,r))})}isEqual(t){return il(this._delegate,t._delegate)}},cr=class n extends mn{constructor(t,e){super(t,e),this.firestore=t,this._delegate=e}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){let t=this._delegate.parent;return t?new re(this.firestore,t):null}doc(t){try{return t===void 0?new re(this.firestore,Ii(this._delegate)):new re(this.firestore,Ii(this._delegate,t))}catch(e){throw St(e,"doc()","CollectionReference.doc()")}}add(t){return bg(this._delegate,t).then(e=>new re(this.firestore,e))}isEqual(t){return Xc(this._delegate,t._delegate)}withConverter(t){return new n(this.firestore,t?this._delegate.withConverter(ur.getInstance(this.firestore,t)):this._delegate.withConverter(null))}};function hn(n){return O(n,z)}var dl=class n{constructor(...t){this._delegate=new Ut(...t)}static documentId(){return new n(et.keyField().canonicalString())}isEqual(t){return t=Y(t),t instanceof Ut?this._delegate._internalPath.isEqual(t._internalPath):!1}};var fl=class n{constructor(t){this._delegate=t}static serverTimestamp(){let t=Ng();return t._methodName="FieldValue.serverTimestamp",new n(t)}static delete(){let t=Dg();return t._methodName="FieldValue.delete",new n(t)}static arrayUnion(...t){let e=kg(...t);return e._methodName="FieldValue.arrayUnion",new n(e)}static arrayRemove(...t){let e=Fg(...t);return e._methodName="FieldValue.arrayRemove",new n(e)}static increment(t){let e=Mg(t);return e._methodName="FieldValue.increment",new n(e)}isEqual(t){return this._delegate.isEqual(t._delegate)}};var Uy={Firestore:wo,GeoPoint:sn,Timestamp:W,Blob:yo,Transaction:vo,WriteBatch:Io,DocumentReference:re,DocumentSnapshot:dn,Query:mn,QueryDocumentSnapshot:fn,QuerySnapshot:Ei,CollectionReference:cr,FieldPath:dl,FieldValue:fl,setLogLevel:By,CACHE_SIZE_UNLIMITED:Qm};function Gy(n,t){n.INTERNAL.registerComponent(new Ri("firestore-compat",e=>{let r=e.getProvider("app-compat").getImmediate(),i=e.getProvider("firestore").getImmediate();return t(r,i)},"PUBLIC").setServiceProps(Object.assign({},Uy)))}function jy(n){Gy(n,(t,e)=>new wo(t,e,new ll)),n.registerVersion(Oy,Ly)}jy(Vo);function zy(n,t=Il){return new wl(e=>{let r;return t!=null?t.schedule(()=>{r=n.onSnapshot({includeMetadataChanges:!0},e)}):r=n.onSnapshot({includeMetadataChanges:!0},e),()=>{r?.()}})}function Ug(n,t){return zy(n,t)}function Ky(n,t){return Ug(n,t).pipe(Si(void 0),Ti(),_t(e=>{let[r,i]=e;return i.exists?r?.exists?{payload:i,type:"modified"}:{payload:i,type:"added"}:{payload:i,type:"removed"}}))}function _l(n,t){return Ug(n,t).pipe(_t(e=>({payload:e,type:"query"})))}var Eo=class{ref;afs;constructor(t,e){this.ref=t,this.afs=e}set(t,e){return this.ref.set(t,e)}update(t){return this.ref.update(t)}delete(){return this.ref.delete()}collection(t,e){let r=this.ref.collection(t),{ref:i,query:s}=zg(r,e);return new Ao(i,s,this.afs)}snapshotChanges(){return Ky(this.ref,this.afs.schedulers.outsideAngular).pipe(Vt)}valueChanges(t={}){return this.snapshotChanges().pipe(_t(({payload:e})=>t.idField?lr(gn({},e.data()),{[t.idField]:e.id}):e.data()))}get(t){return xt(this.ref.get(t)).pipe(Vt)}};function To(n,t){return _l(n,t).pipe(Si(void 0),Ti(),_t(e=>{let[r,i]=e,s=i.payload.docChanges(),o=s.map(a=>({type:a.type,payload:a}));return r&&JSON.stringify(r.payload.metadata)!==JSON.stringify(i.payload.metadata)&&i.payload.docs.forEach((a,u)=>{let c=s.find(h=>h.doc.ref.isEqual(a.ref)),l=r?.payload.docs.find(h=>h.ref.isEqual(a.ref));c&&JSON.stringify(c.doc.metadata)===JSON.stringify(a.metadata)||!c&&l&&JSON.stringify(l.metadata)===JSON.stringify(a.metadata)||o.push({type:"modified",payload:{oldIndex:u,newIndex:u,type:"modified",doc:a}})}),o}))}function Gg(n,t,e){return To(n,e).pipe(Ai((r,i)=>$y(r,i.map(s=>s.payload),t),[]),El(),_t(r=>r.map(i=>({type:i.type,payload:i}))))}function $y(n,t,e){return t.forEach(r=>{e.indexOf(r.type)>-1&&(n=Qy(n,r))}),n}function gl(n,t,e,...r){let i=n.slice();return i.splice(t,e,...r),i}function Qy(n,t){switch(t.type){case"added":if(!(n[t.newIndex]&&n[t.newIndex].doc.ref.isEqual(t.doc.ref)))return gl(n,t.newIndex,0,t);break;case"modified":if(n[t.oldIndex]==null||n[t.oldIndex].doc.ref.isEqual(t.doc.ref))if(t.oldIndex!==t.newIndex){let e=n.slice();return e.splice(t.oldIndex,1),e.splice(t.newIndex,0,t),e}else return gl(n,t.newIndex,1,t);break;case"removed":if(n[t.oldIndex]&&n[t.oldIndex].doc.ref.isEqual(t.doc.ref))return gl(n,t.oldIndex,1);break}return n}function jg(n){return(!n||n.length===0)&&(n=["added","removed","modified"]),n}var Ao=class{ref;query;afs;constructor(t,e,r){this.ref=t,this.query=e,this.afs=r}stateChanges(t){let e=To(this.query,this.afs.schedulers.outsideAngular);return t&&t.length>0&&(e=e.pipe(_t(r=>r.filter(i=>t.indexOf(i.type)>-1)))),e.pipe(Si(void 0),Ti(),Ro(([r,i])=>i.length>0||!r),_t(([,r])=>r),Vt)}auditTrail(t){return this.stateChanges(t).pipe(Ai((e,r)=>[...e,...r],[]))}snapshotChanges(t){let e=jg(t);return Gg(this.query,e,this.afs.schedulers.outsideAngular).pipe(Vt)}valueChanges(t={}){return _l(this.query,this.afs.schedulers.outsideAngular).pipe(_t(e=>e.payload.docs.map(r=>t.idField?lr(gn({},r.data()),{[t.idField]:r.id}):r.data())),Vt)}get(t){return xt(this.query.get(t)).pipe(Vt)}add(t){return this.ref.add(t)}doc(t){return new Eo(this.ref.doc(t),this.afs)}},pl=class{query;afs;constructor(t,e){this.query=t,this.afs=e}stateChanges(t){return!t||t.length===0?To(this.query,this.afs.schedulers.outsideAngular).pipe(Vt):To(this.query,this.afs.schedulers.outsideAngular).pipe(_t(e=>e.filter(r=>t.indexOf(r.type)>-1)),Ro(e=>e.length>0),Vt)}auditTrail(t){return this.stateChanges(t).pipe(Ai((e,r)=>[...e,...r],[]))}snapshotChanges(t){let e=jg(t);return Gg(this.query,e,this.afs.schedulers.outsideAngular).pipe(Vt)}valueChanges(t={}){return _l(this.query,this.afs.schedulers.outsideAngular).pipe(_t(r=>r.payload.docs.map(i=>t.idField?gn({[t.idField]:i.id},i.data()):i.data())),Vt)}get(t){return xt(this.query.get(t)).pipe(Vt)}},Wy=new hr("angularfire2.enableFirestorePersistence"),Hy=new hr("angularfire2.firestore.persistenceSettings"),Yy=new hr("angularfire2.firestore.settings"),Jy=new hr("angularfire2.firestore.use-emulator");function zg(n,t=e=>e){return{query:t(n),ref:n}}var Kg=(()=>{class n{schedulers;firestore;persistenceEnabled$;constructor(e,r,i,s,o,a,u,c,l,h,d,m,A,w,v,C,N){this.schedulers=u;let b=Ol(e,a,r),q=l;h&&Kl(b,a,d,A,w,v,m,C),[this.firestore,this.persistenceEnabled$]=Ll(`${b.name}.firestore`,"AngularFirestore",b.name,()=>{let B=a.runOutsideAngular(()=>b.firestore());if(s&&B.settings(s),q&&B.useEmulator(...q),i&&!Rl(o)){let L=()=>{try{return xt(B.enablePersistence(c||void 0).then(()=>!0,()=>!1))}catch(rt){return typeof console<"u"&&console.warn(rt),pn(!1)}};return[B,a.runOutsideAngular(L)]}else return[B,pn(!1)]},[s,q,i])}collection(e,r){let i;typeof e=="string"?i=this.firestore.collection(e):i=e;let{ref:s,query:o}=zg(i,r),a=this.schedulers.ngZone.run(()=>s);return new Ao(a,o,this)}collectionGroup(e,r){let i=r||(o=>o),s=this.firestore.collectionGroup(e);return new pl(i(s),this)}doc(e){let r;typeof e=="string"?r=this.firestore.doc(e):r=e;let i=this.schedulers.ngZone.run(()=>r);return new Eo(i,this)}createId(){return this.firestore.collection("_").doc().id}static \u0275fac=function(r){return new(r||n)(H(Fl),H(Ml,8),H(Wy,8),H(Yy,8),H(Al),H(Sl),H(kl),H(Hy,8),H(Jy,8),H(Pi,8),H(ql,8),H(Bl,8),H(Ul,8),H(Gl,8),H(jl,8),H(zl,8),H(Nl,8))};static \u0275prov=_n({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})();var Yw=(()=>{let t=class t{constructor(r){this.firestore=r}setCollection(r){this.collection=this.firestore.collection(r)}getDocuments(){if(!this.collection)throw new Error("Collection path not set.");return this.collection.snapshotChanges().pipe(_t(r=>r.map(i=>{let s=i.payload.doc.data(),o=i.payload.doc.id;return lr(gn({},s),{id:o})})),pe(r=>{throw console.error("Error obtaining data from Firestore:",r),r}))}addDocument(r){return xt(this.collection.add(r)).pipe(Po(i=>this.collection.doc(i.id).valueChanges()))}updateDocument(r,i){return xt(this.collection.doc(r).update(i)).pipe(pe(s=>{throw console.error("Error updating document in Firestore:",s),s}))}deleteDocument(r){return xt(this.collection.doc(r).delete()).pipe(pe(i=>{throw console.error("Error deleting document from Firestore:",i),i}))}getDocumentById(r){return this.collection.doc(r).get().pipe(Po(i=>{if(i.exists){let s=i.data();return pn(s)}else return console.error("Document with provided ID does not exist:",r),pn(void 0)}),pe(i=>{throw console.error("Error getting document by ID:",i),i}))}};t.\u0275fac=function(i){return new(i||t)(H(Kg))},t.\u0275prov=_n({token:t,factory:t.\u0275fac,providedIn:"root"});let n=t;return n})();export{ew as a,Kg as b,Yw as c};
